<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"xdk-nj.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="MySQL整理">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL整理">
<meta property="og:url" content="https://xdk-nj.github.io/2021/01/24/MySQL%E6%95%B4%E7%90%86/index.html">
<meta property="og:site_name" content="打醒月亮">
<meta property="og:description" content="MySQL整理">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://xdk-nj.github.io/2021/01/24/MySQL%E6%95%B4%E7%90%86/1.png">
<meta property="og:image" content="https://xdk-nj.github.io/2021/01/24/MySQL%E6%95%B4%E7%90%86/2.png">
<meta property="og:image" content="https://xdk-nj.github.io/2021/01/24/MySQL%E6%95%B4%E7%90%86/3.png">
<meta property="og:image" content="https://xdk-nj.github.io/2021/01/24/MySQL%E6%95%B4%E7%90%86/4.png">
<meta property="og:image" content="https://xdk-nj.github.io/2021/01/24/MySQL%E6%95%B4%E7%90%86/5.png">
<meta property="og:image" content="https://xdk-nj.github.io/2021/01/24/MySQL%E6%95%B4%E7%90%86/6.png">
<meta property="og:image" content="https://xdk-nj.github.io/2021/01/24/MySQL%E6%95%B4%E7%90%86/7.png">
<meta property="og:image" content="https://xdk-nj.github.io/2021/01/24/MySQL%E6%95%B4%E7%90%86/8.png">
<meta property="og:image" content="https://xdk-nj.github.io/2021/01/24/MySQL%E6%95%B4%E7%90%86/12.png">
<meta property="og:image" content="https://xdk-nj.github.io/2021/01/24/MySQL%E6%95%B4%E7%90%86/14.png">
<meta property="og:image" content="https://xdk-nj.github.io/2021/01/24/MySQL%E6%95%B4%E7%90%86/15.png">
<meta property="og:image" content="https://xdk-nj.github.io/2021/01/24/MySQL%E6%95%B4%E7%90%86/16.png">
<meta property="og:image" content="https://xdk-nj.github.io/2021/01/24/MySQL%E6%95%B4%E7%90%86/18.png">
<meta property="og:image" content="https://xdk-nj.github.io/2021/01/24/MySQL%E6%95%B4%E7%90%86/19.png">
<meta property="og:image" content="https://xdk-nj.github.io/2021/01/24/MySQL%E6%95%B4%E7%90%86/21.png">
<meta property="og:image" content="https://xdk-nj.github.io/2021/01/24/MySQL%E6%95%B4%E7%90%86/22.png">
<meta property="og:image" content="https://xdk-nj.github.io/2021/01/24/MySQL%E6%95%B4%E7%90%86/23.png">
<meta property="og:image" content="https://xdk-nj.github.io/2021/01/24/MySQL%E6%95%B4%E7%90%86/24.png">
<meta property="og:image" content="https://xdk-nj.github.io/2021/01/24/MySQL%E6%95%B4%E7%90%86/25.png">
<meta property="og:image" content="https://xdk-nj.github.io/2021/01/24/MySQL%E6%95%B4%E7%90%86/26.png">
<meta property="og:image" content="https://xdk-nj.github.io/2021/01/24/MySQL%E6%95%B4%E7%90%86/27.png">
<meta property="og:image" content="https://xdk-nj.github.io/2021/01/24/MySQL%E6%95%B4%E7%90%86/28.png">
<meta property="og:image" content="https://xdk-nj.github.io/2021/01/24/MySQL%E6%95%B4%E7%90%86/29.png">
<meta property="og:image" content="https://xdk-nj.github.io/2021/01/24/MySQL%E6%95%B4%E7%90%86/30.png">
<meta property="og:image" content="https://xdk-nj.github.io/2021/01/24/MySQL%E6%95%B4%E7%90%86/31.png">
<meta property="og:image" content="https://xdk-nj.github.io/2021/01/24/MySQL%E6%95%B4%E7%90%86/32.png">
<meta property="og:image" content="https://xdk-nj.github.io/2021/01/24/MySQL%E6%95%B4%E7%90%86/33.png">
<meta property="og:image" content="https://xdk-nj.github.io/2021/01/24/MySQL%E6%95%B4%E7%90%86/34.png">
<meta property="og:image" content="https://xdk-nj.github.io/2021/01/24/MySQL%E6%95%B4%E7%90%86/35.png">
<meta property="og:image" content="https://xdk-nj.github.io/2021/01/24/MySQL%E6%95%B4%E7%90%86/36.png">
<meta property="og:image" content="https://xdk-nj.github.io/2021/01/24/MySQL%E6%95%B4%E7%90%86/37.png">
<meta property="og:image" content="https://xdk-nj.github.io/2021/01/24/MySQL%E6%95%B4%E7%90%86/38.png">
<meta property="og:image" content="https://xdk-nj.github.io/2021/01/24/MySQL%E6%95%B4%E7%90%86/39.png">
<meta property="article:published_time" content="2021-01-24T01:16:04.000Z">
<meta property="article:modified_time" content="2021-01-25T04:03:00.554Z">
<meta property="article:author" content="xudukang">
<meta property="article:tag" content="MySQL">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://xdk-nj.github.io/2021/01/24/MySQL%E6%95%B4%E7%90%86/1.png">

<link rel="canonical" href="https://xdk-nj.github.io/2021/01/24/MySQL%E6%95%B4%E7%90%86/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>MySQL整理 | 打醒月亮</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="打醒月亮" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">打醒月亮</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://xdk-nj.github.io/2021/01/24/MySQL%E6%95%B4%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xudukang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="打醒月亮">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          MySQL整理
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-01-24 09:16:04" itemprop="dateCreated datePublished" datetime="2021-01-24T09:16:04+08:00">2021-01-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-01-25 12:03:00" itemprop="dateModified" datetime="2021-01-25T12:03:00+08:00">2021-01-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>82k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1:14</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="MySQL整理"><a href="#MySQL整理" class="headerlink" title="MySQL整理"></a>MySQL整理</h1><h2 id="第1篇：MySQL基础知识"><a href="#第1篇：MySQL基础知识" class="headerlink" title="第1篇：MySQL基础知识"></a>第1篇：MySQL基础知识</h2><h3 id="基本命令"><a href="#基本命令" class="headerlink" title="基本命令"></a>基本命令</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- mysql登录命令</span></span><br><span class="line">mysql <span class="operator">-</span>h ip <span class="operator">-</span>P 端口 <span class="operator">-</span>u 用户名 <span class="operator">-</span>p</span><br><span class="line"><span class="comment">-- 查看数据库版本, 用于在未登录情况下，查看mysql版本</span></span><br><span class="line">mysql <span class="operator">-</span>V </span><br><span class="line"><span class="comment">-- 登录情况下，查看版本</span></span><br><span class="line"><span class="keyword">select</span> version(); </span><br><span class="line"><span class="comment">-- 显示所有数据库</span></span><br><span class="line"><span class="keyword">show</span> databases;</span><br><span class="line"><span class="comment">-- 进入指定的库</span></span><br><span class="line">use 库名; </span><br><span class="line"><span class="comment">-- 显示当前库中所有的表</span></span><br><span class="line"><span class="keyword">show</span> tables;</span><br><span class="line"><span class="comment">-- 查看其他库中所有的表</span></span><br><span class="line"><span class="keyword">show</span> tables <span class="keyword">from</span> 库名;</span><br><span class="line"><span class="comment">-- 查看表的创建语句</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> 表名;</span><br><span class="line"><span class="comment">-- 查看表结构</span></span><br><span class="line"><span class="keyword">desc</span> 表名;</span><br><span class="line"><span class="comment">-- 查看当前所在库</span></span><br><span class="line"><span class="keyword">select</span> database();</span><br><span class="line"><span class="comment">-- 查看当前mysql支持的存储引擎</span></span><br><span class="line"><span class="keyword">SHOW</span> ENGINES;</span><br><span class="line"><span class="comment">-- 查看系统变量及其值</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES;</span><br><span class="line"><span class="comment">-- 查看某个系统变量</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">like</span> <span class="string">&#x27;变量名&#x27;</span>;</span><br></pre></td></tr></table></figure>
<h3 id="语法规范"><a href="#语法规范" class="headerlink" title="语法规范"></a>语法规范</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 不区分大小写，但建议关键字大写，表名、列名小写</span><br><span class="line"><span class="number">2.</span> 每条命令最好用英文分号结尾</span><br><span class="line"><span class="number">3.</span> 每条命令根据需要，可以进行缩进或换行</span><br><span class="line"><span class="number">4.</span> 注释   </span><br><span class="line">	 单行注释：#注释文字</span><br><span class="line">     单行注释：<span class="comment">-- 注释文字 ，注意， 这里需要加空格</span></span><br><span class="line">   	 多行注释：<span class="comment">/* 注释文字 */</span></span><br></pre></td></tr></table></figure>
<h3 id="SQL的语言分类"><a href="#SQL的语言分类" class="headerlink" title="SQL的语言分类"></a>SQL的语言分类</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DQL（Data Query Language）：数据查询语言 select 相关语句</span><br><span class="line">DML（Data Manipulate Language）：数据操作语言 insert 、update、delete 语句</span><br><span class="line">DDL（Data Define Languge）：数据定义语言 create、drop、alter 语句</span><br><span class="line">TCL（Transaction Control Language）：事务控制语言 set autocommit&#x3D;0、start transaction、savepoint、commit、rollback</span><br></pre></td></tr></table></figure>
<h3 id="数据库三范式"><a href="#数据库三范式" class="headerlink" title="数据库三范式"></a>数据库三范式</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- 1NF：字段不可分;</span><br><span class="line">- 2NF：有主键，非主键字段都完全依赖主键;</span><br><span class="line">例：A(仓库号， 设备号， 数量， 地点) </span><br><span class="line">关键字是（仓库号， 设备号） 存在部份依赖仓库号 --&gt; 地点</span><br><span class="line">分解： B(仓库号， 设备号， 数量)   B(仓库号，地点)</span><br><span class="line">- 3NF：非主键字段不能相互依赖;（消除非主属性对主属性的传递依赖）</span><br><span class="line">例：A(仓库号，所在省，所在城市)</span><br><span class="line">所在城市 --&gt; 所在省 --&gt; 仓库号</span><br><span class="line">分解： B(仓库号，所在城市)  B(省，城市)</span><br></pre></td></tr></table></figure>


<h2 id="第2篇：MySQL中数据类型"><a href="#第2篇：MySQL中数据类型" class="headerlink" title="第2篇：MySQL中数据类型"></a>第2篇：MySQL中数据类型</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">主要包括以下五大类</span><br><span class="line">- 整数类型： bit 、bool 、tinyint 、smallint 、mediumint 、int 、bigint</span><br><span class="line">- 浮点数类型： float 、double 、decimal</span><br><span class="line">- 字符串类型： char 、varchar 、tinyblob 、blob 、mediumblob 、longblob 、tinytext 、text 			、mediumtext 、longtext</span><br><span class="line">- 日期类型： Date 、DateTime 、TimeStamp 、Time 、Year</span><br><span class="line">- 其他数据类型：暂不介绍，用的比较少。</span><br></pre></td></tr></table></figure>

<h3 id="整数类型"><a href="#整数类型" class="headerlink" title="整数类型"></a>整数类型</h3><p><img src="/2021/01/24/MySQL%E6%95%B4%E7%90%86/1.png" alt="1"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">有些定义整型的写法是int(11)，这种写法个人感觉在开发过程中没有什么用途， int(N) 需要记住两点：</span></span><br><span class="line"><span class="comment">1. 无论N等于多少，int永远占4个字节</span></span><br><span class="line"><span class="comment">2. N表示显示宽度，不足的用0补足，超过的无视长度而直接显示整个数字，</span></span><br><span class="line"><span class="comment">但这要整型设置了unsigned zerofill才有效</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test3 ( </span><br><span class="line">  `a` <span class="type">int</span>, </span><br><span class="line">  `b` <span class="type">int</span>(<span class="number">5</span>), </span><br><span class="line">  `c` <span class="type">int</span>(<span class="number">5</span>) unsigned, </span><br><span class="line">  `d` <span class="type">int</span>(<span class="number">5</span>) zerofill, </span><br><span class="line">  `e` <span class="type">int</span>(<span class="number">5</span>) unsigned zerofill, </span><br><span class="line">  `f` <span class="type">int</span> zerofill, </span><br><span class="line">  `g` <span class="type">int</span> unsigned zerofill ); </span><br><span class="line">  Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec) </span><br><span class="line">  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> test3 <span class="keyword">values</span> (<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>),(<span class="number">11</span>,<span class="number">11</span>,<span class="number">11</span>,<span class="number">11</span>,<span class="number">11</span>,<span class="number">11</span>,<span class="number">11</span>), (<span class="number">12345</span>,<span class="number">12345</span>,<span class="number">12345</span>,<span class="number">12345</span>,<span class="number">12345</span>,<span class="number">12345</span>,<span class="number">12345</span>); </span><br><span class="line">Query OK, <span class="number">3</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec) Records: <span class="number">3</span> Duplicates: <span class="number">0</span> Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test3;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------+-------+-------+-------+------------+------------+</span></span><br><span class="line"><span class="operator">|</span> a     <span class="operator">|</span> b     <span class="operator">|</span> c     <span class="operator">|</span> d     <span class="operator">|</span> e     <span class="operator">|</span> f          <span class="operator">|</span> g          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------+-------+-------+-------+------------+------------+</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">1</span> <span class="operator">|</span>     <span class="number">1</span> <span class="operator">|</span>     <span class="number">1</span> <span class="operator">|</span> <span class="number">00001</span> <span class="operator">|</span> <span class="number">00001</span> <span class="operator">|</span> <span class="number">0000000001</span> <span class="operator">|</span> <span class="number">0000000001</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">11</span> <span class="operator">|</span>    <span class="number">11</span> <span class="operator">|</span>    <span class="number">11</span> <span class="operator">|</span> <span class="number">00011</span> <span class="operator">|</span> <span class="number">00011</span> <span class="operator">|</span> <span class="number">0000000011</span> <span class="operator">|</span> <span class="number">0000000011</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">12345</span> <span class="operator">|</span> <span class="number">12345</span> <span class="operator">|</span> <span class="number">12345</span> <span class="operator">|</span> <span class="number">12345</span> <span class="operator">|</span> <span class="number">12345</span> <span class="operator">|</span> <span class="number">0000012345</span> <span class="operator">|</span> <span class="number">0000012345</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------+-------+-------+-------+------------+------------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.05</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">说明：</span></span><br><span class="line"><span class="comment">int(5) 输出宽度不满5时，前面用0来进行填充</span></span><br><span class="line"><span class="comment">int(n) 中的n省略的时候，宽度为对应类型无符号最大值的十进制的长度，如bigint无符号最大值为</span></span><br><span class="line"><span class="comment">18446744073709551615 ；长度是20位。</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="浮点类型"><a href="#浮点类型" class="headerlink" title="浮点类型"></a>浮点类型</h3><p><img src="/2021/01/24/MySQL%E6%95%B4%E7%90%86/2.png" alt="2"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">float数值类型用于表示单精度浮点数值，而double数值类型用于表示双精度浮点数值，float和double都是浮点型，而decimal是定点型。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">浮点型和定点型可以用类型名称后加（M，D）来表示，M表示该值的总共长度，D表示小数点后面的长度，M和D又称为精度和标度。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">float和double在不指定精度时，默认会按照实际的精度显示，而DECIMAL在不指定精度时，默认整数为10，小数为0。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">mysql<span class="operator">&gt;</span>  <span class="keyword">create</span> <span class="keyword">table</span> test5(a <span class="type">float</span>(<span class="number">5</span>,<span class="number">2</span>),b <span class="keyword">double</span>(<span class="number">5</span>,<span class="number">2</span>),c <span class="type">decimal</span>(<span class="number">5</span>,<span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> test5 <span class="keyword">values</span> (<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>),(<span class="number">2.1</span>,<span class="number">2.1</span>,<span class="number">2.1</span>),(<span class="number">3.123</span>,<span class="number">3.123</span>,<span class="number">3.123</span>), (<span class="number">4.125</span>,<span class="number">4.125</span>,<span class="number">4.125</span>),(<span class="number">5.115</span>,<span class="number">5.115</span>,<span class="number">5.115</span>),(<span class="number">6.126</span>,<span class="number">6.126</span>,<span class="number">6.126</span>),(<span class="number">7.116</span>,<span class="number">7.116</span>,<span class="number">7.116</span>), (<span class="number">8.1151</span>,<span class="number">8.1151</span>,<span class="number">8.1151</span>),(<span class="number">9.1251</span>,<span class="number">9.1251</span>,<span class="number">9.1251</span>),(<span class="number">10.11501</span>,<span class="number">10.11501</span>,<span class="number">10.11501</span>), (<span class="number">11.12501</span>,<span class="number">11.12501</span>,<span class="number">11.12501</span>);</span><br><span class="line">Query OK, <span class="number">11</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line">Records: <span class="number">11</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">9</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test5;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------+-------+</span></span><br><span class="line"><span class="operator">|</span> a     <span class="operator">|</span> b     <span class="operator">|</span> c     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------+-------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1.00</span> <span class="operator">|</span>  <span class="number">1.00</span> <span class="operator">|</span> <span class="number">1.00</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2.10</span> <span class="operator">|</span>  <span class="number">2.10</span> <span class="operator">|</span> <span class="number">2.10</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3.12</span> <span class="operator">|</span>  <span class="number">3.12</span> <span class="operator">|</span> <span class="number">3.12</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">4.12</span> <span class="operator">|</span>  <span class="number">4.12</span> <span class="operator">|</span> <span class="number">4.13</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">5.12</span> <span class="operator">|</span>  <span class="number">5.12</span> <span class="operator">|</span> <span class="number">5.12</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">6.13</span> <span class="operator">|</span>  <span class="number">6.13</span> <span class="operator">|</span> <span class="number">6.13</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">7.12</span> <span class="operator">|</span>  <span class="number">7.12</span> <span class="operator">|</span> <span class="number">7.12</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">8.12</span> <span class="operator">|</span>  <span class="number">8.12</span> <span class="operator">|</span> <span class="number">8.12</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">9.13</span> <span class="operator">|</span>  <span class="number">9.13</span> <span class="operator">|</span> <span class="number">9.13</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">10.12</span> <span class="operator">|</span> <span class="number">10.12</span> <span class="operator">|</span> <span class="number">10.12</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">11.13</span> <span class="operator">|</span> <span class="number">11.13</span> <span class="operator">|</span> <span class="number">11.13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------+-------+</span></span><br><span class="line"><span class="number">11</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.07</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">- 结果说明（注意看）：</span></span><br><span class="line"><span class="comment">c是decimal类型，认真看一下输入和输出，发现decimal采用的是四舍五入。认真看一下 a 和 b 的输入和输出，不是四舍五入，float和double采用的是四舍六入五成双，decimal插入的数据超精度之后会触发警告。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- 什么是四舍六入五成双？</span></span><br><span class="line"><span class="comment">就是5以下舍弃,5以上进位，如果需要处理数字为5的时候，需要看5后面是否还有不为0的任何数字，如果有，则直接进位，如果没有，需要看5前面的数字，若是奇数则进位，若是偶数则将5舍掉。</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> test6(a <span class="type">float</span>,b <span class="keyword">double</span>,c <span class="type">decimal</span>);</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> test6 <span class="keyword">values</span> (<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>),(<span class="number">1.234</span>,<span class="number">1.234</span>,<span class="number">1.4</span>),(<span class="number">1.234</span>,<span class="number">0.01</span>,<span class="number">1.5</span>);</span><br><span class="line">Query OK, <span class="number">3</span> <span class="keyword">rows</span> affected (<span class="number">0.09</span> sec)</span><br><span class="line">Records: <span class="number">3</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">2</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test6;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------+---+</span></span><br><span class="line"><span class="operator">|</span> a     <span class="operator">|</span> b     <span class="operator">|</span> c <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------+---+</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">1</span> <span class="operator">|</span>     <span class="number">1</span> <span class="operator">|</span> <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1.234</span> <span class="operator">|</span> <span class="number">1.234</span> <span class="operator">|</span> <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1.234</span> <span class="operator">|</span>  <span class="number">0.01</span> <span class="operator">|</span> <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------+---+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.06</span> sec)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">- 说明：</span></span><br><span class="line"><span class="comment">a和b的数据正确插入，而c被截断了</span></span><br><span class="line"><span class="comment">浮点数float、double如果不写精度和标度，则会按照实际显示</span></span><br><span class="line"><span class="comment">decimal不写精度和标度，小数点后面的会进行四舍五入，并且插入时会有警告!</span></span><br><span class="line"><span class="comment">*</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">sum</span>(a),<span class="built_in">sum</span>(b),<span class="built_in">sum</span>(c) <span class="keyword">from</span> test5;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------+--------+--------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">sum</span>(a) <span class="operator">|</span> <span class="built_in">sum</span>(b) <span class="operator">|</span> <span class="built_in">sum</span>(c) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+--------+--------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">67.21</span> <span class="operator">|</span>  <span class="number">67.21</span> <span class="operator">|</span> <span class="number">67.22</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+--------+--------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.10</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">sum</span>(a),<span class="built_in">sum</span>(b),<span class="built_in">sum</span>(c) <span class="keyword">from</span> test6;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+--------------------+--------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">sum</span>(a)             <span class="operator">|</span> <span class="built_in">sum</span>(b)             <span class="operator">|</span> <span class="built_in">sum</span>(c) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+--------------------+--------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">3.4679999351501465</span> <span class="operator">|</span> <span class="number">2.2439999999999998</span> <span class="operator">|</span> <span class="number">4</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+--------------------+--------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.14</span> sec)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">从上面sum的结果可以看出 float 、 double 会存在精度问题， </span></span><br><span class="line"><span class="comment">decimal 精度正常的，比如银行对统计结果要求比较精准的建议使用 decimal 。</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<h3 id="日期类型"><a href="#日期类型" class="headerlink" title="日期类型"></a>日期类型</h3><p><img src="/2021/01/24/MySQL%E6%95%B4%E7%90%86/3.png" alt="3"></p>
<h3 id="字符串类型"><a href="#字符串类型" class="headerlink" title="字符串类型"></a>字符串类型<img src="/2021/01/24/MySQL%E6%95%B4%E7%90%86/4.png" alt="4"></h3><ul>
<li>char类型占用固定长度，如果存放的数据为固定长度的建议使用char类型，如手机号码</li>
<li>表格中的L表示存储的数据本身占用的字节，L 以外所需的额外字节为存放该值的长度所需的字节数。</li>
<li>MySQL 通过存储值的内容及其长度来处理可变长度的值，这些额外的字节是无符号整数。</li>
</ul>
<h3 id="MySQL类型和Java对应关系"><a href="#MySQL类型和Java对应关系" class="headerlink" title="MySQL类型和Java对应关系"></a>MySQL类型和Java对应关系<img src="/2021/01/24/MySQL%E6%95%B4%E7%90%86/5.png" alt="5"></h3><p><img src="/2021/01/24/MySQL%E6%95%B4%E7%90%86/6.png" alt="6"></p>
<p><img src="/2021/01/24/MySQL%E6%95%B4%E7%90%86/7.png" alt="7"></p>
<h3 id="数据类型选择的一些建议"><a href="#数据类型选择的一些建议" class="headerlink" title="数据类型选择的一些建议"></a>数据类型选择的一些建议</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 选小不选大：一般情况下选择可以正确存储数据的最小数据类型，越小的数据类型通常更快，占用磁盘，内存和CPU缓存更小。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 简单就好：简单的数据类型的操作通常需要更少的CPU周期，例如：整型比字符操作代价要小得多，因为字符集和校对规则(排序规则)使字符比整型比较更加复杂。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 尽量避免NULL：尽量制定列为NOT NULL，除非真的需要NULL类型的值，有NULL的列值会使得索引、索引统计和值比较更加复杂。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 浮点类型的建议统一选择decimal。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 记录时间的建议使用int或者bigint类型，将时间转换为时间戳格式，如将时间转换为秒、毫秒，进行存储，方便走索引。</span></span><br></pre></td></tr></table></figure>


<h2 id="第3篇：管理员常用命令"><a href="#第3篇：管理员常用命令" class="headerlink" title="第3篇：管理员常用命令"></a>第3篇：管理员常用命令</h2><h3 id="MySQL权限工作原理"><a href="#MySQL权限工作原理" class="headerlink" title="MySQL权限工作原理"></a>MySQL权限工作原理</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- mysql是如何来识别一个用户的呢？</span><br><span class="line">mysql为了安全性考虑，采用 主机名+用户名 来判断一个用户的身份，因为在互联网中很难通过用户名来判断一个用户的身份，但是我们可以通过ip或者主机名判断一台机器，某个用户通过这个机器过来的，我们可以识别为一个用户，所以mysql中采用用户名+主机名来识别用户的身份。当一个用户对mysql发送指令的时候，mysql就是通过用户名和主机来断定用户的权限。</span><br><span class="line"></span><br><span class="line">- Mysql权限验证分为2个阶段：</span><br><span class="line">阶段1：连接数据库，此时mysql会根据你的用户名及你的来源（ip或者主机名称）判断是否有权限连接</span><br><span class="line">阶段2：对mysql服务器发起请求操作，如create table、select、delete、update、create index等操作，此时mysql会判断你是否有权限操作这些指令</span><br></pre></td></tr></table></figure>
<h3 id="权限生效时间"><a href="#权限生效时间" class="headerlink" title="权限生效时间"></a>权限生效时间</h3><p>用户及权限信息放在库名为mysql的库中，mysql启动时，这些内容被读进内存并且从此时生效，所以如果通过直接操作这些表来修改用户及权限信息的，需要重启mysql或者执行flush privileges; 才可以生效。用户登录之后，mysql会和当前用户之间创建一个连接，此时用户相关的权限信息都保存在这个连接中，存放在内存中，此时如果有其他地方修改了当前用户的权限，这些变更的权限会在下一次登录时生效。</p>
<h3 id="查看mysql中所有用户"><a href="#查看mysql中所有用户" class="headerlink" title="查看mysql中所有用户"></a>查看mysql中所有用户</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">用户信息在 mysql.user 表中，如下：</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="keyword">user</span>,host <span class="keyword">from</span> <span class="keyword">user</span>; </span><br></pre></td></tr></table></figure>
<h3 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> 用户名@主机名 identified <span class="keyword">by</span> <span class="string">&#x27;密码&#x27;</span>;</span><br><span class="line"></span><br><span class="line">说明：</span><br><span class="line"><span class="number">1.</span> 主机名默认值为<span class="operator">%</span>，表示这个用户可以从任何主机连接mysql服务器</span><br><span class="line"><span class="number">2.</span> 密码可以省略，表示无密码登录</span><br><span class="line"></span><br><span class="line">示例:</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> <span class="string">&#x27;test2&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line">说明：test2的主机为localhost表示本机，此用户只能登陆本机的mysql</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> <span class="string">&#x27;test3&#x27;</span>@<span class="operator">%</span> identified <span class="keyword">by</span> <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line">说明：test3可以从任何机器连接到mysql服务器</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> <span class="string">&#x27;test4&#x27;</span>@<span class="string">&#x27;192.168.11.%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line">说明：test4可以从<span class="number">192.168</span><span class="number">.11</span>段的机器连接mysql</span><br></pre></td></tr></table></figure>
<h3 id="修改密码【3种方式】"><a href="#修改密码【3种方式】" class="headerlink" title="修改密码【3种方式】"></a>修改密码【3种方式】</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方式1：通过管理员修改密码</span></span><br><span class="line"><span class="keyword">SET</span> PASSWORD <span class="keyword">FOR</span> <span class="string">&#x27;用户名&#x27;</span>@<span class="string">&#x27;主机&#x27;</span> <span class="operator">=</span> PASSWORD(<span class="string">&#x27;密码&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方式2：create user 用户名@主机名  identified by &#x27;密码&#x27;;</span></span><br><span class="line"><span class="keyword">set</span> password <span class="operator">=</span> password(<span class="string">&#x27;密码&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方式3：通过修改mysql.user表修改密码</span></span><br><span class="line">use mysql; </span><br><span class="line"><span class="keyword">update</span> <span class="keyword">user</span> <span class="keyword">set</span> authentication_string <span class="operator">=</span> password(<span class="string">&#x27;321&#x27;</span>) <span class="keyword">where</span> <span class="keyword">user</span> <span class="operator">=</span> <span class="string">&#x27;test1&#x27;</span> <span class="keyword">and</span> host <span class="operator">=</span> <span class="string">&#x27;%&#x27;</span>; </span><br><span class="line">flush privileges;</span><br><span class="line"></span><br><span class="line">注意：</span><br><span class="line">通过表的方式修改之后，需要执行 flush privileges; 才能生效。</span><br><span class="line">MySQL5<span class="number">.7</span>中<span class="keyword">user</span>表中的authentication_string字段表示密码，老的一些版本中密码字段是password。</span><br></pre></td></tr></table></figure>
<h3 id="给用户授权"><a href="#给用户授权" class="headerlink" title="给用户授权"></a>给用户授权</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span> privileges <span class="keyword">ON</span> database.table <span class="keyword">TO</span> <span class="string">&#x27;username&#x27;</span>[@<span class="string">&#x27;host&#x27;</span>] [<span class="keyword">with</span> <span class="keyword">grant</span> option]</span><br><span class="line"></span><br><span class="line"><span class="keyword">grant</span>命令说明：</span><br><span class="line"><span class="comment">-- priveleges (权限列表)，可以是 all ，表示所有权限，也可以是 select、update 等权限，多个权限之间用逗号分开。</span></span><br><span class="line"><span class="comment">-- ON 用来指定权限针对哪些库和表，格式为 数据库.表名 。</span></span><br><span class="line"><span class="comment">-- TO 表示将权限赋予某个用户, 格式为 username@host ，@前面为用户名，@后面接限制的主机，可以是IP、IP段、域名以及%，%表示任何地方。</span></span><br><span class="line"><span class="comment">-- WITH GRANT OPTION 这个选项表示该用户可以将自己拥有的权限授权给别人。</span></span><br><span class="line"><span class="comment">-- 注意：经常有人在创建操作用户的时候不指定WITH GRANT OPTION选项导致后来该用户不能使用GRANT命令创建用户或者给其它用户授权。备注：可以使用GRANT重复给用户添加权限，权限叠加，比如你先给用户添加一个select权限，然后又给用户添加一个insert权限，那么该用户就同时拥有了select和insert权限。</span></span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> <span class="string">&#x27;test1&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">说明：给test1授权可以操作所有库所有权限，相当于dba</span><br><span class="line"></span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">select</span> <span class="keyword">on</span> seata.<span class="operator">*</span> <span class="keyword">to</span> <span class="string">&#x27;test1&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">说明：test1可以对seata库中所有的表执行<span class="keyword">select</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">select</span>,<span class="keyword">update</span> <span class="keyword">on</span> seata.<span class="operator">*</span> <span class="keyword">to</span> <span class="string">&#x27;test1&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">说明：test1可以对seata库中所有的表执行<span class="keyword">select</span>、<span class="keyword">update</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">select</span>(<span class="keyword">user</span>,host) <span class="keyword">on</span> mysql.user <span class="keyword">to</span> <span class="string">&#x27;test1&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line">说明：test1用户只能查询mysql.user表的<span class="keyword">user</span>,host字段</span><br></pre></td></tr></table></figure>
<h3 id="查看用户有哪些权限"><a href="#查看用户有哪些权限" class="headerlink" title="查看用户有哪些权限"></a>查看用户有哪些权限</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> grants <span class="keyword">for</span> <span class="string">&#x27;用户名&#x27;</span>[@<span class="string">&#x27;主机&#x27;</span>]</span><br></pre></td></tr></table></figure>
<p>主机可以省略，默认值为%，示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> grants <span class="keyword">for</span> root;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Grants <span class="keyword">for</span> root@<span class="operator">%</span>                                           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;%&#x27;</span> <span class="keyword">WITH</span> <span class="keyword">GRANT</span> OPTION <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.10</span> sec)</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--查看当前用户的权限</span></span><br><span class="line"><span class="keyword">show</span> grants;</span><br></pre></td></tr></table></figure>
<h3 id="撤销用户的权限"><a href="#撤销用户的权限" class="headerlink" title="撤销用户的权限"></a>撤销用户的权限</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">revoke</span> privileges <span class="keyword">ON</span> database.table <span class="keyword">FROM</span> <span class="string">&#x27;用户名&#x27;</span>[@<span class="string">&#x27;主机&#x27;</span>];</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> grants <span class="keyword">for</span> <span class="string">&#x27;test1&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>; </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Grants <span class="keyword">for</span> test1<span class="variable">@localhost</span> <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------------------------------+ </span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">GRANT</span> USAGE <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;test1&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span> <span class="keyword">GRANT</span> <span class="keyword">SELECT</span> (host, <span class="keyword">user</span>) <span class="keyword">ON</span> `mysql`.`<span class="keyword">user</span>` <span class="keyword">TO</span> <span class="string">&#x27;test1&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------------------------------+ </span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">revoke</span> <span class="keyword">select</span>(host) <span class="keyword">on</span> mysql.user <span class="keyword">from</span> test1<span class="variable">@localhost</span>; </span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> grants <span class="keyword">for</span> <span class="string">&#x27;test1&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>; </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Grants <span class="keyword">for</span> test1<span class="variable">@localhost</span> <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------------------------+ </span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">GRANT</span> USAGE <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;test1&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span> <span class="keyword">GRANT</span> <span class="keyword">SELECT</span> (<span class="keyword">user</span>) <span class="keyword">ON</span> `mysql`.`<span class="keyword">user</span>` <span class="keyword">TO</span> <span class="string">&#x27;test1&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> </span><br><span class="line"><span class="operator">|</span> <span class="operator">+</span><span class="comment">--------------------------------------------------------------+ </span></span><br></pre></td></tr></table></figure>
<h3 id="删除用户【2种方式】"><a href="#删除用户【2种方式】" class="headerlink" title="删除用户【2种方式】"></a>删除用户【2种方式】</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方式1：</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">user</span> <span class="string">&#x27;用户名&#x27;</span>[@<span class="string">&#x27;主机&#x27;</span>]</span><br><span class="line"><span class="keyword">drop</span>的方式删除用户之后，用户下次登录就会起效。</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方式2：</span></span><br><span class="line">通过删除mysql.user表数据的方式删除，如下：</span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> <span class="keyword">user</span><span class="operator">=</span><span class="string">&#x27;用户名&#x27;</span> <span class="keyword">and</span> host<span class="operator">=</span><span class="string">&#x27;主机&#x27;</span>; </span><br><span class="line">flush privileges;</span><br><span class="line">注意通过表的方式删除的，需要调用 flush privileges; 刷新权限信息（权限启动的时候在内存中保存着，通过表的方式修改之后需要刷新一下）。</span><br></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. 通过命令的方式操作用户和权限不需要刷新，下次登录自动生效</span><br><span class="line">2. 通过操作mysql库中表的方式修改用户信息，需要调用 flush privileges; 刷新一下，下次登录自动生效</span><br><span class="line">3. mysql识别用户身份的方式是：用户名+主机</span><br><span class="line">4. 本文中讲到的一些指令中带主机的，主机都可以省略，默认值为%，表示所有机器</span><br><span class="line">5. mysql中用户和权限的信息在库名为mysql的库中</span><br></pre></td></tr></table></figure>


<h2 id="第4篇：DDL常见操作汇总"><a href="#第4篇：DDL常见操作汇总" class="headerlink" title="第4篇：DDL常见操作汇总"></a>第4篇：DDL常见操作汇总</h2><h3 id="库的管理"><a href="#库的管理" class="headerlink" title="库的管理"></a>库的管理</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建库</span></span><br><span class="line"><span class="keyword">create</span> database [if <span class="keyword">not</span> <span class="keyword">exists</span>] 库名; </span><br><span class="line"><span class="comment">-- 删除库</span></span><br><span class="line"><span class="keyword">drop</span> databases [if <span class="keyword">exists</span>] 库名;</span><br><span class="line"><span class="comment">-- 建库通用的写法</span></span><br><span class="line"><span class="keyword">drop</span> database if <span class="keyword">exists</span> 旧库名; </span><br><span class="line"><span class="keyword">create</span> database 新库名; </span><br></pre></td></tr></table></figure>
<h3 id="表管理"><a href="#表管理" class="headerlink" title="表管理"></a>表管理</h3><h4 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> 表名( </span><br><span class="line">  字段名<span class="number">1</span> 类型[(宽度)] [约束条件] [comment <span class="string">&#x27;字段说明&#x27;</span>], </span><br><span class="line">  字段名<span class="number">2</span> 类型[(宽度)] [约束条件] [comment <span class="string">&#x27;字段说明&#x27;</span>], </span><br><span class="line">  字段名<span class="number">3</span> 类型[(宽度)] [约束条件] [comment <span class="string">&#x27;字段说明&#x27;</span>] </span><br><span class="line">)[表的一些设置];</span><br><span class="line"></span><br><span class="line">注意：</span><br><span class="line"><span class="number">1.</span> 同一张表中字段名不能相同</span><br><span class="line"><span class="number">2.</span> 宽度和约束条件为可选参数，字段名和类型是必须的</span><br><span class="line"><span class="number">3.</span> 最后一个字段后不能加逗号</span><br><span class="line"><span class="number">4.</span> 类型是用来限制字段必须以何种数据类型来存储记录</span><br><span class="line"><span class="number">5.</span> 类型其实也是对字段的约束</span><br><span class="line"><span class="number">6.</span> 类型后写的约束条件是在类型之外的额外添加的约束</span><br><span class="line"></span><br><span class="line">约束说明:</span><br><span class="line"><span class="number">1.</span> <span class="keyword">not</span> <span class="keyword">null</span>：标识该字段不能为空</span><br><span class="line"><span class="number">2.</span> <span class="keyword">default</span> <span class="keyword">value</span>：为该字段设置默认值，默认值为<span class="keyword">value</span></span><br><span class="line"><span class="number">3.</span> <span class="keyword">primary</span> <span class="keyword">key</span>：标识该字段为该表的主键，可以唯一的标识记录，插入重复会报错。两种写法，如下：</span><br><span class="line">   方式<span class="number">1</span>：跟在列后，如下：</span><br><span class="line">       mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> test3(a <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;字段a&#x27;</span> <span class="keyword">primary</span> <span class="keyword">key</span>);</span><br><span class="line">   方式<span class="number">2</span>：在所有列定义之后定义，如下：</span><br><span class="line">       mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> test4( </span><br><span class="line">         <span class="operator">-</span><span class="operator">&gt;</span> a <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;字段a&#x27;</span>, </span><br><span class="line">         <span class="operator">-</span><span class="operator">&gt;</span> b <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">default</span> <span class="number">0</span> comment <span class="string">&#x27;字段b&#x27;</span>, </span><br><span class="line">         <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">primary</span> <span class="keyword">key</span>(a) </span><br><span class="line">         <span class="operator">-</span><span class="operator">&gt;</span> );</span><br><span class="line">         </span><br><span class="line"><span class="number">4.</span> <span class="keyword">foreign</span> <span class="keyword">key</span>：为表中的字段设置外键</span><br><span class="line">   语法：<span class="keyword">foreign</span> <span class="keyword">key</span>(当前表的列名) <span class="keyword">references</span> 引用的外键表(外键表中字段名称)</span><br><span class="line">   例：<span class="keyword">foreign</span> <span class="keyword">key</span>(ts5_a) <span class="keyword">references</span> test5(a)</span><br><span class="line">   注意：</span><br><span class="line">   <span class="operator">-</span> 两张表中需要建立外键关系的字段类型需要一致</span><br><span class="line">   <span class="operator">-</span> 要设置外键的字段不能为主键</span><br><span class="line">   <span class="operator">-</span> 被引用的字段需要为主键</span><br><span class="line">   <span class="operator">-</span> 被插入的值在外键表必须存在，如上面向test6中插入ts5_a为<span class="number">2</span>的时候报错 (<span class="number">2</span>的值在test5表中不存在)</span><br><span class="line">   </span><br><span class="line"><span class="number">5.</span> <span class="keyword">unique</span> key(uq)：标识该字段的值是唯一的</span><br><span class="line">   支持一个到多个字段，插入重复的值会报违反唯一约束，插入失败。定义有<span class="number">2</span>种方式。</span><br><span class="line">   方式<span class="number">1</span>：跟在字段后，如下：</span><br><span class="line">       mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> test8(a <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;字段a&#x27;</span> <span class="keyword">unique</span> key);</span><br><span class="line">   方式<span class="number">2</span>：所有列定义之后定义，如下：</span><br><span class="line">       mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> test9( </span><br><span class="line">         <span class="operator">-</span><span class="operator">&gt;</span> a <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;字段a&#x27;</span>, </span><br><span class="line">         <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">unique</span> key(a) </span><br><span class="line">         <span class="operator">-</span><span class="operator">&gt;</span> );</span><br><span class="line">   方式<span class="number">2</span>支持多字段，多个之间用逗号隔开，示例：</span><br><span class="line">       mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> test10( </span><br><span class="line">         <span class="operator">-</span><span class="operator">&gt;</span> a <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;字段a&#x27;</span>, </span><br><span class="line">         <span class="operator">-</span><span class="operator">&gt;</span> b <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;字段b&#x27;</span>, </span><br><span class="line">         <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">unique</span> key(a,b) </span><br><span class="line">         <span class="operator">-</span><span class="operator">&gt;</span> );</span><br><span class="line">         </span><br><span class="line"><span class="number">6.</span> auto_increment：标识该字段的值自动增长（整数类型，而且为主键）</span><br><span class="line">   注意：自增长列当前值存储在内存中，数据库每次重启之后，会查询当前表中自增列的最大值作为当前值，如</span><br><span class="line">   果表数据被清空之后，数据库重启了，自增列的值将从初始值开始</span><br></pre></td></tr></table></figure>
<h4 id="删除表"><a href="#删除表" class="headerlink" title="删除表"></a>删除表</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> [if <span class="keyword">exists</span>] 表名;</span><br></pre></td></tr></table></figure>
<h4 id="修改表名"><a href="#修改表名" class="headerlink" title="修改表名"></a>修改表名</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名 rename [<span class="keyword">to</span>] 新表名; </span><br></pre></td></tr></table></figure>
<h4 id="表设置备注"><a href="#表设置备注" class="headerlink" title="表设置备注"></a>表设置备注</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名 comment <span class="string">&#x27;备注信息&#x27;</span>;</span><br></pre></td></tr></table></figure>
<h4 id="复制表"><a href="#复制表" class="headerlink" title="复制表"></a>复制表</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 只复制表结构</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> 表名 <span class="keyword">like</span> 被复制的表名;</span><br><span class="line"><span class="comment">-- 复制表结构+数据</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> 表名 [<span class="keyword">as</span>] <span class="keyword">select</span> 字段,... <span class="keyword">from</span> 被复制的表 [<span class="keyword">where</span> 条件];</span><br></pre></td></tr></table></figure>
<h4 id="表中列的管理"><a href="#表中列的管理" class="headerlink" title="表中列的管理"></a>表中列的管理</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 添加列</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名 <span class="keyword">add</span> <span class="keyword">column</span> 列名 类型 [列约束];</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> test14 <span class="keyword">add</span> <span class="keyword">column</span> c <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">default</span> <span class="number">0</span> comment <span class="string">&#x27;字段c&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 修改列</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名 modify <span class="keyword">column</span> 列名 新类型 [约束]; </span><br><span class="line">或者</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名 change <span class="keyword">column</span> 列名 新列名 新类型 [约束];</span><br><span class="line"><span class="number">2</span>种方式区别：modify不能修改列名，change可以修改列名</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除列</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名 <span class="keyword">drop</span> <span class="keyword">column</span> 列名;</span><br></pre></td></tr></table></figure>
<h3 id="约束管理（补充）"><a href="#约束管理（补充）" class="headerlink" title="约束管理（补充）"></a>约束管理（补充）</h3><p>MySQL中主要有6种约束：主键约束、外键约束、唯一约束、检查约束、非空约束和默认值约束。</p>
<h4 id="主键约束"><a href="#主键约束" class="headerlink" title="主键约束"></a>主键约束</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 一个表只能定义一个主键；</span></span><br><span class="line"><span class="comment">-- 主键值必须唯一标识表中的每一行，并且不能出现null的情况，即表中不能存在有相同主键的两行或两行以上数据，严格遵守唯一性原则；</span></span><br><span class="line"><span class="comment">-- 一个字段名只能在联合主键字段表中出现一次；</span></span><br><span class="line"><span class="comment">-- 联合主键不能包含不必要的多余字段，以满足最小化原则。</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span>）在定义字段的时候设置主键约束，语法格式：</span><br><span class="line"><span class="operator">&lt;</span>字段名<span class="operator">&gt;</span> <span class="operator">&lt;</span>数据类型<span class="operator">&gt;</span> <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> [默认值]</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>）在定义完所有字段之后指定部件，语法格式：</span><br><span class="line">[<span class="keyword">CONSTRAINT</span> <span class="operator">&lt;</span>约束名<span class="operator">&gt;</span>] <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> [字段名]</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>) 联合主键</span><br><span class="line"><span class="keyword">primary</span> <span class="keyword">key</span>(id, name)</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>）在修改表的时候添加主键约束</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="operator">&lt;</span>数据表名<span class="operator">&gt;</span> <span class="keyword">ADD</span> <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span>(<span class="operator">&lt;</span>字段名<span class="operator">&gt;</span>);</span><br><span class="line"></span><br><span class="line"><span class="number">5</span>）删除主键约束</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名 <span class="keyword">drop</span> <span class="keyword">primary</span> <span class="keyword">key</span>;</span><br></pre></td></tr></table></figure>
<h4 id="外键约束"><a href="#外键约束" class="headerlink" title="外键约束"></a>外键约束</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">在定义外键时需要遵守以下规则：</span><br><span class="line"><span class="comment">-- 主表必须已经存在于数据库中，或者是当前正在创建的表。如果是后一种情况，则主表与从表是同一个表，这样的表称做自参照表，这种结构称做自参照完整性；</span></span><br><span class="line"><span class="comment">-- 必须为主表定义主键；</span></span><br><span class="line"><span class="comment">-- 主键不能包含空值，但允许在外键中出现空值；</span></span><br><span class="line"><span class="comment">-- 在主表的表名后面指定列名或列名的组合，这个列或列的组合必须是主表的主键或候选键；</span></span><br><span class="line"><span class="comment">-- 外键中列的数目必须和主表的主键中列的数目相同；</span></span><br><span class="line"><span class="comment">-- 外键中列的数据类型必须和主表主键中对应列的数据类型相同。</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span>) 在创建表时设置外键约束</span><br><span class="line"><span class="keyword">CONSTRAINT</span> <span class="operator">&lt;</span>约束名<span class="operator">&gt;</span></span><br><span class="line"><span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> <span class="operator">&lt;</span>外键名<span class="operator">&gt;</span>(字段名<span class="number">1</span>，字段名<span class="number">2.</span>..)</span><br><span class="line"><span class="keyword">REFERENCES</span> <span class="operator">&lt;</span>关联表<span class="operator">&gt;</span>(主键字段名)</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>) 在修改表时添加外键约束</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名 </span><br><span class="line"><span class="keyword">add</span> </span><br><span class="line"><span class="keyword">constraint</span> 约束名</span><br><span class="line"><span class="keyword">foreign</span> <span class="keyword">key</span> <span class="operator">&lt;</span>外键名<span class="operator">&gt;</span>(字段)</span><br><span class="line"><span class="keyword">references</span> <span class="operator">&lt;</span>关联表<span class="operator">&gt;</span>(主键字段名);</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>）删除外键</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="operator">&lt;</span>表名<span class="operator">&gt;</span> </span><br><span class="line"><span class="keyword">DROP</span> </span><br><span class="line"><span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> <span class="operator">&lt;</span>外键名<span class="operator">&gt;</span>;</span><br></pre></td></tr></table></figure>
<h4 id="唯一约束"><a href="#唯一约束" class="headerlink" title="唯一约束"></a>唯一约束</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 唯一约束就是指所有记录中字段的值不能重复出现，比如给&#x27;id&#x27;字段加上唯一约束之后，每条记录的id值都是唯一的，不能出现重复的情况。</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span>) 在创建表时设置唯一约束</span><br><span class="line"><span class="operator">&lt;</span>字段名<span class="operator">&gt;</span> <span class="operator">&lt;</span>数据类型<span class="operator">&gt;</span> <span class="keyword">UNIQUE</span></span><br><span class="line"></span><br><span class="line"><span class="number">2</span>) 在修改表时添加唯一约束</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="operator">&lt;</span>表名<span class="operator">&gt;</span> </span><br><span class="line"><span class="keyword">ADD</span> </span><br><span class="line"><span class="keyword">CONSTRAINT</span> <span class="operator">&lt;</span>唯一约束名<span class="operator">&gt;</span> <span class="keyword">UNIQUE</span>(列名);</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>) 删除唯一约束</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="operator">&lt;</span>表名<span class="operator">&gt;</span> </span><br><span class="line"><span class="keyword">DROP</span> INDEX <span class="operator">&lt;</span>唯一约束名<span class="operator">&gt;</span>;</span><br></pre></td></tr></table></figure>
<h4 id="检查约束、非空约束和默认值约束"><a href="#检查约束、非空约束和默认值约束" class="headerlink" title="检查约束、非空约束和默认值约束"></a>检查约束、非空约束和默认值约束</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>) 在创建表时设置检查约束</span><br><span class="line"><span class="operator">&lt;</span>字段名<span class="operator">&gt;</span> <span class="operator">&lt;</span>数据类型<span class="operator">&gt;</span> <span class="keyword">CHECK</span>(<span class="keyword">condition</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>) 在创建表时设置非空约束</span><br><span class="line"><span class="operator">&lt;</span>字段名<span class="operator">&gt;</span> <span class="operator">&lt;</span>数据类型<span class="operator">&gt;</span> [<span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>]</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>) 在创建表时设置默认值约束</span><br><span class="line"><span class="operator">&lt;</span>字段名<span class="operator">&gt;</span> <span class="operator">&lt;</span>数据类型<span class="operator">&gt;</span> <span class="keyword">DEFAULT</span></span><br></pre></td></tr></table></figure>


<h2 id="第5篇：DML常见操作"><a href="#第5篇：DML常见操作" class="headerlink" title="第5篇：DML常见操作"></a>第5篇：DML常见操作</h2><h3 id="插入单行2种方式"><a href="#插入单行2种方式" class="headerlink" title="插入单行2种方式"></a>插入单行2种方式</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> 表名[(字段,字段)] <span class="keyword">values</span> (值,值);</span><br><span class="line">说明：</span><br><span class="line">值和字段需要对应</span><br><span class="line">如果是字符型或日期类型，值需要用单引号引起来；如果是数值类型，不需要用单引号</span><br><span class="line">字段和值的个数必须一致，位置对应</span><br><span class="line">字段如果不能为空，则必须插入值</span><br><span class="line">可以为空的字段可以不用插入值，但需要注意：字段和值都不写；或字段写上，值用<span class="keyword">null</span>代替</span><br><span class="line">表名后面的字段可以省略不写，此时表示所有字段，顺序和表中字段顺序一致。</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> 表名 <span class="keyword">set</span> 字段 <span class="operator">=</span> 值,字段 <span class="operator">=</span> 值; <span class="comment">-- 不建议使用</span></span><br></pre></td></tr></table></figure>
<h3 id="批量插入2种方式"><a href="#批量插入2种方式" class="headerlink" title="批量插入2种方式"></a>批量插入2种方式</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> 表名 [(字段,字段)] <span class="keyword">values</span> (值,值),(值,值),(值,值);</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> 表 [(字段,字段)] 数据来源<span class="keyword">select</span>语句;</span><br><span class="line">例： <span class="keyword">insert</span> <span class="keyword">into</span> test1 (a,b) <span class="keyword">select</span> c2,c3 <span class="keyword">from</span> test2 <span class="keyword">where</span> c1<span class="operator">&gt;=</span><span class="number">200</span>;</span><br><span class="line">说明：数据来源<span class="keyword">select</span>语句可以有很多种写法，</span><br><span class="line">需要注意：<span class="keyword">select</span>返回的结果和插入数据的字段数量、顺序、类型需要一致。</span><br></pre></td></tr></table></figure>
<h3 id="数据更新"><a href="#数据更新" class="headerlink" title="数据更新"></a>数据更新</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> 表名 [[<span class="keyword">as</span>] 别名] <span class="keyword">set</span> [别名.]字段 <span class="operator">=</span> 值,[别名.]字段 <span class="operator">=</span> 值 [<span class="keyword">where</span>条件];</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> 表<span class="number">1</span> [[<span class="keyword">as</span>] 别名<span class="number">1</span>],表<span class="number">2</span> [[<span class="keyword">as</span>] 别名<span class="number">2</span>] <span class="keyword">set</span> [别名.]字段 <span class="operator">=</span> 值,[别名.]字段 <span class="operator">=</span> 值 [<span class="keyword">where</span>条件]</span><br></pre></td></tr></table></figure>
<h3 id="删除数据操作"><a href="#删除数据操作" class="headerlink" title="删除数据操作"></a>删除数据操作</h3><ul>
<li><p>使用delete删除</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> [别名] <span class="keyword">from</span> 表名 [[<span class="keyword">as</span>] 别名] [<span class="keyword">where</span>条件];</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> [别名<span class="number">1</span>,别名<span class="number">2</span>] <span class="keyword">from</span> 表<span class="number">1</span> [[<span class="keyword">as</span>] 别名<span class="number">1</span>],表<span class="number">2</span> [[<span class="keyword">as</span>] 别名<span class="number">2</span>] [<span class="keyword">where</span>条件];</span><br><span class="line">例：</span><br><span class="line"><span class="keyword">delete</span> t1 <span class="keyword">from</span> test1 t1,test2 t2 <span class="keyword">where</span> t1.a<span class="operator">=</span>t2.c2;</span><br><span class="line"><span class="keyword">delete</span> t2,t1 <span class="keyword">from</span> test1 t1,test2 t2 <span class="keyword">where</span> t1.a<span class="operator">=</span>t2.c2;</span><br></pre></td></tr></table></figure></li>
<li><p>使用truncate删除</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">truncate</span> 表名;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="drop，truncate，delete区别"><a href="#drop，truncate，delete区别" class="headerlink" title="drop，truncate，delete区别"></a>drop，truncate，delete区别</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- drop (删除表)：</span></span><br><span class="line">  <span class="number">1.</span> 删除内容和定义，释放空间，简单来说就是把整个表去掉，以后要新增数据是不可能的，除非新增一个表。</span><br><span class="line">  <span class="number">2.</span> <span class="keyword">drop</span>语句将删除表的结构，被依赖的约束（constrain），触发器（<span class="keyword">trigger</span>），索引（index），依赖于该表的      存储过程<span class="operator">/</span>函数将被保留，但其状态会变为：invalid。</span><br><span class="line">  <span class="number">3.</span> 如果要删除表定义及其数据，请使用 <span class="keyword">drop</span> <span class="keyword">table</span> 语句。</span><br><span class="line"><span class="comment">-- truncate (清空表中的数据)：</span></span><br><span class="line">  <span class="number">1.</span> 删除内容、释放空间但不删除定义(保留表的数据结构)，与<span class="keyword">drop</span>不同的是，只是清空表数据而已。</span><br><span class="line">  <span class="number">2.</span> 注意：<span class="keyword">truncate</span>不能删除具体行数据，要删就要把整个表清空了。</span><br><span class="line"><span class="comment">-- delete (删除表中的数据)：</span></span><br><span class="line">  <span class="number">1.</span> <span class="keyword">delete</span> 语句用于删除表中的行。<span class="keyword">delete</span>语句执行删除的过程是每次从表中删除一行，并且同时将该行的删除操      作作为事务记录在日志中保存，以便进行进行回滚操作。</span><br><span class="line">  <span class="number">2.</span> <span class="keyword">truncate</span>与不带<span class="keyword">where</span>的<span class="keyword">delete</span> ：只删除数据，而不删除表的结构（定义）</span><br><span class="line">  <span class="number">3.</span> <span class="keyword">truncate</span> <span class="keyword">table</span> 删除表中的所有行，但表结构及其列、约束、索引等保持不变。</span><br><span class="line">  <span class="number">4.</span> 对于由<span class="keyword">foreign</span> <span class="keyword">key</span>约束引用的表，不能使用<span class="keyword">truncate</span> <span class="keyword">table</span> ，而应使用不带<span class="keyword">where</span>子句的<span class="keyword">delete</span>语句。由于      <span class="keyword">truncate</span> <span class="keyword">table</span> 记录在日志中，所以它不能激活触发器。</span><br><span class="line">  <span class="number">5.</span> <span class="keyword">delete</span>语句是数据库操作语言(dml)，这个操作会放到 <span class="keyword">rollback</span> segement 中，事务提交之后才生效；如果有      相应的 <span class="keyword">trigger</span>，执行的时候将被触发。</span><br><span class="line">  <span class="number">6.</span> <span class="keyword">truncate</span>、<span class="keyword">drop</span> 是数据库定义语言(ddl)，操作立即生效，原数据不放到 <span class="keyword">rollback</span> segment 中，不能回滚，      操作不触发 <span class="keyword">trigger</span>。</span><br><span class="line">  <span class="number">7.</span> 如果有自增列，<span class="keyword">truncate</span>方式删除之后，自增列的值会被初始化，<span class="keyword">delete</span>方式要分情况（如果数据库被重启了，      自增列值也会被初始化，数据库未被重启，则不变）</span><br><span class="line">  <span class="number">8.</span> 如果要删除表定义及其数据，请使用 <span class="keyword">drop</span> <span class="keyword">table</span> 语句</span><br><span class="line">  <span class="number">9.</span> 安全性：小心使用 <span class="keyword">drop</span> 和 <span class="keyword">truncate</span>，尤其没有备份的时候</span><br><span class="line">  <span class="number">10.</span> 删除速度，一般来说: <span class="keyword">drop</span><span class="operator">&gt;</span> <span class="keyword">truncate</span> <span class="operator">&gt;</span> <span class="keyword">delete</span></span><br></pre></td></tr></table></figure>
<p><img src="/2021/01/24/MySQL%E6%95%B4%E7%90%86/8.png" alt="8"></p>
<h2 id="第6篇：select查询基础"><a href="#第6篇：select查询基础" class="headerlink" title="第6篇：select查询基础"></a>第6篇：select查询基础</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 基本语法</span></span><br><span class="line"><span class="keyword">select</span> 查询的列 <span class="keyword">from</span> 表名;</span><br><span class="line"><span class="comment">-- 查询常量</span></span><br><span class="line"><span class="keyword">select</span> 常量值<span class="number">1</span>,常量值<span class="number">2</span>,常量值<span class="number">3</span>;</span><br><span class="line"><span class="comment">-- 查询表达式</span></span><br><span class="line"><span class="keyword">select</span> 表达式;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="number">1</span><span class="operator">+</span><span class="number">2</span>,<span class="number">3</span><span class="operator">*</span><span class="number">10</span>,<span class="number">10</span><span class="operator">/</span><span class="number">3</span>; </span><br><span class="line"><span class="operator">+</span><span class="comment">-----+------+--------+ </span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span><span class="operator">+</span><span class="number">2</span> <span class="operator">|</span> <span class="number">3</span><span class="operator">*</span><span class="number">10</span> <span class="operator">|</span> <span class="number">10</span><span class="operator">/</span><span class="number">3</span>   <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">-----+------+--------+ </span></span><br><span class="line"><span class="operator">|</span> <span class="number">3</span>   <span class="operator">|</span> <span class="number">30</span>   <span class="operator">|</span> <span class="number">3.3333</span> <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">-----+------+--------+ </span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询函数</span></span><br><span class="line"><span class="keyword">select</span> 函数;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">mod</span>(<span class="number">10</span>,<span class="number">4</span>),</span><br><span class="line">    		isnull(<span class="keyword">null</span>),</span><br><span class="line">    		ifnull(<span class="keyword">null</span>,<span class="string">&#x27;第一个参数为空返回这个 值&#x27;</span>),</span><br><span class="line">    		ifnull(<span class="number">1</span>,<span class="string">&#x27;第一个参数为空返回这个值，否知返回第一个参数&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询指定的字段</span></span><br><span class="line"><span class="keyword">select</span> 字段<span class="number">1</span>,字段<span class="number">2</span>,字段<span class="number">3</span> <span class="keyword">from</span> 表名;</span><br><span class="line"><span class="comment">-- 查询所有列</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> 表名</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 列别名</span></span><br><span class="line"><span class="keyword">select</span> 列 [<span class="keyword">as</span>] 别名 <span class="keyword">from</span> 表;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用双引号创建别名：</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> a &quot;列1&quot;,b &quot;列2&quot; <span class="keyword">from</span> test1; </span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+ </span></span><br><span class="line"><span class="operator">|</span> 列<span class="number">1</span> <span class="operator">|</span> 列<span class="number">2</span> <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+ </span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span> <span class="operator">|</span> a <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span> <span class="number">2</span> <span class="operator">|</span> b <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span> <span class="number">3</span> <span class="operator">|</span> c <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+</span></span><br><span class="line"><span class="comment">-- 使用单引号创建别名：</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> a <span class="string">&#x27;列1&#x27;</span>,b <span class="string">&#x27;列2&#x27;</span> <span class="keyword">from</span> test1;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+ </span></span><br><span class="line"><span class="operator">|</span> 列<span class="number">1</span> <span class="operator">|</span> 列<span class="number">2</span> <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+ </span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span> <span class="operator">|</span> a <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span> <span class="number">2</span> <span class="operator">|</span> b <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span> <span class="number">3</span> <span class="operator">|</span> c <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+</span></span><br><span class="line"><span class="comment">-- 不用引号创建别名</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> a 列<span class="number">1</span>,b 列<span class="number">2</span> <span class="keyword">from</span> test1; </span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+ </span></span><br><span class="line"><span class="operator">|</span> 列<span class="number">1</span> <span class="operator">|</span> 列<span class="number">2</span> <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+ </span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span> <span class="operator">|</span> a <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span> <span class="number">2</span> <span class="operator">|</span> b <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span> <span class="number">3</span> <span class="operator">|</span> c <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+</span></span><br><span class="line"><span class="comment">-- 使用as创建别名</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> a <span class="keyword">as</span> 列<span class="number">1</span>,b <span class="keyword">as</span> <span class="string">&#x27;列 2&#x27;</span> <span class="keyword">from</span> test1; </span><br><span class="line"><span class="operator">+</span><span class="comment">------+-------+ </span></span><br><span class="line"><span class="operator">|</span> 列<span class="number">1</span> <span class="operator">|</span> 列 <span class="number">2</span> <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">------+-------+ </span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span> <span class="operator">|</span> a <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span> <span class="number">2</span> <span class="operator">|</span> b <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span> <span class="number">3</span> <span class="operator">|</span> c <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">------+-------+ </span></span><br><span class="line"><span class="comment">-- 别名中有特殊符号的，比如空格，此时别名必须用引号引起来。</span></span><br></pre></td></tr></table></figure>
<p><strong>懵逼示例，看效果</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="string">&#x27;a&#x27;</span> <span class="string">&#x27;b&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+</span></span><br><span class="line"><span class="operator">|</span> a  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+</span></span><br><span class="line"><span class="operator">|</span> ab <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="string">&#x27;a&#x27;</span> b;</span><br><span class="line"><span class="operator">+</span><span class="comment">---+</span></span><br><span class="line"><span class="operator">|</span> b <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---+</span></span><br><span class="line"><span class="operator">|</span> a <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---+</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="string">&#x27;a&#x27;</span> &quot;b&quot;;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+</span></span><br><span class="line"><span class="operator">|</span> a  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+</span></span><br><span class="line"><span class="operator">|</span> ab <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="string">&#x27;a&#x27;</span> <span class="keyword">as</span> &quot;b&quot;;</span><br><span class="line"><span class="operator">+</span><span class="comment">---+</span></span><br><span class="line"><span class="operator">|</span> b <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---+</span></span><br><span class="line"><span class="operator">|</span> a <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---+</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 第1个和第3个返回的结果，是不是懵逼状态，建议最好使用as，as后面跟上别名。</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 表别名</span></span><br><span class="line"><span class="keyword">select</span> 别名.字段,别名.<span class="operator">*</span> <span class="keyword">from</span> 表名 [<span class="keyword">as</span>] 别名;</span><br></pre></td></tr></table></figure>


<h2 id="第7篇：select条件查询"><a href="#第7篇：select条件查询" class="headerlink" title="第7篇：select条件查询"></a>第7篇：select条件查询</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 条件查询</span></span><br><span class="line"><span class="keyword">select</span> 列名 <span class="keyword">from</span> 表名 <span class="keyword">where</span> 列 运算符 值</span><br><span class="line"><span class="comment">-- 条件查询运算符  =  !=  &lt;&gt;  &gt;  &lt;  &gt;=  &lt;=</span></span><br><span class="line"><span class="comment">-- 注意：&lt;&gt; 这个是最早的用法。 !=是后来才加上的。两者意义相同，在可移植性上前者优于后者。故而sql语句中尽量使用&lt;&gt;来做不等判断</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 逻辑查询运算符  AND  OR</span></span><br><span class="line"><span class="keyword">select</span> 列名 <span class="keyword">from</span> 表名 <span class="keyword">where</span> 条件<span class="number">1</span> <span class="keyword">and</span> 条件<span class="number">2</span>;</span><br><span class="line"><span class="keyword">select</span> 列名 <span class="keyword">from</span> 表名 <span class="keyword">where</span> 条件<span class="number">1</span> <span class="keyword">or</span> 条件<span class="number">2</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- like（模糊查询）</span></span><br><span class="line"><span class="keyword">select</span> 列名 <span class="keyword">from</span> 表名 <span class="keyword">where</span> 列 <span class="keyword">like</span> <span class="keyword">pattern</span>;</span><br><span class="line"><span class="comment">-- pattern 中可以包含通配符，有以下通配符：</span></span><br><span class="line"><span class="comment">-- %：表示匹配任意一个或多个字符</span></span><br><span class="line"><span class="comment">-- _：表示匹配任意一个字符。</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--- BETWEEN AND(区间查询)</span></span><br><span class="line"><span class="keyword">BETWEEN</span> ... <span class="keyword">AND</span> 会选取介于两个值之间的数据范围，这些值可以是数值、文本或者日期，属于闭区间查询。</span><br><span class="line"><span class="keyword">select</span> 列名 <span class="keyword">from</span> 表名 <span class="keyword">where</span> 列名 <span class="keyword">between</span> 值<span class="number">1</span> <span class="keyword">and</span> 值<span class="number">2</span>;</span><br><span class="line"><span class="comment">-- 返回对应的列的值在[值1,值2]区间中的记录, 使用between and可以提高语句的简洁度</span></span><br><span class="line"><span class="comment">-- 两个临界值不要调换位置，只能是大于等于左边的值，并且小于等于右边的值。</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- IN查询</span></span><br><span class="line"><span class="keyword">select</span> 列名 <span class="keyword">from</span> 表名 <span class="keyword">where</span> 字段 <span class="keyword">in</span> (值<span class="number">1</span>,值<span class="number">2</span>,值<span class="number">3</span>,值<span class="number">4</span>);</span><br><span class="line"><span class="comment">-- in 后面括号中可以包含多个值，对应记录的字段满足 in 中任意一个都会被返回</span></span><br><span class="line"><span class="comment">-- in 列表的值类型必须一致或兼容</span></span><br><span class="line"><span class="comment">-- in 列表中不支持通配符。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- NOT IN查询</span></span><br><span class="line"><span class="keyword">select</span> 列名 <span class="keyword">from</span> 表名 <span class="keyword">where</span> 字段 <span class="keyword">not</span> <span class="keyword">in</span> (值<span class="number">1</span>,值<span class="number">2</span>,值<span class="number">3</span>,值<span class="number">4</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- NULL存在的坑</span></span><br><span class="line"><span class="comment">-- 结论：查询运算符、like、between  and、in、not  in 对 NULL 值查询不起效。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- IS NULL/IS NOT NULL（NULL值专用查询）</span></span><br><span class="line"><span class="keyword">IS</span> <span class="keyword">NULL</span>（返回值为空的记录）</span><br><span class="line"><span class="keyword">select</span> 列名 <span class="keyword">from</span> 表名 <span class="keyword">where</span> 列 <span class="keyword">is</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>（返回值不为空的记录）</span><br><span class="line"><span class="keyword">select</span> 列名 <span class="keyword">from</span> 表名 <span class="keyword">where</span> 列 <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- &lt;=&gt;（安全等于）</span></span><br><span class="line"><span class="operator">&lt;=&gt;</span>：既可以判断<span class="keyword">NULL</span>值，又可以判断普通的数值，可读性较低，用得较少</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 两条 sql 查询结果一致吗？</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> students; </span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> students <span class="keyword">where</span> name <span class="keyword">like</span> <span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"><span class="comment">-- 当name没有NULL值时，返回的结果一样。</span></span><br><span class="line"><span class="comment">-- 当name有NULL值时，第2个sql查询不出name为NULL的记录。</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 总结</span></span><br><span class="line"><span class="keyword">like</span> 中的 <span class="operator">%</span> 可以匹配一个到多个任意的字符，_ 可以匹配任意一个字符</span><br><span class="line">空值查询需要使用 <span class="keyword">IS</span> <span class="keyword">NULL</span> 或者 <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>，其他查询运算符对 <span class="keyword">NULL</span> 值无效</span><br><span class="line">建议创建表的时候，尽量设置表的字段不能为空，给字段设置一个默认值</span><br><span class="line"><span class="operator">&lt;=&gt;</span>（安全等于）玩玩可以，建议少使用</span><br></pre></td></tr></table></figure>


<h2 id="第8篇：排序和分页"><a href="#第8篇：排序和分页" class="headerlink" title="第8篇：排序和分页"></a>第8篇：排序和分页</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 排序查询（order by）</span></span><br><span class="line"><span class="keyword">select</span> 字段名 <span class="keyword">from</span> 表名 <span class="keyword">order</span> <span class="keyword">by</span> 字段<span class="number">1</span> [<span class="keyword">asc</span><span class="operator">|</span><span class="keyword">desc</span>],字段<span class="number">2</span> [<span class="keyword">asc</span><span class="operator">|</span><span class="keyword">desc</span>];</span><br><span class="line"><span class="comment">-- 需要排序的字段跟在 order by 之后；asc | desc表示排序的规则，asc：升序，desc：降序，默认为asc；</span></span><br><span class="line"><span class="comment">-- 支持多个字段进行排序，多字段排序之间用逗号隔开。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--例：</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> stu <span class="keyword">order</span> <span class="keyword">by</span> age <span class="keyword">desc</span>,id <span class="keyword">asc</span>;</span><br><span class="line"><span class="keyword">select</span> age <span class="string">&#x27;年龄&#x27;</span>,id <span class="keyword">as</span> <span class="string">&#x27;学号&#x27;</span> <span class="keyword">from</span> stu <span class="keyword">order</span> <span class="keyword">by</span> 年龄 <span class="keyword">asc</span>,学号 <span class="keyword">desc</span>;</span><br><span class="line"><span class="comment">-- year函数：属于日期函数，可以获取对应日期中的年份。--</span></span><br><span class="line"><span class="keyword">SELECT</span> id 编号,birth 出生日期,<span class="keyword">year</span>(birth) 出生年份,name 姓名 <span class="keyword">from</span> student <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">year</span>(birth) <span class="keyword">asc</span>,id <span class="keyword">asc</span>; </span><br><span class="line"><span class="comment">-- where之后进行排序 --</span></span><br><span class="line"><span class="keyword">select</span> a.id, a.price <span class="keyword">from</span> t_order a <span class="keyword">where</span> a.price<span class="operator">&gt;=</span><span class="number">100</span> <span class="keyword">order</span> <span class="keyword">by</span> a.price <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- limit介绍</span></span><br><span class="line"><span class="keyword">select</span> 列 <span class="keyword">from</span> 表 limit [<span class="keyword">offset</span>,] count;</span><br><span class="line"><span class="comment">-- 说明：</span></span><br><span class="line"><span class="comment">-- offset：表示偏移量，通俗点讲就是跳过多少行，offset可以省略，默认为0，表示跳过0行；范围：[0,+∞)。</span></span><br><span class="line"><span class="comment">-- count：跳过offset行之后开始取数据，取count行记录；范围：[0,+∞)。</span></span><br><span class="line"><span class="comment">-- limit 中 offset 和 count 的值不能用表达式。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 获取前n行记录--</span></span><br><span class="line"><span class="keyword">select</span> 列 <span class="keyword">from</span> 表 limit <span class="number">0</span>,n; </span><br><span class="line">或者</span><br><span class="line"><span class="keyword">select</span> 列 <span class="keyword">from</span> 表 limit n;</span><br><span class="line"><span class="comment">-- 获取最大的一条记录 --</span></span><br><span class="line"><span class="keyword">select</span> a.id, a.price <span class="keyword">from</span> t_order a <span class="keyword">order</span> <span class="keyword">by</span> a.price <span class="keyword">desc</span> limit <span class="number">1</span>;</span><br><span class="line"><span class="keyword">select</span> a.id, a.price <span class="keyword">from</span> t_order a <span class="keyword">order</span> <span class="keyword">by</span> a.price <span class="keyword">desc</span> limit <span class="number">0</span>,<span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 获取排名第n到m的记录 --</span></span><br><span class="line"><span class="keyword">select</span> 列 <span class="keyword">from</span> 表 limit n<span class="number">-1</span>,m<span class="operator">-</span>n<span class="operator">+</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 分页查询</span></span><br><span class="line"><span class="comment">-- 开发过程中，分页我们经常使用，分页一般有2个参数：</span></span><br><span class="line"><span class="comment">-- page：表示第几页，从1开始，范围[1,+∞)</span></span><br><span class="line"><span class="comment">-- pageSize：每页显示多少条记录，范围[1,+∞)</span></span><br><span class="line"><span class="comment">-- 如：page = 2，pageSize = 10，表示获取第2页10条数据。</span></span><br><span class="line"><span class="comment">-- 我们使用limit实现分页，语法如下：</span></span><br><span class="line"><span class="keyword">select</span> 列 <span class="keyword">from</span> 表名 limit (page <span class="operator">-</span> <span class="number">1</span>) <span class="operator">*</span> pageSize, pageSize;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 避免踩坑</span></span><br><span class="line"><span class="comment">-- limit中不能使用表达式，limit后面只能够跟明确的数字。</span></span><br><span class="line">ERROR: <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_order <span class="keyword">where</span> limit <span class="number">1</span>,<span class="number">4</span><span class="operator">+</span><span class="number">1</span>;</span><br><span class="line"><span class="comment">-- limit后面的2个数字不能为负数</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 排序分页存在的坑</span></span><br><span class="line"><span class="comment">-- 排序中存在相同的值时，需要再指定一个排序规则，通过这种排序规则不存在二义性</span></span><br><span class="line"><span class="comment">-- 分页排序时，排序不要有二义性，二义性情况下可能会导致分页结果乱序，可以在后面追加一个主键排序</span></span><br></pre></td></tr></table></figure>


<h2 id="第9篇：分组查询"><a href="#第9篇：分组查询" class="headerlink" title="第9篇：分组查询"></a>第9篇：分组查询</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">column</span>, group_function,... <span class="keyword">FROM</span> <span class="keyword">table</span> </span><br><span class="line">[<span class="keyword">WHERE</span> <span class="keyword">condition</span>] </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> group_by_expression </span><br><span class="line">[<span class="keyword">HAVING</span> group_condition];</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 说明：</span></span><br><span class="line"><span class="comment">-- group_function：聚合函数。</span></span><br><span class="line"><span class="comment">-- group_by_expression：分组表达式，多个之间用逗号隔开。</span></span><br><span class="line"><span class="comment">-- group_condition：分组之后对数据进行过滤。</span></span><br><span class="line"><span class="comment">-- 分组中，select后面只能有两种类型的列：</span></span><br><span class="line"><span class="number">1.</span> 出现在<span class="keyword">group</span> <span class="keyword">by</span>后的列</span><br><span class="line"><span class="number">2.</span> 或者使用聚合函数的列</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 聚合函数</span></span><br><span class="line"><span class="comment">-- max  min  count  sum  avg</span></span><br></pre></td></tr></table></figure>
<h3 id="查询案例"><a href="#查询案例" class="headerlink" title="查询案例"></a>查询案例</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> t_order; </span><br><span class="line"><span class="comment">-- 创建订单表 </span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t_order( </span><br><span class="line">  id <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;订单id&#x27;</span>, </span><br><span class="line">  user_id <span class="type">bigint</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;下单人id&#x27;</span>, </span><br><span class="line">  user_name <span class="type">varchar</span>(<span class="number">16</span>) <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">default</span> <span class="string">&#x27;&#x27;</span> comment <span class="string">&#x27;用户名&#x27;</span>, </span><br><span class="line">  price <span class="type">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">default</span> <span class="number">0</span> comment <span class="string">&#x27;订单金额&#x27;</span>, </span><br><span class="line">  the_year <span class="type">SMALLINT</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;订单创建年份&#x27;</span>, </span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (id) ) comment <span class="string">&#x27;订单表&#x27;</span>; </span><br><span class="line"><span class="comment">-- 插入数据 </span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_order(user_id,user_name,price,the_year) <span class="keyword">values</span> </span><br><span class="line">  (<span class="number">1001</span>,<span class="string">&#x27;路人甲Java&#x27;</span>,<span class="number">11.11</span>,<span class="string">&#x27;2017&#x27;</span>), </span><br><span class="line">  (<span class="number">1001</span>,<span class="string">&#x27;路人甲Java&#x27;</span>,<span class="number">22.22</span>,<span class="string">&#x27;2018&#x27;</span>), </span><br><span class="line">  (<span class="number">1001</span>,<span class="string">&#x27;路人甲Java&#x27;</span>,<span class="number">88.88</span>,<span class="string">&#x27;2018&#x27;</span>), </span><br><span class="line">  (<span class="number">1002</span>,<span class="string">&#x27;刘德华&#x27;</span>,<span class="number">33.33</span>,<span class="string">&#x27;2018&#x27;</span>), </span><br><span class="line">  (<span class="number">1002</span>,<span class="string">&#x27;刘德华&#x27;</span>,<span class="number">12.22</span>,<span class="string">&#x27;2018&#x27;</span>), </span><br><span class="line">  (<span class="number">1002</span>,<span class="string">&#x27;刘德华&#x27;</span>,<span class="number">16.66</span>,<span class="string">&#x27;2018&#x27;</span>), </span><br><span class="line">  (<span class="number">1002</span>,<span class="string">&#x27;刘德华&#x27;</span>,<span class="number">44.44</span>,<span class="string">&#x27;2019&#x27;</span>), </span><br><span class="line">  (<span class="number">1003</span>,<span class="string">&#x27;张学友&#x27;</span>,<span class="number">55.55</span>,<span class="string">&#x27;2018&#x27;</span>), </span><br><span class="line">  (<span class="number">1003</span>,<span class="string">&#x27;张学友&#x27;</span>,<span class="number">66.66</span>,<span class="string">&#x27;2019&#x27;</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 单字段分组</span></span><br><span class="line"><span class="comment">-- 需求：查询每个用户下单数量，输出：用户id、下单数量，如下：</span></span><br><span class="line"><span class="keyword">SELECT</span> user_id 用户id, <span class="built_in">COUNT</span>(id) 下单数量 <span class="keyword">FROM</span> t_order <span class="keyword">GROUP</span> <span class="keyword">BY</span> user_id;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------+----------+</span></span><br><span class="line"><span class="operator">|</span> 用户id <span class="operator">|</span> 下单数量 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+----------+</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">1001</span> <span class="operator">|</span>        <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">1002</span> <span class="operator">|</span>        <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">1003</span> <span class="operator">|</span>        <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+----------+</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 多字段分组</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">user_id 用户id, the_year 年份, <span class="built_in">COUNT</span>(user_id) 下单数量 </span><br><span class="line"><span class="keyword">FROM</span> t_order </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> user_id, the_year;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------+------+----------+</span></span><br><span class="line"><span class="operator">|</span> 用户id <span class="operator">|</span> 年份 <span class="operator">|</span> 下单数量 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+------+----------+</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">1001</span> <span class="operator">|</span> <span class="number">2017</span> <span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">1001</span> <span class="operator">|</span> <span class="number">2018</span> <span class="operator">|</span>        <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">1002</span> <span class="operator">|</span> <span class="number">2018</span> <span class="operator">|</span>        <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">1002</span> <span class="operator">|</span> <span class="number">2019</span> <span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">1003</span> <span class="operator">|</span> <span class="number">2018</span> <span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">1003</span> <span class="operator">|</span> <span class="number">2019</span> <span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+------+----------+</span></span><br></pre></td></tr></table></figure>
<h3 id="where-和-having的区别"><a href="#where-和-having的区别" class="headerlink" title="where 和 having的区别"></a>where 和 having的区别</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- where是在分组前对记录进行筛选，而having是在分组结束后的结果里筛选。</span></span><br><span class="line"><span class="comment">-- 含having的查询操作先获得不含having子句时的sql查询结果表，然后在结果表上使用having筛选出符合的记录，最后返回这些记录。因此，having后是可以跟聚合函数的，并且这个聚集函数不必与select后面的聚集函数相同。</span></span><br></pre></td></tr></table></figure>

<h3 id="分组后排序"><a href="#分组后排序" class="headerlink" title="分组后排序"></a>分组后排序</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> user_id 用户id, <span class="built_in">max</span>(price) 最大金额 </span><br><span class="line"><span class="keyword">FROM</span> t_order t </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> user_id </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> 最大金额 <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>
<h3 id="where-amp-group-by-amp-having-amp-order-by-amp-limit-一起协作"><a href="#where-amp-group-by-amp-having-amp-order-by-amp-limit-一起协作" class="headerlink" title="where &amp; group by &amp; having &amp; order by &amp; limit 一起协作"></a>where &amp; group by &amp; having &amp; order by &amp; limit 一起协作</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> 列 </span><br><span class="line"><span class="keyword">from</span> 表名</span><br><span class="line"><span class="keyword">where</span> [查询条件] </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> [分组表达式]</span><br><span class="line"><span class="keyword">having</span> [分组过滤条件] </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> [排序条件] </span><br><span class="line">limit [<span class="keyword">offset</span>,] count;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">例：查询出<span class="number">2018</span>年，下单数量大于等于<span class="number">2</span>的，按照下单数量降序排序，最后只输出第<span class="number">1</span>条记录，显</span><br><span class="line">示：用户id，下单数量，如下：</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> user_id 用户id, <span class="built_in">COUNT</span>(id) 下单数量</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">from</span> t_order</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">where</span> the_year <span class="operator">=</span> <span class="number">2018</span></span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">group</span> <span class="keyword">by</span> user_id</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">having</span> <span class="built_in">COUNT</span>(id) <span class="operator">&gt;=</span> <span class="number">2</span></span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="built_in">COUNT</span>(id) <span class="keyword">desc</span></span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> limit <span class="number">1</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------+----------+</span></span><br><span class="line"><span class="operator">|</span> 用户id <span class="operator">|</span> 下单数量 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+----------+</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">1002</span> <span class="operator">|</span>        <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+----------+</span></span><br></pre></td></tr></table></figure>
<h3 id="MySQL分组中的坑"><a href="#MySQL分组中的坑" class="headerlink" title="MySQL分组中的坑"></a>MySQL分组中的坑</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">分组中<span class="keyword">select</span>后面的列只能有<span class="number">2</span>种：</span><br><span class="line"><span class="number">1.</span> 出现在<span class="keyword">group</span> <span class="keyword">by</span>后面的列</span><br><span class="line"><span class="number">2.</span> 使用聚合函数的列</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 需求：获取每个用户下单的最大金额及下单的年份，输出：用户id，最大金额，年份，写法如下：</span></span><br><span class="line"><span class="keyword">select</span> user_id 用户id, <span class="built_in">max</span>(price) 最大金额, the_year 年份 <span class="keyword">FROM</span> t_order t <span class="keyword">GROUP</span> <span class="keyword">BY</span> t.user_id;</span><br><span class="line"></span><br><span class="line"><span class="number">1055</span> <span class="operator">-</span> Expression #<span class="number">3</span> <span class="keyword">of</span> <span class="keyword">SELECT</span> list <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> clause <span class="keyword">and</span> <span class="keyword">contains</span> nonaggregated <span class="keyword">column</span> <span class="string">&#x27;mysqlstudy.t.the_year&#x27;</span> which <span class="keyword">is</span> <span class="keyword">not</span> functionally dependent <span class="keyword">on</span> columns <span class="keyword">in</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> clause; this <span class="keyword">is</span> incompatible <span class="keyword">with</span> sql_mode<span class="operator">=</span>only_full_group_by</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 上面的sql报错了，原因因为 the_year 不符合上面说的2条规则（select后面的列必须出现在group by中或者使用聚合函数），而 sql_mode 限制了这种规则，我们看一下 sql_mode 的配置：</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@sql</span>_mode;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@sql</span>_mode                                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,</span><br><span class="line"> NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,</span><br><span class="line"> NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------+</span></span><br><span class="line"><span class="comment">-- sql_mode中包含了 ONLY_FULL_GROUP_BY ，这个表示select后面的列必须符合上面的说的2点规范。</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 可以将 ONLY_FULL_GROUP_BY 去掉，select后面就可以加任意列了，我们来看一下效果。</span></span><br><span class="line"><span class="comment">-- 修改mysql中的 my.ini 文件：</span></span><br><span class="line">sql_mode<span class="operator">=</span>STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 重启mysql，再次运行，效果如下：</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> user_id 用户id, <span class="built_in">max</span>(price) 最大金额, the_year 年份 </span><br><span class="line">		<span class="keyword">FROM</span> t_order t </span><br><span class="line">		<span class="keyword">GROUP</span> <span class="keyword">BY</span> t.user_id; </span><br><span class="line"><span class="operator">+</span><span class="comment">----------+--------------+--------+ </span></span><br><span class="line"><span class="operator">|</span> 用户id <span class="operator">|</span> 最大金额 <span class="operator">|</span> 年份 <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">----------+--------------+--------+ </span></span><br><span class="line"><span class="operator">|</span> <span class="number">1001</span> <span class="operator">|</span> <span class="number">88.88</span> <span class="operator">|</span> <span class="number">2017</span> <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span> <span class="number">1002</span> <span class="operator">|</span> <span class="number">44.44</span> <span class="operator">|</span> <span class="number">2018</span> <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span> <span class="number">1003</span> <span class="operator">|</span> <span class="number">66.66</span> <span class="operator">|</span> <span class="number">2018</span> <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">----------+--------------+--------+</span></span><br><span class="line"><span class="comment">-- 看一下上面的数据，第一条 88.88 的年份是 2017 年，而原始数据是2018年，mysql对这种未按照规范来的列，乱序了，mysql取的是第一条。</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正确的写法，提供两种，如下：</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> user_id 用户id, price 最大金额, the_year 年份 </span><br><span class="line">		<span class="keyword">FROM</span> t_order t1 </span><br><span class="line">		<span class="keyword">WHERE</span> (t1.user_id , t1.price) <span class="keyword">IN</span> </span><br><span class="line">				(<span class="keyword">SELECT</span> t.user_id, <span class="built_in">MAX</span>(t.price) <span class="keyword">FROM</span> t_order t <span class="keyword">GROUP</span> <span class="keyword">BY</span> t.user_id);</span><br><span class="line"><span class="operator">+</span><span class="comment">--------+----------+------+</span></span><br><span class="line"><span class="operator">|</span> 用户id <span class="operator">|</span> 最大金额 <span class="operator">|</span> 年份 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+----------+------+</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">1001</span> <span class="operator">|</span> <span class="number">88.88</span>    <span class="operator">|</span> <span class="number">2018</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">1002</span> <span class="operator">|</span> <span class="number">44.44</span>    <span class="operator">|</span> <span class="number">2019</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">1003</span> <span class="operator">|</span> <span class="number">66.66</span>    <span class="operator">|</span> <span class="number">2019</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+----------+------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.09</span> sec)</span><br><span class="line"><span class="comment">-- 该写法比较少见， in 中使用了多字段查询。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> user_id 用户id, price 最大金额, the_year 年份 </span><br><span class="line"><span class="keyword">FROM</span> t_order t1, (<span class="keyword">SELECT</span> t.user_id uid, <span class="built_in">MAX</span>(t.price) pc <span class="keyword">FROM</span> t_order t <span class="keyword">GROUP</span> <span class="keyword">BY</span> t.user_id) t2 <span class="keyword">WHERE</span> t1.user_id <span class="operator">=</span> t2.uid <span class="keyword">AND</span> t1.price <span class="operator">=</span> t2.pc;</span><br></pre></td></tr></table></figure>
<ul>
<li>建议：在写分组查询的时候，按照规范来写，select后面出现的列必须在group by中或者必须使用聚合函数。</li>
</ul>
<h2 id="第10篇：常用函数"><a href="#第10篇：常用函数" class="headerlink" title="第10篇：常用函数"></a>第10篇：常用函数</h2><h3 id="MySQL-数值型函数"><a href="#MySQL-数值型函数" class="headerlink" title="MySQL 数值型函数"></a>MySQL 数值型函数</h3><p><img src="/2021/01/24/MySQL%E6%95%B4%E7%90%86/12.png" alt="12"></p>
<h3 id="MySQL-字符串函数"><a href="#MySQL-字符串函数" class="headerlink" title="MySQL 字符串函数"></a>MySQL 字符串函数</h3><p><img src="/2021/01/24/MySQL%E6%95%B4%E7%90%86/14.png" alt="14"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- length:返回字符串直接长度</span></span><br><span class="line">返回值为字符串的字节长度，使用 uft8编码字符集时，一个汉字是 <span class="number">3</span> 个字节，一个数字或字母是一个字节。</span><br><span class="line"></span><br><span class="line"><span class="comment">-- concat:合并字符串</span></span><br><span class="line">CONCAT(sl，s2，...) 函数返回结果为连接参数产生的字符串，或许有一个或多个参数。</span><br><span class="line">若有任何一个参数为 <span class="keyword">NULL</span>，则返回值为 <span class="keyword">NULL</span>。</span><br><span class="line">若所有参数均为非二进制字符串，则结果为非二进制字符串。</span><br><span class="line">若变量中含有任一二进制字符串，则结果为一个二进制字符串。</span><br><span class="line"></span><br><span class="line"><span class="comment">-- insert:替换字符串</span></span><br><span class="line"><span class="keyword">INSERT</span>(s1，x，len，s2) 返回字符串 s1，子字符串起始于 x 位置，并且用 len 个字符长的字符串代替 s2。 </span><br><span class="line">x的值从<span class="number">1</span>开始，第一个字符的x<span class="operator">=</span><span class="number">1</span>，若 x 超过字符串长度，则返回值为原始字符串。</span><br><span class="line">假如 len 的长度大于其他字符串的长度，则从位置 x 开始替换。</span><br><span class="line">若任何一个参数为 <span class="keyword">NULL</span>，则返回值为 <span class="keyword">NULL</span>。</span><br><span class="line"></span><br><span class="line"><span class="comment">-- left:从左侧截取字符串</span></span><br><span class="line"><span class="keyword">LEFT</span>(s，n) 函数返回字符串 s 最左边的 n 个字符，s<span class="operator">=</span><span class="number">1</span>表示第一个字符。</span><br><span class="line"></span><br><span class="line"><span class="comment">-- right:从右侧截取字符串</span></span><br><span class="line"><span class="keyword">RIGHT</span>(s，n) 函数返回字符串 s 最右边的 n 个字符。</span><br><span class="line"></span><br><span class="line"><span class="comment">-- replace:字符串替换</span></span><br><span class="line">REPLACE(s，s1，s2) 使用字符串 s2 替换字符串 s 中所有的字符串 s1。</span><br><span class="line"></span><br><span class="line"><span class="comment">-- substr 和 substring:截取字符串</span></span><br><span class="line">substr(str,pos)</span><br><span class="line">substr(str <span class="keyword">from</span> pos)</span><br><span class="line">substr(str,pos,len)</span><br><span class="line">substr(str <span class="keyword">from</span> pos <span class="keyword">for</span> len)</span><br><span class="line">substr()是<span class="built_in">substring</span>()的同义词。</span><br><span class="line">没有len参数的形式是字符串str从位置pos开始返回一个子字符串。</span><br><span class="line">带有len参数的形式是字符串str从位置pos开始返回长度为len的子字符串。</span><br><span class="line">使用<span class="keyword">FROM</span>的形式是标准的<span class="keyword">SQL</span>语法。</span><br><span class="line">也可以对pos使用负值，在这种情况下，子字符串的开头是字符串末尾的pos字符，而不是开头。</span><br><span class="line">在这个函数的任何形式中pos可以使用负值。</span><br><span class="line">对于所有形式的<span class="built_in">substring</span>()，从中提取子串的字符串中第一个字符的位置被认为是<span class="number">1</span>。</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 第三个字符之后的子字符串：inese **/</span> </span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">substring</span>(<span class="string">&#x27;chinese&#x27;</span>, <span class="number">3</span>); </span><br><span class="line"><span class="comment">/** 倒数第三个字符之后的子字符串：ese **/</span> </span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">substring</span>(<span class="string">&#x27;chinese&#x27;</span>, <span class="number">-3</span>); </span><br><span class="line"><span class="comment">/** 第三个字符之后的两个字符：in **/</span> </span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">substring</span>(<span class="string">&#x27;chinese&#x27;</span>, <span class="number">3</span>, <span class="number">2</span>); </span><br><span class="line"><span class="comment">/** 倒数第三个字符之后的两个字符：es **/</span> </span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">substring</span>(<span class="string">&#x27;chinese&#x27;</span>, <span class="number">-3</span>, <span class="number">2</span>); </span><br><span class="line"><span class="comment">/** 第三个字符之后的子字符串：inese **/</span> </span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">substring</span>(<span class="string">&#x27;chinese&#x27;</span> <span class="keyword">FROM</span> <span class="number">3</span>); </span><br><span class="line"><span class="comment">/** 倒数第三个字符之后的子字符串：ese **/</span> </span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">substring</span>(<span class="string">&#x27;chinese&#x27;</span> <span class="keyword">FROM</span> <span class="number">-3</span>); </span><br><span class="line"><span class="comment">/** 第三个字符之后的两个字符：in **/</span> </span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">substring</span>(<span class="string">&#x27;chinese&#x27;</span> <span class="keyword">FROM</span> <span class="number">3</span> <span class="keyword">FOR</span> <span class="number">2</span>); </span><br><span class="line"><span class="comment">/** 倒数第三个字符之后的两个字符：es **/</span> </span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">substring</span>(<span class="string">&#x27;chinese&#x27;</span> <span class="keyword">FROM</span> <span class="number">-3</span> <span class="keyword">FOR</span> <span class="number">2</span>);</span><br></pre></td></tr></table></figure>
<h3 id="MySQL-日期和时间函数"><a href="#MySQL-日期和时间函数" class="headerlink" title="MySQL 日期和时间函数"></a>MySQL 日期和时间函数</h3><p><img src="/2021/01/24/MySQL%E6%95%B4%E7%90%86/15.png" alt="15"></p>
<p><img src="/2021/01/24/MySQL%E6%95%B4%E7%90%86/16.png" alt="16"></p>
<h3 id="MySQL-聚合函数-略"><a href="#MySQL-聚合函数-略" class="headerlink" title="MySQL 聚合函数 略"></a>MySQL 聚合函数 略</h3><h3 id="MySQL-流程控制函数"><a href="#MySQL-流程控制函数" class="headerlink" title="MySQL 流程控制函数"></a>MySQL 流程控制函数</h3><p><img src="/2021/01/24/MySQL%E6%95%B4%E7%90%86/18.png" alt="18"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span>  <span class="keyword">select</span> if(<span class="number">1</span> <span class="operator">&lt;</span> <span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>) c1,if(<span class="number">1</span> <span class="operator">&gt;</span> <span class="number">5</span>, <span class="string">&#x27;√&#x27;</span>, <span class="string">&#x27;×&#x27;</span>) c2,if(strcmp(<span class="string">&#x27;abc&#x27;</span>,<span class="string">&#x27;ab&#x27;</span>),<span class="string">&#x27;yes&#x27;</span>,<span class="string">&#x27;no&#x27;</span>) c3;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+----+-----+</span></span><br><span class="line"><span class="operator">|</span> c1 <span class="operator">|</span> c2 <span class="operator">|</span> c3  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+----+-----+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> ×  <span class="operator">|</span> yes <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+----+-----+</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> ifnull(<span class="keyword">null</span>,<span class="string">&#x27;路人甲Java&#x27;</span>),ifnull(<span class="string">&#x27;非空&#x27;</span>,<span class="string">&#x27;为空&#x27;</span>);</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+-----------------------+</span></span><br><span class="line"><span class="operator">|</span> ifnull(<span class="keyword">null</span>,<span class="string">&#x27;路人甲Java&#x27;</span>) <span class="operator">|</span> ifnull(<span class="string">&#x27;非空&#x27;</span>,<span class="string">&#x27;为空&#x27;</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+-----------------------+</span></span><br><span class="line"><span class="operator">|</span> 路人甲Java                <span class="operator">|</span> 非空                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+-----------------------+</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CASE</span> <span class="operator">&lt;</span>表达式<span class="operator">&gt;</span> </span><br><span class="line">	<span class="keyword">WHEN</span> <span class="operator">&lt;</span>值<span class="number">1</span><span class="operator">&gt;</span> <span class="keyword">THEN</span> <span class="operator">&lt;</span>操作<span class="operator">&gt;</span> </span><br><span class="line">	<span class="keyword">WHEN</span> <span class="operator">&lt;</span>值<span class="number">2</span><span class="operator">&gt;</span> <span class="keyword">THEN</span> <span class="operator">&lt;</span>操作<span class="operator">&gt;</span></span><br><span class="line">    ... </span><br><span class="line">	<span class="keyword">ELSE</span> <span class="operator">&lt;</span>操作<span class="operator">&gt;</span> </span><br><span class="line"><span class="keyword">END</span> <span class="keyword">CASE</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CASE</span></span><br><span class="line">	<span class="keyword">WHEN</span> <span class="operator">&lt;</span>条件<span class="number">1</span><span class="operator">&gt;</span> <span class="keyword">THEN</span> <span class="operator">&lt;</span>命令<span class="operator">&gt;</span> </span><br><span class="line">	<span class="keyword">WHEN</span> <span class="operator">&lt;</span>条件<span class="number">2</span><span class="operator">&gt;</span> <span class="keyword">THEN</span> <span class="operator">&lt;</span>命令<span class="operator">&gt;</span> </span><br><span class="line">	... </span><br><span class="line">	<span class="keyword">ELSE</span> commands </span><br><span class="line"><span class="keyword">END</span> <span class="keyword">CASE</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 例：</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t_stu ( </span><br><span class="line">  id <span class="type">INT</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;编号&#x27;</span>, </span><br><span class="line">  name <span class="type">VARCHAR</span>(<span class="number">10</span>) COMMENT <span class="string">&#x27;姓名&#x27;</span>, </span><br><span class="line">  sex TINYINT COMMENT <span class="string">&#x27;性别,0:未知,1:男,2:女&#x27;</span>, </span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (id) </span><br><span class="line">) COMMENT <span class="string">&#x27;学生表&#x27;</span>; </span><br><span class="line">  </span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_stu (name,sex) <span class="keyword">VALUES</span> (<span class="string">&#x27;张学友&#x27;</span>,<span class="number">1</span>), (<span class="string">&#x27;刘德华&#x27;</span>,<span class="number">1</span>), </span><br><span class="line">								 (<span class="string">&#x27;郭富城&#x27;</span>,<span class="number">1</span>), (<span class="string">&#x27;蔡依林&#x27;</span>,<span class="number">2</span>), (<span class="string">&#x27;xxx&#x27;</span>,<span class="number">0</span>);</span><br><span class="line">			</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> name, (<span class="keyword">CASE</span> sex <span class="keyword">WHEN</span> <span class="number">1</span> <span class="keyword">THEN</span> <span class="string">&#x27;男&#x27;</span> <span class="keyword">WHEN</span> <span class="number">2</span> <span class="keyword">THEN</span> <span class="string">&#x27;女&#x27;</span> <span class="keyword">ELSE</span> <span class="string">&#x27;未知&#x27;</span> <span class="keyword">END</span>) sex <span class="keyword">FROM</span> t_stu;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------+------+</span></span><br><span class="line"><span class="operator">|</span> name   <span class="operator">|</span> sex  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+------+</span></span><br><span class="line"><span class="operator">|</span> 张学友 <span class="operator">|</span> 男   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 刘德华 <span class="operator">|</span> 男   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 郭富城 <span class="operator">|</span> 男   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 蔡依林 <span class="operator">|</span> 女   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> xxx    <span class="operator">|</span> 未知 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+------+</span></span><br></pre></td></tr></table></figure>
<h3 id="其他函数"><a href="#其他函数" class="headerlink" title="其他函数"></a>其他函数</h3><p><img src="/2021/01/24/MySQL%E6%95%B4%E7%90%86/19.png" alt="19"></p>
<h2 id="第11篇：深入了解连接查询及原理"><a href="#第11篇：深入了解连接查询及原理" class="headerlink" title="第11篇：深入了解连接查询及原理"></a>第11篇：深入了解连接查询及原理</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> t_team; </span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t_team( </span><br><span class="line">  id <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> AUTO_INCREMENT <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> comment <span class="string">&#x27;组id&#x27;</span>, </span><br><span class="line">  team_name <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">default</span> <span class="string">&#x27;&#x27;</span> comment <span class="string">&#x27;名称&#x27;</span> </span><br><span class="line">) comment <span class="string">&#x27;组表&#x27;</span>; </span><br><span class="line"></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> t_employee; </span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t_employee( </span><br><span class="line">  id <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> AUTO_INCREMENT <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> comment <span class="string">&#x27;部门id&#x27;</span>, </span><br><span class="line">  emp_name <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">default</span> <span class="string">&#x27;&#x27;</span> comment <span class="string">&#x27;员工名称&#x27;</span>, </span><br><span class="line">  team_id <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">default</span> <span class="number">0</span> comment <span class="string">&#x27;员工所在组id&#x27;</span> </span><br><span class="line">) comment <span class="string">&#x27;员工表表&#x27;</span>; </span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_team <span class="keyword">values</span> (<span class="number">1</span>,<span class="string">&#x27;架构组&#x27;</span>),(<span class="number">2</span>,<span class="string">&#x27;测试组&#x27;</span>),(<span class="number">3</span>,<span class="string">&#x27;java组&#x27;</span>),(<span class="number">4</span>,<span class="string">&#x27;前端组&#x27;</span>); </span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_employee <span class="keyword">values</span> (<span class="number">1</span>,<span class="string">&#x27;路人甲Java&#x27;</span>,<span class="number">1</span>),(<span class="number">2</span>,<span class="string">&#x27;张三&#x27;</span>,<span class="number">2</span>),(<span class="number">3</span>,<span class="string">&#x27;李四&#x27;</span>,<span class="number">3</span>),(<span class="number">4</span>,<span class="string">&#x27;王 五&#x27;</span>,<span class="number">0</span>),</span><br><span class="line">(<span class="number">5</span>,<span class="string">&#x27;赵六&#x27;</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_team;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> team_name <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> 架构组    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> 测试组    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> java组    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">4</span> <span class="operator">|</span> 前端组    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------+</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_employee;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+------------+---------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> emp_name   <span class="operator">|</span> team_id <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------------+---------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> 路人甲Java <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> 张三       <span class="operator">|</span>       <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> 李四       <span class="operator">|</span>       <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">4</span> <span class="operator">|</span> 王 五      <span class="operator">|</span>       <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">5</span> <span class="operator">|</span> 赵六       <span class="operator">|</span>       <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------------+---------+</span></span><br></pre></td></tr></table></figure>
<h3 id="笛卡尔积"><a href="#笛卡尔积" class="headerlink" title="笛卡尔积"></a>笛卡尔积</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 有集合A和B，笛卡尔积表示A集合中的元素和B集合中的元素任意相互关联产生的所有可能的结果。</span></span><br><span class="line"><span class="comment">-- 假如A中有m个元素，B中有n个元素，A、B笛卡尔积产生的结果有m x n个结果，相当于循环遍历两个集合中的元素，任意组合。过程：拿A集合中的第1行，去匹配集合B中所有的行，然后再拿集合A中的第2行，去匹配集合B中所有的行，最后结果数量为m x n。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- sql 中笛卡尔积的写法</span></span><br><span class="line"><span class="keyword">select</span> 字段 <span class="keyword">from</span> 表<span class="number">1</span>,表<span class="number">2</span>[,表N]; </span><br><span class="line">或者</span><br><span class="line"><span class="keyword">select</span> 字段 <span class="keyword">from</span> 表<span class="number">1</span> <span class="keyword">join</span> 表<span class="number">2</span> [<span class="keyword">join</span> 表N];</span><br></pre></td></tr></table></figure>
<h3 id="内连接"><a href="#内连接" class="headerlink" title="内连接"></a>内连接</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> 字段 <span class="keyword">from</span> 表<span class="number">1</span> <span class="keyword">inner</span> <span class="keyword">join</span> 表<span class="number">2</span> <span class="keyword">on</span> 连接条件; </span><br><span class="line">或</span><br><span class="line"><span class="keyword">select</span> 字段 <span class="keyword">from</span> 表<span class="number">1</span> <span class="keyword">join</span> 表<span class="number">2</span> <span class="keyword">on</span> 连接条件;</span><br><span class="line">或</span><br><span class="line"><span class="keyword">select</span> 字段 <span class="keyword">from</span> 表<span class="number">1</span>, 表<span class="number">2</span> [<span class="keyword">where</span> 关联条件];</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 内连接相当于在笛卡尔积的基础上加上了连接的条件。</span></span><br><span class="line"><span class="comment">-- 当没有连接条件的时候，内连接上升为笛卡尔积。</span></span><br><span class="line"><span class="comment">-- 总结</span></span><br><span class="line"><span class="comment">-- 内连接建议使用第3种语法，简洁：</span></span><br><span class="line"><span class="keyword">select</span> 字段 <span class="keyword">from</span> 表<span class="number">1</span>, 表<span class="number">2</span> [<span class="keyword">where</span> 关联条件];</span><br></pre></td></tr></table></figure>

<p>###外连接</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 外连接涉及到2个表，分为：主表和从表，要查询的信息主要来自于哪个表，谁就是主表。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 外连接查询结果为主表中所有记录。如果从表中有和它匹配的，则显示匹配的值，这部分相当于内连接查询出来的结果；如果从表中没有和它匹配的，则显示null。最终：外连接查询结果 = 内连接的结果 + 主表中有的而内连接结果中没有的记录。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 外连接分为2种：</span></span><br><span class="line">左外链接：使用<span class="keyword">left</span> <span class="keyword">join</span>关键字，<span class="keyword">left</span> <span class="keyword">join</span>左边的是主表。</span><br><span class="line">右外连接：使用<span class="keyword">right</span> <span class="keyword">join</span>关键字，<span class="keyword">right</span> <span class="keyword">join</span>右边的是主表。</span><br></pre></td></tr></table></figure>
<h4 id="左连接"><a href="#左连接" class="headerlink" title="左连接"></a>左连接</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> 列 <span class="keyword">from</span> 主表 <span class="keyword">left</span> <span class="keyword">join</span> 从表 <span class="keyword">on</span> 连接条件;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询所有员工信息，并显示员工所在组，如下:</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_employee te <span class="keyword">left</span> <span class="keyword">join</span> t_team tt <span class="keyword">on</span> te.team_id <span class="operator">=</span> tt.id;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+------------+---------+------+-----------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> emp_name   <span class="operator">|</span> team_id <span class="operator">|</span> id   <span class="operator">|</span> team_name <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------------+---------+------+-----------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> 路人甲Java <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> 架构组    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> 张三       <span class="operator">|</span>       <span class="number">2</span> <span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span> 测试组    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> 李四       <span class="operator">|</span>       <span class="number">3</span> <span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span> java组    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">4</span> <span class="operator">|</span> 王 五      <span class="operator">|</span>       <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">5</span> <span class="operator">|</span> 赵六       <span class="operator">|</span>       <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------------+---------+------+-----------+</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询员工信息，返回组名不为空的记录，如下：（左表独有）</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_employee te <span class="keyword">left</span> <span class="keyword">join</span> t_team tt <span class="keyword">on</span> te.team_id <span class="operator">=</span> tt.id <span class="keyword">where</span> tt.id <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+------------+---------+----+-----------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> emp_name   <span class="operator">|</span> team_id <span class="operator">|</span> id <span class="operator">|</span> team_name <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------------+---------+----+-----------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> 路人甲Java <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> 架构组    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> 张三       <span class="operator">|</span>       <span class="number">2</span> <span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> 测试组    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> 李四       <span class="operator">|</span>       <span class="number">3</span> <span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> java组    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------------+---------+----+-----------+</span></span><br></pre></td></tr></table></figure>
<h4 id="右连接"><a href="#右连接" class="headerlink" title="右连接"></a>右连接</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> 列 <span class="keyword">from</span> 从表 <span class="keyword">right</span> <span class="keyword">join</span> 主表 <span class="keyword">on</span> 连接条件;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 上面两个sql语句 使用右连接的方式</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_team tt <span class="keyword">right</span> <span class="keyword">join</span> t_employee te <span class="keyword">on</span> te.team_id <span class="operator">=</span> tt.id;</span><br><span class="line"><span class="comment">-- 右表独有</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_team tt <span class="keyword">right</span> <span class="keyword">join</span> t_employee te <span class="keyword">on</span> te.team_id <span class="operator">=</span> tt.id <span class="keyword">where</span> tt.id <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>
<h3 id="全连接"><a href="#全连接" class="headerlink" title="全连接"></a>全连接</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 全连接</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_employee te <span class="keyword">left</span> <span class="keyword">join</span> t_team tt <span class="keyword">on</span> te.team_id <span class="operator">=</span> tt.id</span><br><span class="line"><span class="keyword">union</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_employee te <span class="keyword">right</span> <span class="keyword">join</span> t_team tt <span class="keyword">on</span> te.team_id <span class="operator">=</span> tt.id;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+------------+---------+------+-----------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span> emp_name   <span class="operator">|</span> team_id <span class="operator">|</span> id   <span class="operator">|</span> team_name <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+------------+---------+------+-----------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> 路人甲Java <span class="operator">|</span>       <span class="number">1</span> <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> 架构组    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span> 张三       <span class="operator">|</span>       <span class="number">2</span> <span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span> 测试组    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span> 李四       <span class="operator">|</span>       <span class="number">3</span> <span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span> java组    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">4</span> <span class="operator">|</span> 王 五      <span class="operator">|</span>       <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">5</span> <span class="operator">|</span> 赵六       <span class="operator">|</span>       <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>    <span class="number">4</span> <span class="operator">|</span> 前端组    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+------------+---------+------+-----------+</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 全连接去交集</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_employee te <span class="keyword">left</span> <span class="keyword">join</span> t_team tt <span class="keyword">on</span> te.team_id <span class="operator">=</span> tt.id <span class="keyword">where</span> tt.id <span class="keyword">is</span> <span class="keyword">null</span></span><br><span class="line"><span class="keyword">union</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_employee te <span class="keyword">right</span> <span class="keyword">join</span> t_team tt <span class="keyword">on</span> te.team_id <span class="operator">=</span> tt.id <span class="keyword">where</span> te.id <span class="keyword">is</span> <span class="keyword">null</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+----------+---------+------+-----------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span> emp_name <span class="operator">|</span> team_id <span class="operator">|</span> id   <span class="operator">|</span> team_name <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+----------+---------+------+-----------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">4</span> <span class="operator">|</span> 王 五    <span class="operator">|</span>       <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">5</span> <span class="operator">|</span> 赵六     <span class="operator">|</span>       <span class="number">0</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>    <span class="number">4</span> <span class="operator">|</span> 前端组    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+----------+---------+------+-----------+</span></span><br></pre></td></tr></table></figure>
<p>表连接中还可以使用 group by 、having 、order by 、limit ，这些关键字相当于在表连接的结果上进行操作。</p>
<h2 id="第12篇：子查询"><a href="#第12篇：子查询" class="headerlink" title="第12篇：子查询"></a>第12篇：子查询</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">出现在<span class="keyword">select</span>语句中的<span class="keyword">select</span>语句，称为子查询或内查询。外部的<span class="keyword">select</span>查询语句，称为主查询或外查询。</span><br><span class="line">子查询的执行优先于主查询执行，因为主查询的条件用到了子查询的结果。</span><br><span class="line"><span class="comment">-- 子查询分类</span></span><br><span class="line">按结果集的行列数不同分为<span class="number">4</span>种</span><br><span class="line"><span class="number">1.</span> 标量子查询（结果集只有一行一列）</span><br><span class="line"><span class="number">2.</span> 列子查询（结果集只有一列多行）</span><br><span class="line"><span class="number">3.</span> 行子查询（结果集有一行多列）</span><br><span class="line"><span class="number">4.</span> 表子查询（结果集一般为多行多列）</span><br><span class="line"></span><br><span class="line">按子查询出现在主查询中的不同位置分类</span><br><span class="line"><span class="number">1.</span> <span class="keyword">select</span>后面：仅仅支持标量子查询。</span><br><span class="line"><span class="number">2.</span> <span class="keyword">from</span>后面：支持表子查询。</span><br><span class="line"><span class="number">3.</span> <span class="keyword">where</span> 或 <span class="keyword">having</span>后面：支持标量子查询（单列单行）、列子查询（单列多行）、行子查询（多列单行）</span><br><span class="line"><span class="number">4.</span> <span class="keyword">exists</span> 后面（即相关子查询）：表子查询（多行、多列）</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="http://www.itsoku.com/article/209">准备测试数据</a></p>
<h3 id="select后面的子查询"><a href="#select后面的子查询" class="headerlink" title="select后面的子查询"></a>select后面的子查询</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询每个部门员工个数</span></span><br><span class="line"><span class="keyword">select</span> d.<span class="operator">*</span>,</span><br><span class="line">(<span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> employees e <span class="keyword">where</span> e.department_id <span class="operator">=</span> d.department_id) <span class="keyword">as</span> 员工个数</span><br><span class="line"><span class="keyword">from</span> departments d</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询员工号=102的部门名称</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">(<span class="keyword">select</span> d.department_name</span><br><span class="line"><span class="keyword">from</span> departments d, employees e</span><br><span class="line"><span class="keyword">where</span> d.department_id <span class="operator">=</span> e.department_id <span class="keyword">and</span> e.employee_id <span class="operator">=</span> <span class="number">102</span>) <span class="keyword">as</span> 部门名</span><br></pre></td></tr></table></figure>
<h3 id="from后面的子查询"><a href="#from后面的子查询" class="headerlink" title="from后面的子查询"></a>from后面的子查询</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 将子查询的结果集充当一张表，要求必须起别名。然后将真实的表和子查询结果表进行连接查询。</span></span><br><span class="line"><span class="comment">-- 查询每个部门平均工资的工资等级</span></span><br><span class="line"><span class="keyword">select</span> t1.<span class="operator">*</span>, j.grade_level</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">(<span class="keyword">select</span> e.department_id <span class="keyword">as</span> did, <span class="built_in">avg</span>(e.salary) <span class="keyword">as</span> sal <span class="keyword">from</span> employees e</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> did) t1, job_grades j</span><br><span class="line"><span class="keyword">where</span> t1.sal <span class="keyword">between</span> j.lowest_sal <span class="keyword">and</span> j.highest_sal;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">------+--------------+-------------+</span></span><br><span class="line"><span class="operator">|</span> did  <span class="operator">|</span> sal          <span class="operator">|</span> grade_level <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+--------------+-------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>  <span class="number">7000.000000</span> <span class="operator">|</span> C           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">10</span> <span class="operator">|</span>  <span class="number">4400.000000</span> <span class="operator">|</span> B           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">20</span> <span class="operator">|</span>  <span class="number">9500.000000</span> <span class="operator">|</span> C           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>  <span class="number">4150.000000</span> <span class="operator">|</span> B           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">40</span> <span class="operator">|</span>  <span class="number">6500.000000</span> <span class="operator">|</span> C           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">50</span> <span class="operator">|</span>  <span class="number">3475.555556</span> <span class="operator">|</span> B           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">60</span> <span class="operator">|</span>  <span class="number">5760.000000</span> <span class="operator">|</span> B           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">70</span> <span class="operator">|</span> <span class="number">10000.000000</span> <span class="operator">|</span> D           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">80</span> <span class="operator">|</span>  <span class="number">8955.882353</span> <span class="operator">|</span> C           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">90</span> <span class="operator">|</span> <span class="number">19333.333333</span> <span class="operator">|</span> E           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">100</span> <span class="operator">|</span>  <span class="number">8600.000000</span> <span class="operator">|</span> C           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">110</span> <span class="operator">|</span> <span class="number">10150.000000</span> <span class="operator">|</span> D           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+--------------+-------------+</span></span><br></pre></td></tr></table></figure>
<h3 id="where和having后面的子查询"><a href="#where和having后面的子查询" class="headerlink" title="where和having后面的子查询"></a>where和having后面的子查询</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- where或having后可以使用</span></span><br><span class="line"><span class="number">1.</span> 标量子查询（单行单列）</span><br><span class="line"><span class="number">2.</span> 列子查询（单列多行）</span><br><span class="line"><span class="number">3.</span> 行子查询（一行多列）</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 特点</span></span><br><span class="line"><span class="number">1.</span> 子查询放在小括号内。</span><br><span class="line"><span class="number">2.</span> 子查询一般放在条件的右侧。</span><br><span class="line"><span class="number">3.</span> 标量子查询，一般搭配着单行单列操作符使用 <span class="operator">&gt;</span>、<span class="operator">&lt;</span>、<span class="operator">&gt;=</span>、<span class="operator">&lt;=</span>、<span class="operator">=</span>、<span class="operator">&lt;&gt;</span>、<span class="operator">!=</span></span><br><span class="line"><span class="number">4.</span> 列子查询，一般搭配着多行操作符使用</span><br><span class="line"></span><br><span class="line"><span class="comment">-- in，any，some，all 分别是子查询关键词之一。</span></span><br><span class="line"><span class="comment">-- in：in 常用于where表达式中，其作用是查询某个范围内的数据</span></span><br><span class="line"><span class="comment">-- any 和 some 一样： 可以与=、&gt;、&gt;=、&lt;、&lt;=、&lt;&gt;结合起来使用，分别表示等于、大于、大于等于、小于、小于等于、不等于其中的任何一个数据。</span></span><br><span class="line"><span class="comment">-- all：可以与=、&gt;、&gt;=、&lt;、&lt;=、&lt;&gt;结合是来使用，分别表示等于、大于、大于等于、小于、小于等于、不等于其中的其中的所有数据。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- any或者some：和子查询返回的某一个值比较，比如a &gt; some (10,20,30)，a大于子查询中任意一个即可，a大于子查询中最小值即可，等同于 a &gt; min (10,20,30)。</span></span><br><span class="line"><span class="comment">-- all：和子查询返回的所有值比较，比如a &gt; all (10,20,30)，a大于子查询中所有值，换句话说，a大于子查询中最大值即可满足查询条件，等同于 a &gt; max (10,20,30)。</span></span><br></pre></td></tr></table></figure>
<h4 id="标量子查询"><a href="#标量子查询" class="headerlink" title="标量子查询"></a>标量子查询</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询谁的工资比Abel的高？ 多个标量子查询也类似</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> employees <span class="keyword">where</span> salary <span class="operator">&gt;</span> (<span class="keyword">select</span> salary <span class="keyword">from</span> employees <span class="keyword">where</span> last_name <span class="operator">=</span> <span class="string">&#x27;Abel&#x27;</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 子查询+分组函数 : 查询最低工资大于50号部门最低工资的部门id和其最低工资【having】</span></span><br><span class="line"><span class="keyword">select</span> department_id did, <span class="built_in">min</span>(salary) sal</span><br><span class="line"><span class="keyword">from</span> employees</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> did</span><br><span class="line"><span class="keyword">having</span> sal <span class="operator">&gt;</span> (<span class="keyword">select</span> <span class="built_in">min</span>(salary) <span class="keyword">from</span> employees <span class="keyword">where</span> department_id <span class="operator">=</span> <span class="number">50</span>);</span><br></pre></td></tr></table></figure>
<h4 id="列子查询-子查询结果集一列多行"><a href="#列子查询-子查询结果集一列多行" class="headerlink" title="列子查询(子查询结果集一列多行)"></a>列子查询(子查询结果集一列多行)</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 列子查询需要搭配多行操作符使用：in(not in)、any/some、all。</span></span><br><span class="line"><span class="comment">-- 为了提升效率，最好去重一下distinct关键字。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 返回location_id是1400或1700的部门中的所有员工姓名</span></span><br><span class="line"><span class="keyword">SELECT</span> a.last_name </span><br><span class="line"><span class="keyword">FROM</span> employees a </span><br><span class="line"><span class="keyword">WHERE</span> a.department_id <span class="keyword">IN</span> </span><br><span class="line">	(<span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> department_id <span class="keyword">FROM</span> departments <span class="keyword">WHERE</span> location_id <span class="keyword">IN</span> (<span class="number">1400</span>, <span class="number">1700</span>)); </span><br><span class="line">	</span><br><span class="line"><span class="comment">/*使用any实现*/</span> </span><br><span class="line"><span class="keyword">SELECT</span> a.last_name </span><br><span class="line"><span class="keyword">FROM</span> employees a </span><br><span class="line"><span class="keyword">WHERE</span> a.department_id <span class="operator">=</span> </span><br><span class="line">	<span class="keyword">ANY</span> (<span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> department_id <span class="keyword">FROM</span> departments <span class="keyword">WHERE</span> location_id <span class="keyword">IN</span> (<span class="number">1400</span>, <span class="number">1700</span>)); </span><br></pre></td></tr></table></figure>
<h4 id="行子查询-子查询结果集一行多列）"><a href="#行子查询-子查询结果集一行多列）" class="headerlink" title="行子查询(子查询结果集一行多列）"></a>行子查询(子查询结果集一行多列）</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询员工编号最小并且工资最高的员工信息，3种方式。</span></span><br><span class="line"><span class="comment">-- 方式1</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> employees</span><br><span class="line"><span class="keyword">where</span> employee_id <span class="operator">=</span> (<span class="keyword">select</span> <span class="built_in">min</span>(employee_id) <span class="keyword">from</span> employees)</span><br><span class="line"><span class="keyword">and</span> salary <span class="operator">=</span> (<span class="keyword">select</span> <span class="built_in">max</span>(salary) <span class="keyword">from</span> employees)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方式2</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> employees </span><br><span class="line"><span class="keyword">where</span> (employee_id, salary) <span class="keyword">in</span> </span><br><span class="line">(<span class="keyword">select</span> <span class="built_in">min</span>(employee_id), <span class="built_in">max</span>(salary) <span class="keyword">from</span> employees)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方式3</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> employees </span><br><span class="line"><span class="keyword">where</span> (employee_id, salary) <span class="operator">=</span> </span><br><span class="line">(<span class="keyword">select</span> <span class="built_in">min</span>(employee_id), <span class="built_in">max</span>(salary) <span class="keyword">from</span> employees)</span><br></pre></td></tr></table></figure>
<h3 id="exists后面（相关子查询）"><a href="#exists后面（相关子查询）" class="headerlink" title="exists后面（相关子查询）"></a>exists后面（相关子查询）</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 语法：<span class="keyword">exists</span>(完整的查询语句)。 </span><br><span class="line"><span class="number">2.</span> <span class="keyword">exists</span>查询结果：<span class="number">1</span>或<span class="number">0</span>，<span class="keyword">exists</span>查询的结果用来判断子查询的结果集中是否有值。</span><br><span class="line"><span class="number">3.</span> 一般来说，能用<span class="keyword">exists</span>的子查询，绝对都能用<span class="keyword">in</span>代替，所以<span class="keyword">exists</span>用的少。</span><br><span class="line"><span class="number">4.</span> 和前面的查询不同，这先执行主查询，然后主查询查询的结果，在根据子查询进行过滤，子查询中涉及到主查询中用到的字段，所以叫相关子查询。</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 简单示例</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">exists</span>(<span class="keyword">SELECT</span> employee_id <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> salary <span class="operator">=</span> <span class="number">300000</span>) <span class="keyword">AS</span> <span class="string">&#x27;exists返回1或者0&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+ </span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">exists</span>返回<span class="number">1</span>或者<span class="number">0</span>      <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+ </span></span><br><span class="line"><span class="operator">|</span> <span class="number">0</span>                    <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询所有员工的部门名称</span></span><br><span class="line"><span class="keyword">SELECT</span> department_name <span class="keyword">FROM</span> departments a</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">exists</span>(<span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">FROM</span> employees b <span class="keyword">WHERE</span> a.department_id <span class="operator">=</span> b.department_id);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> department_name <span class="keyword">FROM</span> departments </span><br><span class="line"><span class="keyword">WHERE</span> department_id <span class="keyword">IN</span> (<span class="keyword">SELECT</span> department_id <span class="keyword">FROM</span> employees);</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询没有员工的部门</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> departments a </span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">NOT</span> <span class="keyword">exists</span> (<span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">FROM</span> employees b <span class="keyword">WHERE</span> a.department_id <span class="operator">=</span> b.department_id <span class="keyword">AND</span> b.department_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> departments a </span><br><span class="line"><span class="keyword">WHERE</span> a.department_id </span><br><span class="line"><span class="keyword">NOT</span> <span class="keyword">IN</span> (<span class="keyword">SELECT</span> department_id <span class="keyword">FROM</span> employees b <span class="keyword">WHERE</span> b.department_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* WHERE b.department_id IS NOT NULL 不能省略</span></span><br><span class="line"><span class="comment">* 以下sql 查询结果为empty set</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> departments a </span><br><span class="line"><span class="keyword">WHERE</span> a.department_id </span><br><span class="line"><span class="keyword">NOT</span> <span class="keyword">IN</span> (<span class="keyword">SELECT</span> department_id <span class="keyword">FROM</span> employees b);</span><br></pre></td></tr></table></figure>
<h3 id="NULL的大坑"><a href="#NULL的大坑" class="headerlink" title="NULL的大坑"></a>NULL的大坑</h3><p>not in 的情况下，子查询中列的值为 NULL 时，外查询的结果为空。建议：建表时，列不允许为空。</p>
<h2 id="第13篇：细说NULL导致的坑"><a href="#第13篇：细说NULL导致的坑" class="headerlink" title="第13篇：细说NULL导致的坑"></a>第13篇：细说NULL导致的坑</h2><h3 id="比较运算符中使用NULL"><a href="#比较运算符中使用NULL" class="headerlink" title="比较运算符中使用NULL"></a>比较运算符中使用NULL</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="keyword">null</span> <span class="operator">=</span> <span class="keyword">null</span>, <span class="keyword">null</span> <span class="operator">!=</span> <span class="keyword">null</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+--------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">null</span> <span class="operator">=</span> <span class="keyword">null</span> <span class="operator">|</span> <span class="keyword">null</span> <span class="operator">!=</span> <span class="keyword">null</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+--------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>        <span class="operator">|</span> <span class="keyword">NULL</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+--------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.03</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="number">1</span> <span class="operator">&gt;</span> <span class="keyword">null</span>, <span class="number">1</span> <span class="operator">&lt;</span> <span class="keyword">null</span>, <span class="number">1</span> <span class="operator">!=</span> <span class="keyword">null</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------+-----------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span> <span class="operator">&gt;</span> <span class="keyword">null</span> <span class="operator">|</span> <span class="number">1</span> <span class="operator">&lt;</span> <span class="keyword">null</span> <span class="operator">|</span> <span class="number">1</span> <span class="operator">!=</span> <span class="keyword">null</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------+-----------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>     <span class="operator">|</span> <span class="keyword">NULL</span>     <span class="operator">|</span> <span class="keyword">NULL</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------+-----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.04</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="number">1</span> <span class="keyword">in</span> (<span class="keyword">null</span>),<span class="number">1</span> <span class="keyword">not</span> <span class="keyword">in</span> (<span class="keyword">null</span>),<span class="keyword">null</span> <span class="keyword">in</span> (<span class="keyword">null</span>),<span class="keyword">null</span> <span class="keyword">not</span> <span class="keyword">in</span> (<span class="keyword">null</span>);</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+-----------------+----------------+--------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span> <span class="keyword">in</span> (<span class="keyword">null</span>) <span class="operator">|</span> <span class="number">1</span> <span class="keyword">not</span> <span class="keyword">in</span> (<span class="keyword">null</span>) <span class="operator">|</span> <span class="keyword">null</span> <span class="keyword">in</span> (<span class="keyword">null</span>) <span class="operator">|</span> <span class="keyword">null</span> <span class="keyword">not</span> <span class="keyword">in</span> (<span class="keyword">null</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+-----------------+----------------+--------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>        <span class="operator">|</span> <span class="keyword">NULL</span>            <span class="operator">|</span> <span class="keyword">NULL</span>           <span class="operator">|</span> <span class="keyword">NULL</span>               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+-----------------+----------------+--------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.04</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="number">1</span><span class="operator">=</span><span class="keyword">any</span>(<span class="keyword">select</span> <span class="keyword">null</span>),<span class="keyword">null</span><span class="operator">=</span><span class="keyword">any</span>(<span class="keyword">select</span> <span class="keyword">null</span>);</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+-----------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span><span class="operator">=</span><span class="keyword">any</span>(<span class="keyword">select</span> <span class="keyword">null</span>) <span class="operator">|</span> <span class="keyword">null</span><span class="operator">=</span><span class="keyword">any</span>(<span class="keyword">select</span> <span class="keyword">null</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+-----------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>               <span class="operator">|</span> <span class="keyword">NULL</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+-----------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.04</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="number">1</span><span class="operator">=</span><span class="keyword">all</span>(<span class="keyword">select</span> <span class="keyword">null</span>),<span class="keyword">null</span><span class="operator">=</span><span class="keyword">all</span>(<span class="keyword">select</span> <span class="keyword">null</span>);</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+-----------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span><span class="operator">=</span><span class="keyword">all</span>(<span class="keyword">select</span> <span class="keyword">null</span>) <span class="operator">|</span> <span class="keyword">null</span><span class="operator">=</span><span class="keyword">all</span>(<span class="keyword">select</span> <span class="keyword">null</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+-----------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>               <span class="operator">|</span> <span class="keyword">NULL</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+-----------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.04</span> sec)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>结论：任何值和NULL使用运算符（&gt;、&lt;、&gt;=、&lt;=、!=、&lt;&gt;）或者（in、not in、any/some、all）比较时，返回值都为NULL，NULL作为布尔值的时候，不为1也不为0。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 准备数据</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> test1(a <span class="type">int</span>,b <span class="type">int</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test1 <span class="keyword">values</span> (<span class="number">1</span>,<span class="number">1</span>),(<span class="number">1</span>,<span class="keyword">null</span>),(<span class="keyword">null</span>,<span class="keyword">null</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test1;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+</span></span><br><span class="line"><span class="operator">|</span> a    <span class="operator">|</span> b    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.03</span> sec)</span><br></pre></td></tr></table></figure>
<h3 id="IN和NULL比较"><a href="#IN和NULL比较" class="headerlink" title="IN和NULL比较"></a>IN和NULL比较</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test1 <span class="keyword">where</span> a <span class="keyword">in</span> (<span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test1 <span class="keyword">where</span> a <span class="keyword">in</span> (<span class="keyword">null</span>, <span class="number">1</span>);</span><br><span class="line"><span class="operator">+</span><span class="comment">---+------+</span></span><br><span class="line"><span class="operator">|</span> a <span class="operator">|</span> b    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---+------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span> <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---+------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.04</span> sec)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>结论：当IN和NULL比较时，无法查询出为NULL的记录。</p>
</blockquote>
<h3 id="NOT-IN-和NULL比较"><a href="#NOT-IN-和NULL比较" class="headerlink" title="NOT IN 和NULL比较"></a>NOT IN 和NULL比较</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test1 <span class="keyword">where</span> a <span class="keyword">not</span> <span class="keyword">in</span> (<span class="number">1</span>);</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test1 <span class="keyword">where</span> a <span class="keyword">not</span> <span class="keyword">in</span> (<span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test1 <span class="keyword">where</span> a <span class="keyword">not</span> <span class="keyword">in</span> (<span class="keyword">null</span>,<span class="number">2</span>);</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test1 <span class="keyword">where</span> a <span class="keyword">not</span> <span class="keyword">in</span> (<span class="number">2</span>);</span><br><span class="line"><span class="operator">+</span><span class="comment">---+------+</span></span><br><span class="line"><span class="operator">|</span> a <span class="operator">|</span> b    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---+------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span> <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---+------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.04</span> sec)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>结论：当NOT IN 后面有NULL值时，不论什么情况下，整个sql的查询结果都为空。</p>
</blockquote>
<h3 id="EXISTS、NOT-EXISTS和NULL比较"><a href="#EXISTS、NOT-EXISTS和NULL比较" class="headerlink" title="EXISTS、NOT EXISTS和NULL比较"></a>EXISTS、NOT EXISTS和NULL比较</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test2; </span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+ </span></span><br><span class="line"><span class="operator">|</span> a <span class="operator">|</span> b <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+ </span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span> <span class="operator">|</span> <span class="number">1</span> <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span> <span class="number">1</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+ </span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test1 t1 <span class="keyword">where</span> <span class="keyword">exists</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test2 t2 <span class="keyword">where</span> t1.a <span class="operator">=</span> t2.a); </span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+ </span></span><br><span class="line"><span class="operator">|</span> a <span class="operator">|</span> b <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+ </span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span> <span class="operator">|</span> <span class="number">1</span> <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span> <span class="number">1</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+ </span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec) </span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test1 t1 <span class="keyword">where</span> <span class="keyword">not</span> <span class="keyword">exists</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test2 t2 <span class="keyword">where</span> t1.a <span class="operator">=</span> t2.a); </span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+ </span></span><br><span class="line"><span class="operator">|</span> a <span class="operator">|</span> b <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+ </span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+ </span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>查询语句中使用exists、not exists 对比 test1.a=test2.a，因为=不能比较NULL，结果和预期一致。</p>
</blockquote>
<h3 id="判断NULL用IS-NULL、IS-NOT-NULL"><a href="#判断NULL用IS-NULL、IS-NOT-NULL" class="headerlink" title="判断NULL用IS NULL、IS NOT NULL"></a>判断NULL用IS NULL、IS NOT NULL</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="number">1</span> <span class="keyword">is</span> <span class="keyword">null</span>, <span class="number">1</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span>, <span class="keyword">null</span> <span class="keyword">is</span> <span class="keyword">null</span>, <span class="keyword">null</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+---------------+--------------+------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span> <span class="keyword">is</span> <span class="keyword">null</span> <span class="operator">|</span> <span class="number">1</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="operator">|</span> <span class="keyword">null</span> <span class="keyword">is</span> <span class="keyword">null</span> <span class="operator">|</span> <span class="keyword">null</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+---------------+--------------+------------------+</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">0</span> <span class="operator">|</span>             <span class="number">1</span> <span class="operator">|</span>            <span class="number">1</span> <span class="operator">|</span>                <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+---------------+--------------+------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.05</span> sec)</span><br></pre></td></tr></table></figure>
<h3 id="聚合函数中的NULL"><a href="#聚合函数中的NULL" class="headerlink" title="聚合函数中的NULL"></a>聚合函数中的NULL</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">count</span>(a), <span class="built_in">count</span>(b), <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> test1;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------+----------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">count</span>(a) <span class="operator">|</span> <span class="built_in">count</span>(b) <span class="operator">|</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------+----------+</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">2</span> <span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span>        <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------+----------+</span></span><br><span class="line"><span class="comment">-- count(a)返回了2行记录，a字段为NULL的没有统计出来。</span></span><br><span class="line"><span class="comment">-- count(b)返回了1行记录，b为NULL的2行记录没有统计出来。</span></span><br><span class="line"><span class="comment">-- count(*)可以统计所有数据，不论字段的数据是否为NULL。</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test1 <span class="keyword">where</span> a <span class="keyword">is</span> <span class="keyword">null</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+</span></span><br><span class="line"><span class="operator">|</span> a    <span class="operator">|</span> b    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">count</span>(a) <span class="keyword">from</span> test1 <span class="keyword">where</span> a <span class="keyword">is</span> <span class="keyword">null</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">count</span>(a) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="comment">-- 上面第1个sql使用is null查询出了结果，第2个sql中count(a)返回的是0行。</span></span><br><span class="line"><span class="comment">-- 结论：count(字段)无法统计字段为NULL的值，count(*)可以统计值为null的行。</span></span><br></pre></td></tr></table></figure>
<h3 id="NULL不能作主键的值"><a href="#NULL不能作主键的值" class="headerlink" title="NULL不能作主键的值"></a>NULL不能作主键的值</h3><p>结论：当字段为主键的时候，字段会自动设置为not null。</p>
<h2 id="第14篇：事务详解"><a href="#第14篇：事务详解" class="headerlink" title="第14篇：事务详解"></a>第14篇：事务详解</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 什么是事务？</span></span><br><span class="line">数据库中的事务是指对数据库执行一批操作，这些操作要么全部执行成功，要么全部失败，不会存在部分成功的情况。</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 事务的几个特性(ACID)</span></span><br><span class="line"><span class="comment">-- 原子性(Atomicity)</span></span><br><span class="line">事务的整个过程如原子操作一样，最终要么全部成功，或者全部失败，这个原子性是从最终结果来看的，从最终结果来看这个过程是不可分割的。</span><br><span class="line"><span class="comment">-- 一致性(Consistency)</span></span><br><span class="line">一个事务必须使数据库从一个一致性状态变换到另一个一致性状态。</span><br><span class="line">一致性指的是数据处于一种有意义的状态。最常见的例子是转帐。例如从帐户A转一笔钱到帐户B上，如果帐户A上的钱减少了，而帐户B上的钱却没有增加，那么认为此时数据处于不一致的状态。</span><br><span class="line">所谓一致性，从实际的业务逻辑上来说，最终结果是对的、是跟程序员的所期望的结果完全符合的</span><br><span class="line"><span class="comment">-- 隔离性(Isolation)</span></span><br><span class="line">一个事务的执行不能被其他事务干扰。即一个事务内部的操作及使用的数据对并发的其他事务是隔离的，并发执行的各个事务之间不能互相干扰。</span><br><span class="line"><span class="comment">-- 持久性(Durability)</span></span><br><span class="line">一个事务一旦提交，他对数据库中数据的改变就应该是永久性的。当事务提交之后，数据会持久化到硬盘，修改是永久性的。</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- MySQL中事务操作</span></span><br><span class="line">mysql中事务默认是隐式事务，执行<span class="keyword">insert</span>、<span class="keyword">update</span>、<span class="keyword">delete</span>的时候，数据库自动开启事务、提交或回滚事务。</span><br><span class="line">是否开启隐式事务是由变量 autocommit 控制的。所以事务分为隐式事务和显式事务。</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 隐式事务</span></span><br><span class="line">事务自动开启、提交或回滚，比如<span class="keyword">insert</span>、<span class="keyword">update</span>、<span class="keyword">delete</span>，事务的开启、提交或回滚由mysql内部自动控制的。</span><br><span class="line">查看变量 autocommit 是否开启了自动提交</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;autocommit&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> autocommit    <span class="operator">|</span> <span class="keyword">ON</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 显式事务</span></span><br><span class="line">事务需要手动开启、提交或回滚，由开发者自己控制。<span class="number">2</span>种方式手动控制事务：</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方式1 设置不自动提交事务 </span></span><br><span class="line"><span class="keyword">set</span> autocommit<span class="operator">=</span><span class="number">0</span>;</span><br><span class="line"><span class="comment">-- 执行事务操作 </span></span><br><span class="line"><span class="keyword">commit</span><span class="operator">|</span><span class="keyword">rollback</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方式2 开启事务</span></span><br><span class="line"><span class="keyword">start</span> transaction; </span><br><span class="line"><span class="comment">-- 执行事务操作 </span></span><br><span class="line"><span class="keyword">commit</span><span class="operator">|</span><span class="keyword">rollback</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- savepoint关键字</span></span><br><span class="line">可以将一大批操作分为几个部分，然后指定回滚某个部分。可以使用 savepoin 来实现，效果如下：</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">start</span> transaction; </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> test1 <span class="keyword">values</span> (<span class="number">1</span>); </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">savepoint</span> part1;<span class="operator">/</span><span class="operator">/</span>设置一个保存点 </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> test1 <span class="keyword">values</span> (<span class="number">2</span>); </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">rollback</span> <span class="keyword">to</span> part1;<span class="operator">/</span><span class="operator">/</span>将<span class="keyword">savepoint</span> <span class="operator">=</span> part1的语句到当前语句之间所有的操作回滚 </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;<span class="operator">/</span><span class="operator">/</span>提交事务 </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test1; </span><br><span class="line"><span class="operator">+</span><span class="comment">------+ </span></span><br><span class="line"><span class="operator">|</span> a <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">------+ </span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span> <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">------+ </span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 只读事务</span></span><br><span class="line">表示在事务中执行的是一些只读操作，如查询，但是不会做<span class="keyword">insert</span>、<span class="keyword">update</span>、<span class="keyword">delete</span>操作，数据库内部对只读事务可能会有一些性能上的优化。</span><br><span class="line">用法如下：</span><br><span class="line"><span class="keyword">start</span> transaction read <span class="keyword">only</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">--</span> <span class="string">事务中的一些问题，这些问题主要是基于数据在多个事务中的可见性来说的。</span></span><br><span class="line"><span class="comment">#1 脏读</span></span><br><span class="line"><span class="comment">#[1]Transaction01将某条记录的AGE值从20修改为30。</span></span><br><span class="line"><span class="comment">#[2]Transaction02读取了Transaction01更新后的值：30。</span></span><br><span class="line"><span class="comment">#[3]Transaction01回滚，AGE值恢复到了20。</span></span><br><span class="line"><span class="comment">#[4]Transaction02读取到的30就是一个无效的值。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#2 不可重复读</span></span><br><span class="line"><span class="comment">#[1]Transaction01读取了AGE值为20。</span></span><br><span class="line"><span class="comment">#[2]Transaction02将AGE值修改为30。</span></span><br><span class="line"><span class="comment">#[3]Transaction01再次读取AGE值为30，和第一次读取不一致。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#3 幻读</span></span><br><span class="line"><span class="comment">#[1]Transaction01读取了STUDENT表中的一部分数据。</span></span><br><span class="line"><span class="comment">#[2]Transaction02向STUDENT表中插入了新的行。</span></span><br><span class="line"><span class="comment">#[3]Transaction01读取了STUDENT表时，多出了一些行。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#4 读已提交</span></span><br><span class="line"><span class="comment"># 即一个事务操作过程中可以读取到其他事务已经提交的数据。</span></span><br><span class="line"><span class="comment"># 事务中的每次读取操作，读取到的都是数据库中其他事务已提交的最新的数据（相当于当前读）</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 事务的隔离级别</span></span><br><span class="line">当多个事务同时进行的时候，如何确保当前事务中数据的正确性，比如A、B两个事物同时进行的时候，A是否可以看到B已提交的数据或者B未提交的数据，这个需要依靠事务的隔离级别来保证，不同的隔离级别中所产生的效果是不一样的。</span><br><span class="line"></span><br><span class="line">事务隔离级别主要是解决了上面多个事务之间数据可见性及数据正确性的问题。</span><br><span class="line">隔离级别分为<span class="number">4</span>种：</span><br><span class="line"><span class="number">1.</span> 读未提交：READ<span class="operator">-</span>UNCOMMITTED</span><br><span class="line"><span class="number">2.</span> 读已提交：READ<span class="operator">-</span>COMMITTED</span><br><span class="line"><span class="number">3.</span> 可重复读：REPEATABLE<span class="operator">-</span>READ</span><br><span class="line"><span class="number">4.</span> 串行：SERIALIZABLE</span><br><span class="line">上面<span class="number">4</span>中隔离级别越来越强，会导致数据库的并发性也越来越低。</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看隔离级别</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;transaction_isolation&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------+-----------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name         <span class="operator">|</span> <span class="keyword">Value</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------+-----------------+</span></span><br><span class="line"><span class="operator">|</span> transaction_isolation <span class="operator">|</span> REPEATABLE<span class="operator">-</span>READ <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------+-----------------+</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 隔离级别的设置</span></span><br><span class="line">修改mysql中的my.ini文件，将隔离级别设置为：READ<span class="operator">-</span>UNCOMMITTED：</span><br><span class="line">transaction<span class="operator">-</span>isolation<span class="operator">=</span>READ<span class="operator">-</span>UNCOMMITTED</span><br><span class="line">以管理员身份打开cmd窗口，重启mysql。</span><br></pre></td></tr></table></figure>
<p><strong>各种隔离级别中会出现的问题</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#各个隔离级别解决并发问题的能力见下表</span></span><br><span class="line"><span class="comment">#                      脏读     不可重复读  幻读</span></span><br><span class="line"><span class="comment">#READ UNCOMMITTED       有         有       无</span></span><br><span class="line"><span class="comment">#READ COMMITTED         无         有       无</span></span><br><span class="line"><span class="comment">#REPEATABLE READ        无         无       有</span></span><br><span class="line"><span class="comment">#SERIALIZABLE           无         无       无</span></span><br></pre></td></tr></table></figure>
<p>和网上有些不一样，主要是幻读这块，幻读只会在可重复读级别中才会出现，其他级别下不存在。网上版本如下：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#各个隔离级别解决并发问题的能力见下表</span></span><br><span class="line"><span class="comment">#                      脏读     不可重复读  幻读</span></span><br><span class="line"><span class="comment">#READ UNCOMMITTED       有         有       有</span></span><br><span class="line"><span class="comment">#READ COMMITTED         无         有       有</span></span><br><span class="line"><span class="comment">#REPEATABLE READ        无         无       有</span></span><br><span class="line"><span class="comment">#SERIALIZABLE           无         无       无</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 结论：</span></span><br><span class="line"><span class="comment">-- 读未提交情况下，可以读取到其他事务还未提交的数据，多次读取结果不一样，出现了脏读、不可重复读</span></span><br><span class="line"><span class="comment">-- 读已提交情况下，无法读取到其他事务还未提交的数据，可以读取到其他事务已经提交的数据，多次读取结果不一样，未出现脏读，出现了读已提交、不可重复读。</span></span><br><span class="line"><span class="comment">-- 可重复读情况下，未出现脏读，未读取到其他事务已提交的数据，多次读取结果一致，即可重复读。</span></span><br><span class="line"><span class="comment">-- SERIALIZABLE情况下，事务只能串行执行。串行情况下不存在脏读、不可重复读、幻读的问题了。</span></span><br><span class="line"><span class="comment">-- SERIALIZABLE会让并发的事务串行执行（多个事务之间读写、写读、写写会产生互斥，效果就是串行执行，多个事务之间的读读不会产生互斥）。</span></span><br><span class="line"><span class="comment">-- 读写互斥：事务A中先读取操作，事务B发起写入操作，事务A中的读取会导致事务B中的写入处于等待状态，直到A事务完成为止。</span></span><br></pre></td></tr></table></figure>
<p><strong>幻读演示</strong></p>
<p>幻读只在 REPEATABLE-READ 级别下出现，需要先把隔离级别改为可重复读。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> t_user(id <span class="type">int</span> <span class="keyword">primary</span> <span class="keyword">key</span>,name <span class="type">varchar</span>(<span class="number">16</span>) <span class="keyword">unique</span> key); </span><br><span class="line"><span class="comment">-- 上面我们创建t_user表，name添加了唯一约束，表示name不能重复，否则报错。</span></span><br></pre></td></tr></table></figure>
<p><img src="/2021/01/24/MySQL%E6%95%B4%E7%90%86/21.png" alt="21"></p>
<p>A 窗口如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">start</span> transaction; </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_user <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;路人甲Java&#x27;</span>; </span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec) </span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> t_user <span class="keyword">values</span> (<span class="number">2</span>,<span class="string">&#x27;路人甲Java&#x27;</span>); </span><br><span class="line">ERROR <span class="number">1062</span> (<span class="number">23000</span>): Duplicate entry <span class="string">&#x27;路人甲Java&#x27;</span> <span class="keyword">for</span> key <span class="string">&#x27;name&#x27;</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_user <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;路人甲Java&#x27;</span>; </span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec) mysql<span class="operator">&gt;</span> </span><br><span class="line"><span class="keyword">commit</span>; </span><br></pre></td></tr></table></figure>
<p>B 窗口如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">start</span> transaction; </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> t_user <span class="keyword">values</span> (<span class="number">1</span>,<span class="string">&#x27;路人甲Java&#x27;</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_user;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+---------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+---------------+ </span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span> <span class="operator">|</span> 路人甲Java <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+---------------+ </span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br></pre></td></tr></table></figure>
<p>A想插入数据 路人甲Java ，插之前先查询了一下（T5时刻）该用户是否存在，发现不存在，然后在T7时刻执行插入，报错了，报数据已经存在了，因为T6时刻 B 已经插入了 路人甲Java 。然后A有点郁闷，刚才查的时候不存在的，然后A不相信自己的眼睛，又去查一次（T8时刻），发现 路人甲Java 还是不存在的。此时A心里想：数据明明不存在啊，为什么无法插入呢？这不是懵逼了么，A觉得如同发生了幻觉一样。</p>
<h2 id="第15篇：视图"><a href="#第15篇：视图" class="headerlink" title="第15篇：视图"></a>第15篇：视图</h2><p>视图是在mysql5之后出现的，是一种虚拟表，行和列的数据来自于定义视图时使用的一些表中，视图的数据是在使用视图的时候动态生成的，视图只保存了sql的逻辑，不保存查询的结果。</p>
<p>当多个地方使用到同样的查询结果，并且该查询结果比较复杂的时候，可以使用视图来隐藏复杂的实现细节。</p>
<ul>
<li>视图和表的区别:</li>
</ul>
<p><img src="/2021/01/24/MySQL%E6%95%B4%E7%90%86/22.png" alt="22"></p>
<ul>
<li>视图的好处</li>
</ul>
<p>简化复杂的sql操作，不用知道他的实现细节。隔离了原始表，可以不让使用视图的人接触原始的表，从而保护原始数据，提高了安全性。</p>
<p><a target="_blank" rel="noopener" href="http://www.itsoku.com/article/209">测试数据</a></p>
<h3 id="创建视图"><a href="#创建视图" class="headerlink" title="创建视图"></a>创建视图</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> 视图名 <span class="keyword">as</span> 查询语句;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 案例1 查询姓名中包含a字符的员工名、部门、工种信息</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> myview <span class="keyword">as</span> </span><br><span class="line"><span class="keyword">select</span> e.last_name, d.department_name, j.job_title</span><br><span class="line"><span class="keyword">from</span> employees e, departments d, jobs j</span><br><span class="line"><span class="keyword">where</span> e.department_id <span class="operator">=</span> d.department_id <span class="keyword">and</span> e.job_id <span class="operator">=</span> j.job_id</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> myview <span class="keyword">where</span> last_name <span class="keyword">like</span> <span class="string">&#x27;a%&#x27;</span></span><br></pre></td></tr></table></figure>
<h3 id="修改视图"><a href="#修改视图" class="headerlink" title="修改视图"></a>修改视图</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方式1</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> replace <span class="keyword">view</span> 视图名 <span class="keyword">as</span> 查询语句;</span><br><span class="line"><span class="comment">-- 方式2</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">view</span> 视图名 <span class="keyword">as</span> 查询语句;</span><br></pre></td></tr></table></figure>
<h3 id="删除视图"><a href="#删除视图" class="headerlink" title="删除视图"></a>删除视图</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 可以同时删除多个视图，多个视图名称之间用逗号隔开。</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">view</span> 视图名<span class="number">1</span> [,视图名<span class="number">2</span>] [,视图名n];</span><br></pre></td></tr></table></figure>
<h3 id="查询视图结构"><a href="#查询视图结构" class="headerlink" title="查询视图结构"></a>查询视图结构</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方式1</span></span><br><span class="line"><span class="keyword">desc</span> 视图名称; </span><br><span class="line"><span class="comment">-- 方式2 </span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">view</span> 视图名称;</span><br></pre></td></tr></table></figure>
<h3 id="更新视图【基本不用】"><a href="#更新视图【基本不用】" class="headerlink" title="更新视图【基本不用】"></a>更新视图【基本不用】</h3><h2 id="第16篇：变量"><a href="#第16篇：变量" class="headerlink" title="第16篇：变量"></a>第16篇：变量</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--变量分类</span></span><br><span class="line"><span class="number">1.</span> 系统变量</span><br><span class="line"><span class="number">2.</span> 自定义变量</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 系统变量</span></span><br><span class="line">系统变量由系统定义的，不是用户定义的，属于mysql服务器层面的。分为：</span><br><span class="line"><span class="number">1.</span> 全局变量</span><br><span class="line"><span class="number">2.</span> 会话变量</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="系统变量"><a href="#系统变量" class="headerlink" title="系统变量"></a>系统变量</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看系统所有变量 </span></span><br><span class="line"><span class="keyword">show</span> [<span class="keyword">global</span> <span class="operator">|</span> session] variables; </span><br><span class="line"><span class="comment">-- 查看全局变量 </span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> variables;</span><br><span class="line"><span class="comment">-- 查看会话变量 </span></span><br><span class="line"><span class="keyword">show</span> session variables; </span><br><span class="line"><span class="keyword">show</span> variables;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看满足条件的系统变量(like模糊匹配) </span></span><br><span class="line"><span class="keyword">show</span> [<span class="keyword">global</span><span class="operator">|</span>session] <span class="keyword">like</span> <span class="string">&#x27;%变量名%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看指定的系统变量的值 </span></span><br><span class="line"><span class="keyword">select</span> @@[global.<span class="operator">|</span>session.]系统变量名称;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 赋值方式1 </span></span><br><span class="line"><span class="keyword">set</span> [<span class="keyword">global</span><span class="operator">|</span>session] 系统变量名<span class="operator">=</span>值; </span><br><span class="line"><span class="comment">-- 赋值方式2 </span></span><br><span class="line"><span class="keyword">set</span> @@[global.<span class="operator">|</span>session.]系统变量名<span class="operator">=</span>值;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">注意：上面使用中介绍的，全局变量需要添加global关键字，会话变量需要添加session关键字，如果不写，默认为session级别。</span></span><br><span class="line"><span class="comment">全局变量的使用中用到了 @@ 关键字，后面会介绍自定义变量，自定义变量中使用了一个 @ 符号，这点需要和全局变量区分一下。</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<h3 id="全局变量"><a href="#全局变量" class="headerlink" title="全局变量"></a>全局变量</h3><p>mysql服务器每次启动都会为所有的系统变量设置初始值。我们为系统变量赋值，针对所有会话（连接）有效，可以跨连接，但不能跨重启，重启之后，mysql服务器会再次为所有系统变量赋初始值。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 示例</span></span><br><span class="line"><span class="comment">/*查看所有全局变量*/</span> </span><br><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> variables;</span><br><span class="line"><span class="comment">/*查看包含`tx`字符的变量*/</span> </span><br><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> variables <span class="keyword">like</span> <span class="string">&#x27;%tx%&#x27;</span>;</span><br><span class="line"><span class="comment">/*查看指定名称的系统变量的值，如查看事务默认自动提交设置*/</span></span><br><span class="line"><span class="keyword">select</span> @<span class="variable">@global</span>.autocommit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*为某个系统变量赋值*/</span> </span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> autocommit<span class="operator">=</span><span class="number">0</span>;</span><br><span class="line"><span class="keyword">set</span> @<span class="variable">@global</span>.autocommit<span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<h3 id="会话变量"><a href="#会话变量" class="headerlink" title="会话变量"></a>会话变量</h3><p>针对当前会话（连接）有效，不能跨连接。会话变量是在连接创建时由mysql自动给当前会话设置的变量。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 示例</span></span><br><span class="line"><span class="comment">/*查看所有会话变量*/</span> </span><br><span class="line"><span class="keyword">show</span> session variables;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*查看满足条件的会话变量*/</span></span><br><span class="line"><span class="comment">/*查看包含`char`字符变量名的会话变量*/</span> </span><br><span class="line"><span class="keyword">show</span> session variables <span class="keyword">like</span> <span class="string">&#x27;%char%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*查看指定的会话变量的值*/</span></span><br><span class="line"><span class="comment">/*查看事务默认自动提交的设置*/</span></span><br><span class="line"><span class="keyword">select</span> @<span class="variable">@autocommit</span>; </span><br><span class="line"><span class="keyword">select</span> @<span class="variable">@session</span>.autocommit; </span><br><span class="line"><span class="comment">/*查看事务隔离级别*/</span> </span><br><span class="line"><span class="keyword">select</span> @<span class="variable">@tx</span>_isolation;</span><br><span class="line"><span class="keyword">select</span> @<span class="variable">@session</span>.tx_isolation;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*为某个会话变量赋值*/</span> </span><br><span class="line"><span class="keyword">set</span> @<span class="variable">@session</span>.tx_isolation<span class="operator">=</span><span class="string">&#x27;read-uncommitted&#x27;</span>; </span><br><span class="line"><span class="keyword">set</span> @<span class="variable">@tx</span>_isolation<span class="operator">=</span><span class="string">&#x27;read-committed&#x27;</span>; </span><br><span class="line"><span class="keyword">set</span> session tx_isolation<span class="operator">=</span><span class="string">&#x27;read-committed&#x27;</span>; </span><br><span class="line"><span class="keyword">set</span> tx_isolation<span class="operator">=</span><span class="string">&#x27;read-committed&#x27;</span>;</span><br></pre></td></tr></table></figure>
<h3 id="自定义变量"><a href="#自定义变量" class="headerlink" title="自定义变量"></a>自定义变量</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">变量由用户自定义的，而不是系统提供的。</span><br><span class="line">使用步骤： <span class="number">1.</span> 声明  <span class="number">2.</span> 赋值  <span class="number">3.</span> 使用（查看、比较、运算） </span><br><span class="line">分类 </span><br><span class="line"><span class="number">1.</span> 用户变量</span><br><span class="line"><span class="number">2.</span> 局部变量</span><br></pre></td></tr></table></figure>

<h3 id="用户变量"><a href="#用户变量" class="headerlink" title="用户变量"></a>用户变量</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 作用域</span></span><br><span class="line">针对当前会话（连接）有效，作用域同会话变量。用户变量可以在任何地方使用也就是既可以在<span class="keyword">begin</span> <span class="keyword">end</span>里面使用，也可以在外面使用。</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 声明并初始化(要求声明时必须初始化)</span></span><br><span class="line"><span class="comment">/*方式1*/</span> </span><br><span class="line"><span class="keyword">set</span> @变量名<span class="operator">=</span>值; </span><br><span class="line"><span class="comment">/*方式2*/</span> </span><br><span class="line"><span class="keyword">set</span> @变量名:<span class="operator">=</span>值; </span><br><span class="line"><span class="comment">/*方式3*/</span></span><br><span class="line"><span class="keyword">select</span> @变量名:<span class="operator">=</span>值;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 上面使用了 @ 符号，而上面介绍全局变量使用了2个 @ 符号，这点注意区分一下。</span></span><br><span class="line"><span class="comment">* set中 = 号前面:是可选的，select方式 = 前面必须有:</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 赋值（更新变量的值）</span></span><br><span class="line"><span class="comment">/*方式1：这块和变量的声明一样*/</span></span><br><span class="line"><span class="keyword">set</span> @变量名<span class="operator">=</span>值; </span><br><span class="line"><span class="keyword">set</span> @变量名:<span class="operator">=</span>值; </span><br><span class="line"><span class="keyword">select</span> @变量名:<span class="operator">=</span>值; </span><br><span class="line"><span class="comment">/*方式2*/</span></span><br><span class="line"><span class="keyword">select</span> 字段 <span class="keyword">into</span> @变量名 <span class="keyword">from</span> 表;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 使用</span></span><br><span class="line"><span class="keyword">select</span> @变量名;</span><br></pre></td></tr></table></figure>
<h4 id="综合示例"><a href="#综合示例" class="headerlink" title="综合示例"></a>综合示例</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*set方式创建变量并初始化*/</span> </span><br><span class="line"><span class="keyword">set</span> <span class="variable">@username</span><span class="operator">=</span><span class="string">&#x27;路人甲java&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*select into方式创建变量*/</span> </span><br><span class="line"><span class="keyword">select</span> <span class="string">&#x27;javacode2018&#x27;</span> <span class="keyword">into</span> <span class="variable">@gzh</span>; </span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">into</span> <span class="variable">@empcount</span> <span class="keyword">from</span> employees; </span><br><span class="line"></span><br><span class="line"><span class="comment">/*select :=方式创建变量*/</span> </span><br><span class="line"><span class="keyword">select</span> <span class="variable">@first</span>_name:<span class="operator">=</span><span class="string">&#x27;路人甲Java&#x27;</span>,<span class="variable">@email</span>:<span class="operator">=</span><span class="string">&#x27;javacode2018@163.com&#x27;</span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">/*使用变量*/</span> </span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> employees (first_name,email) <span class="keyword">values</span> (<span class="variable">@first</span>_name,<span class="variable">@email</span>);</span><br></pre></td></tr></table></figure>
<h3 id="局部变量"><a href="#局部变量" class="headerlink" title="局部变量"></a>局部变量</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 作用域</span></span><br><span class="line"><span class="keyword">declare</span>用于定义局部变量，在存储过程和函数中通过<span class="keyword">declare</span>定义变量，在begin...end中，并且可以重复定义多个变量。<span class="keyword">declare</span>变量的作用范围同编程里面类似，在这里一般是在对应的<span class="keyword">begin</span>和<span class="keyword">end</span>之间。</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 声明</span></span><br><span class="line"><span class="keyword">declare</span> 变量名 变量类型; </span><br><span class="line"><span class="keyword">declare</span> 变量名 变量类型 [<span class="keyword">default</span> 默认值];</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 赋值</span></span><br><span class="line"><span class="comment">/*方式1*/</span> </span><br><span class="line"><span class="keyword">set</span> 局部变量名<span class="operator">=</span>值; </span><br><span class="line"><span class="keyword">set</span> 局部变量名:<span class="operator">=</span>值; </span><br><span class="line"><span class="keyword">select</span> 局部变量名:<span class="operator">=</span>值; </span><br><span class="line"><span class="comment">/*方式2*/</span> </span><br><span class="line"><span class="keyword">select</span> 字段 <span class="keyword">into</span> 局部变量名 <span class="keyword">from</span> 表;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用（查看变量的值）</span></span><br><span class="line"><span class="keyword">select</span> 局部变量名;</span><br></pre></td></tr></table></figure>
<h4 id="综合示例-1"><a href="#综合示例-1" class="headerlink" title="综合示例"></a>综合示例</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*创建表test1*/</span> </span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> IF <span class="keyword">EXISTS</span> test1; </span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> test1(a <span class="type">int</span> <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span>,b <span class="type">int</span>); </span><br><span class="line"></span><br><span class="line"><span class="comment">/*声明脚本的结束符为$$*/</span></span><br><span class="line">DELIMITER $$</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">PROCEDURE</span> IF <span class="keyword">EXISTS</span> proc1; </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> proc1() </span><br><span class="line"><span class="keyword">BEGIN</span> </span><br><span class="line"><span class="comment">/*声明了一个局部变量*/</span> </span><br><span class="line"><span class="keyword">DECLARE</span> v_a <span class="type">int</span>; </span><br><span class="line"><span class="keyword">select</span> ifnull(<span class="built_in">max</span>(a),<span class="number">0</span>)<span class="operator">+</span><span class="number">1</span> <span class="keyword">into</span> v_a <span class="keyword">from</span> test1; </span><br><span class="line"><span class="keyword">select</span> <span class="variable">@v</span>_b:<span class="operator">=</span>v_a<span class="operator">*</span><span class="number">2</span>; </span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test1(a,b) <span class="keyword">select</span> v_a,<span class="variable">@v</span>_b; </span><br><span class="line"><span class="keyword">end</span> $$ </span><br><span class="line"></span><br><span class="line"><span class="comment">/*声明脚本的结束符为;*/</span> </span><br><span class="line">DELIMITER ; </span><br><span class="line"><span class="comment">/*调用存储过程*/</span> </span><br><span class="line"><span class="keyword">call</span> proc1(); </span><br><span class="line"><span class="comment">/*查看结果*/</span> </span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test1;</span><br></pre></td></tr></table></figure>
<h3 id="用户变量和局部变量对比"><a href="#用户变量和局部变量对比" class="headerlink" title="用户变量和局部变量对比"></a>用户变量和局部变量对比</h3><p><img src="/2021/01/24/MySQL%E6%95%B4%E7%90%86/23.png" alt="23"></p>
<h2 id="第17篇：存储过程-amp-自定义函数详解"><a href="#第17篇：存储过程-amp-自定义函数详解" class="headerlink" title="第17篇：存储过程&amp;自定义函数详解"></a>第17篇：存储过程&amp;自定义函数详解</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 准备数据</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> t_user; </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t_user ( </span><br><span class="line">  id <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> COMMENT <span class="string">&#x27;编号&#x27;</span>, </span><br><span class="line">  age <span class="type">SMALLINT</span> UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;年龄&#x27;</span>, </span><br><span class="line">  name <span class="type">VARCHAR</span>(<span class="number">16</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;姓名&#x27;</span> </span><br><span class="line">) COMMENT <span class="string">&#x27;用户表&#x27;</span>;</span><br></pre></td></tr></table></figure>
<h3 id="存储过程"><a href="#存储过程" class="headerlink" title="存储过程"></a>存储过程</h3><p>概念:   一组预编译好的sql语句集合，理解成批处理语句。</p>
<p>好处：提高代码的重用性，简化操作，减少编译次数并且减少和数据库服务器连接的次数，提高了效率。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建存储过程</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> 存储过程名([参数模式] 参数名 参数类型) </span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">	存储过程体</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 参数模式有3种：</span></span><br><span class="line"><span class="comment">-- in：该参数可以作为输入，也就是该参数需要调用方传入值。</span></span><br><span class="line"><span class="comment">-- out：该参数可以作为输出，也就是说该参数可以作为返回值。</span></span><br><span class="line"><span class="comment">-- inout：该参数既可以作为输入也可以作为输出，就是该参数需要在调用时传入值，又可作为返回值。</span></span><br><span class="line"><span class="comment">-- 参数模式默认为IN。</span></span><br><span class="line"><span class="comment">-- 一个存储过程可以有多个输入、多个输出、多个输入输出参数。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 调用存储过程</span></span><br><span class="line"><span class="keyword">call</span> 存储过程名称(参数列表);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除存储过程</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">procedure</span> [if <span class="keyword">exists</span>] 存储过程名称;</span><br><span class="line"></span><br><span class="line">存储过程只能一个个删除，不能批量删除。</span><br><span class="line">if <span class="keyword">exists</span>：表示存储过程存在的情况下删除。</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 修改存储过程</span></span><br><span class="line">存储过程不能修改，若涉及到修改的，可以先删除，然后重建。</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看存储过程</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">procedure</span> 存储过程名称;</span><br></pre></td></tr></table></figure>
<h4 id="存储过程案例"><a href="#存储过程案例" class="headerlink" title="存储过程案例"></a>存储过程案例</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 示例1：空参列表</span></span><br><span class="line"><span class="comment">/*设置结束符为$*/</span> </span><br><span class="line">DELIMITER $ </span><br><span class="line"><span class="comment">/*如果存储过程存在则删除*/</span> </span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">PROCEDURE</span> IF <span class="keyword">EXISTS</span> proc1; </span><br><span class="line"><span class="comment">/*创建存储过程proc1*/</span> </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> proc1() </span><br><span class="line"><span class="keyword">BEGIN</span> </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_user <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="number">30</span>,<span class="string">&#x27;路人甲Java&#x27;</span>); </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_user <span class="keyword">VALUES</span> (<span class="number">2</span>,<span class="number">50</span>,<span class="string">&#x27;刘德华&#x27;</span>); </span><br><span class="line"><span class="keyword">END</span> $ </span><br><span class="line"><span class="comment">/*将结束符置为;*/</span> </span><br><span class="line">DELIMITER ;</span><br><span class="line"><span class="comment">/*调用存储过程*/</span></span><br><span class="line"><span class="keyword">CALL</span> proc1();</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_user;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----+------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> age <span class="operator">|</span> name <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----+------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span>  <span class="number">30</span> <span class="operator">|</span> Java <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span>  <span class="number">20</span> <span class="operator">|</span> C<span class="operator">+</span><span class="operator">+</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----+------+</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 示例2：带in参数的存储过程</span></span><br><span class="line"><span class="comment">/*设置结束符为$*/</span> </span><br><span class="line">DELIMITER $ </span><br><span class="line"><span class="comment">/*如果存储过程存在则删除*/</span> </span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">PROCEDURE</span> IF <span class="keyword">EXISTS</span> proc2; </span><br><span class="line"><span class="comment">/*创建存储过程proc2*/</span> </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> proc2(id <span class="type">int</span>,age <span class="type">int</span>,<span class="keyword">in</span> name <span class="type">varchar</span>(<span class="number">16</span>)) </span><br><span class="line"><span class="keyword">BEGIN</span> </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_user <span class="keyword">VALUES</span> (id,age,name); </span><br><span class="line"><span class="keyword">END</span> $ </span><br><span class="line"><span class="comment">/*将结束符置为;*/</span> </span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> <span class="variable">@id</span><span class="operator">=</span><span class="number">3</span>;</span><br><span class="line"><span class="keyword">set</span> <span class="variable">@age</span><span class="operator">=</span><span class="number">10</span>;</span><br><span class="line"><span class="keyword">set</span> <span class="variable">@name</span><span class="operator">=</span><span class="string">&#x27;张学友&#x27;</span>;</span><br><span class="line"><span class="keyword">call</span> proc2(<span class="variable">@id</span>,<span class="variable">@age</span>,<span class="variable">@name</span>);</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_user;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----+--------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> age <span class="operator">|</span> name   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----+--------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span>  <span class="number">30</span> <span class="operator">|</span> Java   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span>  <span class="number">20</span> <span class="operator">|</span> C<span class="operator">+</span><span class="operator">+</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span>  <span class="number">10</span> <span class="operator">|</span> 张学友 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----+--------+</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 示例3：带out参数的存储过程</span></span><br><span class="line"><span class="comment">/*如果存储过程存在则删除*/</span> </span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">PROCEDURE</span> IF <span class="keyword">EXISTS</span> proc3; </span><br><span class="line"><span class="comment">/*设置结束符为$*/</span> </span><br><span class="line">DELIMITER $ </span><br><span class="line"><span class="comment">/*创建存储过程proc3*/</span> </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> proc3(id <span class="type">int</span>,age <span class="type">int</span>,name <span class="type">varchar</span>(<span class="number">16</span>),<span class="keyword">out</span> user_count <span class="type">int</span>,<span class="keyword">out</span> max_id <span class="type">INT</span>) </span><br><span class="line"><span class="keyword">BEGIN</span> </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_user <span class="keyword">VALUES</span> (id,age,name); </span><br><span class="line"><span class="comment">/*查询出t_user表的记录,放入user_count中,max_id用来存储t_user中最大的id*/</span> </span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>),<span class="built_in">max</span>(id) <span class="keyword">into</span> user_count,max_id <span class="keyword">from</span> t_user; </span><br><span class="line"><span class="keyword">END</span> $ </span><br><span class="line"><span class="comment">/*将结束符置为;*/</span> </span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*创建了3个自定义变量*/</span> </span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@id</span>:<span class="operator">=</span><span class="number">4</span>,<span class="variable">@age</span>:<span class="operator">=</span><span class="number">55</span>,<span class="variable">@name</span>:<span class="operator">=</span><span class="string">&#x27;郭富城&#x27;</span>; </span><br><span class="line"><span class="comment">/*调用存储过程*/</span> </span><br><span class="line"><span class="keyword">CALL</span> proc3(<span class="variable">@id</span>,<span class="variable">@age</span>,<span class="variable">@name</span>,<span class="variable">@user</span>_count,<span class="variable">@max</span>_id);</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="variable">@user</span>_count,<span class="variable">@max</span>_id; </span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+---------+ </span></span><br><span class="line"><span class="operator">|</span> <span class="variable">@user</span>_count <span class="operator">|</span> <span class="variable">@max</span>_id <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+---------+ </span></span><br><span class="line"><span class="operator">|</span> <span class="number">4</span> <span class="operator">|</span> <span class="number">4</span> <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+---------+</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 示例4：带inout参数的存储过程</span></span><br><span class="line"><span class="comment">/*如果存储过程存在则删除*/</span> </span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">PROCEDURE</span> IF <span class="keyword">EXISTS</span> proc4; </span><br><span class="line"><span class="comment">/*设置结束符为$*/</span> </span><br><span class="line">DELIMITER $ </span><br><span class="line"><span class="comment">/*创建存储过程proc4*/</span> </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> proc4(<span class="keyword">INOUT</span> a <span class="type">int</span>,<span class="keyword">INOUT</span> b <span class="type">int</span>) </span><br><span class="line"><span class="keyword">BEGIN</span> </span><br><span class="line"><span class="keyword">SET</span> a <span class="operator">=</span> a<span class="operator">*</span><span class="number">2</span>; </span><br><span class="line"><span class="keyword">select</span> b<span class="operator">*</span><span class="number">2</span> <span class="keyword">into</span> b; </span><br><span class="line"><span class="keyword">END</span> $ </span><br><span class="line"><span class="comment">/*将结束符置为;*/</span> </span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*创建了2个自定义变量*/</span> </span><br><span class="line"><span class="keyword">set</span> <span class="variable">@a</span><span class="operator">=</span><span class="number">10</span>,<span class="variable">@b</span>:<span class="operator">=</span><span class="number">20</span>;</span><br><span class="line"><span class="comment">/*调用存储过程*/</span> </span><br><span class="line"><span class="keyword">CALL</span> proc4(<span class="variable">@a</span>,<span class="variable">@b</span>);</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="variable">@a</span>,<span class="variable">@b</span>; </span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+ </span></span><br><span class="line"><span class="operator">|</span> <span class="variable">@a</span> <span class="operator">|</span> <span class="variable">@b</span> <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+ </span></span><br><span class="line"><span class="operator">|</span> <span class="number">20</span> <span class="operator">|</span> <span class="number">40</span> <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+ </span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 示例5：查看存储过程</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">procedure</span> proc1;</span><br></pre></td></tr></table></figure>
<h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><p>概念：一组预编译好的sql语句集合，理解成批处理语句。类似于java中的方法，但是必须有返回值。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建函数</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> 函数名(参数名称 参数类型) </span><br><span class="line"><span class="keyword">returns</span> 返回值类型 </span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">	函数体 </span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>参数是可选的。返回值是必须的。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 调用函数</span></span><br><span class="line"><span class="keyword">select</span> 函数名(实参列表); </span><br><span class="line"><span class="comment">-- 删除函数</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">function</span> [if <span class="keyword">exists</span>] 函数名;</span><br><span class="line"><span class="comment">-- 查看函数详细</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">function</span> 函数名;</span><br></pre></td></tr></table></figure>
<h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 示例1：无参函数</span></span><br><span class="line"><span class="comment">/*删除fun1*/</span> </span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">FUNCTION</span> IF <span class="keyword">EXISTS</span> fun1; </span><br><span class="line"><span class="comment">/*设置结束符为$*/</span> </span><br><span class="line">DELIMITER $ </span><br><span class="line"><span class="comment">/*创建函数*/</span> </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> fun1() </span><br><span class="line"><span class="keyword">returns</span> <span class="type">INT</span> </span><br><span class="line"><span class="keyword">BEGIN</span> </span><br><span class="line"><span class="keyword">DECLARE</span> max_id <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>; </span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">max</span>(id) <span class="keyword">INTO</span> max_id <span class="keyword">FROM</span> t_user; </span><br><span class="line"><span class="keyword">return</span> max_id; </span><br><span class="line"><span class="keyword">END</span> $ </span><br><span class="line"><span class="comment">/*设置结束符为;*/</span> </span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> fun1();</span><br><span class="line"><span class="operator">+</span><span class="comment">--------+</span></span><br><span class="line"><span class="operator">|</span> fun1() <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 示例2：有参函数</span></span><br><span class="line"><span class="comment">/*删除函数*/</span> </span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">FUNCTION</span> IF <span class="keyword">EXISTS</span> get_user_id; </span><br><span class="line"><span class="comment">/*设置结束符为$*/</span> </span><br><span class="line">DELIMITER $ </span><br><span class="line"><span class="comment">/*创建函数*/</span> </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> get_user_id(v_name <span class="type">VARCHAR</span>(<span class="number">16</span>)) </span><br><span class="line"><span class="keyword">returns</span> <span class="type">INT</span> </span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">DECLARE</span> r_id <span class="type">int</span>; </span><br><span class="line"><span class="keyword">SELECT</span> id <span class="keyword">INTO</span> r_id <span class="keyword">FROM</span> t_user <span class="keyword">WHERE</span> name <span class="operator">=</span> v_name; </span><br><span class="line"><span class="keyword">return</span> r_id; </span><br><span class="line"><span class="keyword">END</span> $ </span><br><span class="line"><span class="comment">/*设置结束符为;*/</span></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> get_user_id(name) <span class="keyword">from</span> t_user;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+</span></span><br><span class="line"><span class="operator">|</span> get_user_id(name) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+</span></span><br><span class="line"><span class="operator">|</span>                 <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>                 <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>                 <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+</span></span><br></pre></td></tr></table></figure>
<h3 id="存储过程和函数的区别"><a href="#存储过程和函数的区别" class="headerlink" title="存储过程和函数的区别"></a>存储过程和函数的区别</h3><p><img src="/2021/01/24/MySQL%E6%95%B4%E7%90%86/24.png" alt="24"></p>
<h2 id="第18篇：流程控制语句"><a href="#第18篇：流程控制语句" class="headerlink" title="第18篇：流程控制语句"></a>第18篇：流程控制语句</h2><h3 id="if函数"><a href="#if函数" class="headerlink" title="if函数"></a>if函数</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if(条件表达式,值<span class="number">1</span>,值<span class="number">2</span>);</span><br><span class="line"><span class="comment">-- if函数有3个参数。当参数1为true的时候，返回 值1 ，否则返回 值2，常用在select中。</span></span><br></pre></td></tr></table></figure>
<h3 id="CASE结构"><a href="#CASE结构" class="headerlink" title="CASE结构"></a>CASE结构</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 第一种用法</span></span><br><span class="line"><span class="keyword">case</span> 表达式 </span><br><span class="line"><span class="keyword">when</span> 值<span class="number">1</span> <span class="keyword">then</span> 结果<span class="number">1</span>或者语句<span class="number">1</span>（如果是语句需要加分号） </span><br><span class="line"><span class="keyword">when</span> 值<span class="number">2</span> <span class="keyword">then</span> 结果<span class="number">2</span>或者语句<span class="number">2</span> </span><br><span class="line">...</span><br><span class="line"><span class="keyword">else</span> 结果n或者语句n </span><br><span class="line"><span class="keyword">end</span> [<span class="keyword">case</span>] （如果是放在<span class="keyword">begin</span> <span class="keyword">end</span>之间需要加<span class="keyword">case</span>，如果在<span class="keyword">select</span>后则不需要）</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 第二种用法</span></span><br><span class="line"><span class="keyword">case</span> </span><br><span class="line"><span class="keyword">when</span> 条件<span class="number">1</span> <span class="keyword">then</span> 结果<span class="number">1</span>或者语句<span class="number">1</span>（如果是语句需要加分号） </span><br><span class="line"><span class="keyword">when</span> 条件<span class="number">2</span> <span class="keyword">then</span> 结果<span class="number">2</span>或者语句<span class="number">2</span> </span><br><span class="line">... </span><br><span class="line"><span class="keyword">else</span> 结果n或者语句n </span><br><span class="line"><span class="keyword">end</span> [<span class="keyword">case</span>] （如果是放在<span class="keyword">begin</span> <span class="keyword">end</span>之间需要加<span class="keyword">case</span>，如果是在<span class="keyword">select</span>后面<span class="keyword">case</span>可以省略）</span><br></pre></td></tr></table></figure>
<h3 id="if结构"><a href="#if结构" class="headerlink" title="if结构"></a>if结构</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if 条件语句<span class="number">1</span> <span class="keyword">then</span> 语句<span class="number">1</span>; </span><br><span class="line">elseif 条件语句<span class="number">2</span> <span class="keyword">then</span> 语句<span class="number">2</span>; </span><br><span class="line">... </span><br><span class="line"><span class="keyword">else</span> 语句n; </span><br><span class="line"><span class="keyword">end</span> if;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>只能使用在begin end之间。</p>
</blockquote>
<h3 id="循环"><a href="#循环" class="headerlink" title="循环"></a>循环</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql中循环有<span class="number">3</span>种写法</span><br><span class="line"><span class="number">1.</span> while：类似于java中的while循环</span><br><span class="line"><span class="number">2.</span> repeat：类似于java中的do while循环</span><br><span class="line"><span class="number">3.</span> loop：类似于java中的while(<span class="literal">true</span>)死循环，需要在内部进行控制。</span><br><span class="line"></span><br><span class="line">对循环内部的流程进行控制，如：</span><br><span class="line">结束本次循环</span><br><span class="line">类似于java中的 continue</span><br><span class="line">    iterate 循环标签;</span><br><span class="line"></span><br><span class="line">退出循环</span><br><span class="line">类似于java中的 break</span><br><span class="line">    leave 循环标签;</span><br></pre></td></tr></table></figure>
<h3 id="while循环"><a href="#while循环" class="headerlink" title="while循环"></a>while循环</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[标签:]while 循环条件 do </span><br><span class="line">循环体 </span><br><span class="line"><span class="keyword">end</span> while [标签];</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 标签：是给while取个名字，标签和 iterate 、 leave 结合用于在循环内部对循环进行控制：如：跳出循环、结束本次循环</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 示例1：无循环控制语句</span></span><br><span class="line">DELIMITER $</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> proc3(v_count <span class="type">int</span>) </span><br><span class="line"><span class="keyword">BEGIN</span> </span><br><span class="line">	<span class="keyword">DECLARE</span> i <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>; </span><br><span class="line">	a:WHILE i<span class="operator">&lt;=</span>v_count DO </span><br><span class="line">		<span class="keyword">INSERT</span> <span class="keyword">into</span> test1 <span class="keyword">values</span> (i); </span><br><span class="line">		<span class="keyword">SET</span> i<span class="operator">=</span>i<span class="operator">+</span><span class="number">1</span>; </span><br><span class="line">	<span class="keyword">END</span> WHILE; </span><br><span class="line"><span class="keyword">END</span> $ </span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 示例2：添加leave控制语句</span></span><br><span class="line">DELIMITER $ </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> proc4(v_count <span class="type">int</span>)</span><br><span class="line"><span class="keyword">BEGIN</span> </span><br><span class="line">	<span class="keyword">DECLARE</span> i <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>; </span><br><span class="line">	a:WHILE i<span class="operator">&lt;=</span>v_count DO </span><br><span class="line">		<span class="keyword">INSERT</span> <span class="keyword">into</span> test1 <span class="keyword">values</span> (i); </span><br><span class="line">		<span class="comment">/*判断i=10，离开循环a*/</span> </span><br><span class="line">		IF i<span class="operator">=</span><span class="number">10</span> <span class="keyword">THEN</span> </span><br><span class="line">			LEAVE a; </span><br><span class="line">		<span class="keyword">END</span> IF;</span><br><span class="line">		<span class="keyword">SET</span> i<span class="operator">=</span>i<span class="operator">+</span><span class="number">1</span>; </span><br><span class="line">	 <span class="keyword">END</span> WHILE; </span><br><span class="line"><span class="keyword">END</span> $ </span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 示例3：添加iterate控制语句</span></span><br><span class="line">DELIMITER $ </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> proc5(v_count <span class="type">int</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">DECLARE</span> i <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line">	a:WHILE i<span class="operator">&lt;=</span>v_count DO </span><br><span class="line">	<span class="keyword">SET</span> i<span class="operator">=</span>i<span class="operator">+</span><span class="number">1</span>; </span><br><span class="line">	<span class="comment">/*如果i不为偶数，跳过本次循环*/</span> </span><br><span class="line">	IF i<span class="operator">%</span><span class="number">2</span><span class="operator">!=</span><span class="number">0</span> <span class="keyword">THEN</span> </span><br><span class="line">		ITERATE a; </span><br><span class="line">	<span class="keyword">END</span> IF; </span><br><span class="line">    <span class="keyword">INSERT</span> <span class="keyword">into</span> test1 <span class="keyword">values</span> (i); </span><br><span class="line">    <span class="keyword">END</span> WHILE; </span><br><span class="line"><span class="keyword">END</span> $ </span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<h3 id="repeat循环"><a href="#repeat循环" class="headerlink" title="repeat循环"></a>repeat循环</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[标签:]repeat </span><br><span class="line">循环体; </span><br><span class="line">until 结束循环的条件 <span class="keyword">end</span> repeat [标签];</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 类似于do...while，不管如何循环都会先执行一次，然后再判断结束循环的条件</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $ </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> proc6(v_count <span class="type">int</span>) </span><br><span class="line"><span class="keyword">BEGIN</span> </span><br><span class="line">	<span class="keyword">DECLARE</span> i <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>; </span><br><span class="line">	a:REPEAT </span><br><span class="line">		<span class="keyword">INSERT</span> <span class="keyword">into</span> test1 <span class="keyword">values</span> (i); </span><br><span class="line">		<span class="keyword">SET</span> i<span class="operator">=</span>i<span class="operator">+</span><span class="number">1</span>; </span><br><span class="line">	UNTIL i<span class="operator">&gt;</span>v_count </span><br><span class="line">	<span class="keyword">END</span> REPEAT; </span><br><span class="line"><span class="keyword">END</span> $</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>repeat中 iterate 和 leave 用法和while中类似</p>
</blockquote>
<h3 id="loop循环"><a href="#loop循环" class="headerlink" title="loop循环"></a>loop循环</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[标签:]loop </span><br><span class="line">循环体; </span><br><span class="line"><span class="keyword">end</span> loop [标签];</span><br><span class="line"></span><br><span class="line"><span class="comment">-- loop相当于一个死循环，需要在循环体中使用 iterate 或者 leave 来控制循环的执行。</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> proc7(v_count <span class="type">int</span>) </span><br><span class="line"><span class="keyword">BEGIN</span> </span><br><span class="line">	<span class="keyword">DECLARE</span> i <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>; </span><br><span class="line">	a:LOOP <span class="keyword">SET</span> i<span class="operator">=</span>i<span class="operator">+</span><span class="number">1</span>; </span><br><span class="line">	<span class="comment">/*当i&gt;v_count的时候退出循环*/</span> </span><br><span class="line">		IF i<span class="operator">&gt;</span>v_count <span class="keyword">THEN</span> </span><br><span class="line">			LEAVE a; </span><br><span class="line">		<span class="keyword">END</span> IF;</span><br><span class="line">		<span class="keyword">INSERT</span> <span class="keyword">into</span> test1 <span class="keyword">values</span> (i); </span><br><span class="line">	<span class="keyword">END</span> LOOP a;</span><br><span class="line"><span class="keyword">END</span> $ </span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>loop中 iterate 和 leave 用法和while中类似</p>
</blockquote>
<h2 id="第19篇：游标详解-略"><a href="#第19篇：游标详解-略" class="headerlink" title="第19篇：游标详解   略"></a>第19篇：游标详解   略</h2><h2 id="第20篇：异常捕获及处理详解"><a href="#第20篇：异常捕获及处理详解" class="headerlink" title="第20篇：异常捕获及处理详解"></a>第20篇：异常捕获及处理详解</h2><h3 id="异常分类"><a href="#异常分类" class="headerlink" title="异常分类"></a>异常分类</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- mysql内部异常</span></span><br><span class="line">当我们执行一些<span class="keyword">sql</span>的时候，可能违反了mysql的一些约束，导致mysql内部报错，如插入数据违反唯一约束，更新数据超时等，此时异常是由mysql内部抛出的，我们将这些由mysql抛出的异常统称为内部异常。</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 外部异常</span></span><br><span class="line">当我们执行一个<span class="keyword">update</span>的时候，可能我们期望影响<span class="number">1</span>行，但是实际上影响的不是<span class="number">1</span>行数据，这种情况：<span class="keyword">sql</span>的执行结果和期望的结果不一致，这种情况也我们也把他作为外部异常处理，我们将<span class="keyword">sql</span>执行结果和期望结果不一致的情况统称为外部异常。</span><br></pre></td></tr></table></figure>
<h3 id="MySQL内部异常"><a href="#MySQL内部异常" class="headerlink" title="MySQL内部异常"></a>MySQL内部异常</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- test1表中a为主键，向test1表插入2条相同数据，并且放在一个事务中执行，最终要么都插入成功，要么都失败。</span></span><br><span class="line"><span class="comment">-- 由于test1表中的a字段是主键，插入第二条数据时违反了a字段的主键约束，mysql内部抛出了异常，导致第二条数据插入失败，最终只有第一条数据插入成功了。</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*正确的解决方案*/</span></span><br><span class="line">DELIMITER $ </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> proc2(a1 <span class="type">int</span>,a2 <span class="type">int</span>) </span><br><span class="line"><span class="keyword">BEGIN</span> </span><br><span class="line"><span class="comment">/*声明一个变量，标识是否有sql异常*/</span> </span><br><span class="line"><span class="keyword">DECLARE</span> hasSqlError <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="literal">FALSE</span>;</span><br><span class="line"><span class="comment">/*在执行过程中出任何异常设置hasSqlError为TRUE*/</span> </span><br><span class="line"><span class="keyword">DECLARE</span> CONTINUE HANDLER <span class="keyword">FOR</span> <span class="keyword">SQLEXCEPTION</span> <span class="keyword">SET</span> hasSqlError<span class="operator">=</span><span class="literal">TRUE</span>; </span><br><span class="line"><span class="keyword">START</span> TRANSACTION; </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test1(a) <span class="keyword">VALUES</span> (a1); </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test1(a) <span class="keyword">VALUES</span> (a2); </span><br><span class="line">IF hasSqlError <span class="keyword">THEN</span> </span><br><span class="line">	<span class="keyword">ROLLBACK</span>; </span><br><span class="line"><span class="keyword">ELSE</span> <span class="keyword">COMMIT</span>; </span><br><span class="line"><span class="keyword">END</span> IF;</span><br><span class="line"><span class="keyword">END</span> $ </span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<h3 id="外部异常"><a href="#外部异常" class="headerlink" title="外部异常"></a>外部异常</h3><p>外部异常不是由mysql内部抛出的错误，而是由于sql的执行结果和期望的结果不一致的时候，我们需要对这种情况做一些处理，如回滚操作。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 例如2个下单的操作并发执行  解决方案：乐观锁</span></span><br><span class="line"><span class="comment">乐观锁的过程：用期望的值和目标值进行比较，如果相同，则更新目标值，否则什么也不做。</span></span><br><span class="line"><span class="comment">添加一个 version 字段，每次更新数据的时候+1，更新数据的时候将version作为条件去执行update，根据update影响行数来判断执行是否成功。*/</span></span><br><span class="line"></span><br><span class="line">t1：打开事务<span class="keyword">start</span> transaction </span><br><span class="line">t2：<span class="keyword">select</span>获取记录R1,声明变量v<span class="operator">=</span>R1.version </span><br><span class="line">t3：对R1进行编辑 </span><br><span class="line">t4：执行更新操作 <span class="keyword">update</span> R1 <span class="keyword">set</span> version <span class="operator">=</span> version <span class="operator">+</span> <span class="number">1</span> <span class="keyword">where</span> user_id<span class="operator">=</span>#user_id# <span class="keyword">and</span> version <span class="operator">=</span> #v#; t5：t4中的<span class="keyword">update</span>会返回影响的行数，我们将其记录在count中，然后根据count来判断提交还是回滚 </span><br><span class="line"><span class="comment">/*获取影响行数*/</span> </span><br><span class="line"><span class="keyword">select</span> ROW_COUNT() <span class="keyword">INTO</span> cnt;</span><br><span class="line">	if(cnt==1)&#123; </span><br><span class="line">		<span class="operator">/</span><span class="operator">/</span>提交事务</span><br><span class="line">		<span class="keyword">commit</span>; </span><br><span class="line">	&#125;else&#123;</span><br><span class="line">		<span class="operator">/</span><span class="operator">/</span>回滚事务 </span><br><span class="line">		<span class="keyword">rollback</span>; </span><br><span class="line">	&#125;</span><br><span class="line">上面重点在于步骤t4，当多个线程同时执行到t1，他们看到的R1是一样的，但是当他们执行到t4的时候，数据库会对<span class="keyword">update</span>的这行记录加锁，确保并发情况下排队执行，所以只有第一个的<span class="keyword">update</span>会返回<span class="number">1</span>，其他的<span class="keyword">update</span>结果会返回<span class="number">0</span>，然后后面会判断count是否为<span class="number">1</span>，进而对事务进行提交或者回滚。可以通过count的值知道修改数据是否成功了。</span><br><span class="line">上面这种方式就乐观锁。我们可以通过乐观锁的方式确保数据并发修改过程中的正确性。</span><br></pre></td></tr></table></figure>


<h2 id="第21篇：什么是索引？"><a href="#第21篇：什么是索引？" class="headerlink" title="第21篇：什么是索引？"></a>第21篇：什么是索引？</h2><p>索引是帮助 MySQL 高效获取数据的数据结构。</p>
<h2 id="第22篇：MySQL索引原理详解"><a href="#第22篇：MySQL索引原理详解" class="headerlink" title="第22篇：MySQL索引原理详解"></a>第22篇：MySQL索引原理详解</h2><h3 id="预备知识"><a href="#预备知识" class="headerlink" title="预备知识"></a>预备知识</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 磁盘中数据的存取</span></span><br><span class="line"><span class="operator">-</span> 以机械硬盘来说，先了解几个概念。</span><br><span class="line"><span class="operator">-</span> 扇区：磁盘存储的最小单位，扇区一般大小为<span class="number">512</span>Byte。</span><br><span class="line"><span class="operator">-</span> 磁盘块：文件系统与磁盘交互的的最小单位（计算机系统读写磁盘的最小单位），一个磁盘块由连续几个(<span class="number">2</span><span class="operator">^</span>n)扇区组   成，块一般大小一般为<span class="number">4</span>KB。</span><br><span class="line"><span class="operator">-</span> 磁盘读取数据：磁盘读取数据靠的是机械运动，每次读取数据花费的时间可以分为寻道时间、旋转延迟、传输时间三   个部分:</span><br><span class="line">  <span class="operator">-</span> 寻道时间指的是磁臂移动到指定磁道所需要的时间，主流磁盘一般在<span class="number">5</span>ms以下；</span><br><span class="line">  <span class="operator">-</span> 旋转延迟就是我们经常听说的磁盘转速，比如一个磁盘<span class="number">7200</span>转，表示每分钟能转<span class="number">7200</span>次，也就是说<span class="number">1</span>秒钟能转<span class="number">120</span>     次，旋转延迟就是<span class="number">1</span><span class="operator">/</span><span class="number">120</span><span class="operator">/</span><span class="number">2</span> <span class="operator">=</span> <span class="number">4.17</span>ms；</span><br><span class="line">  <span class="operator">-</span> 传输时间指从磁盘读出或将数据写入磁盘的时间，一般在零点几毫秒，相对于前两个时间可以忽略不计。</span><br><span class="line">一次磁盘IO的时间约等于 <span class="number">5</span><span class="operator">+</span><span class="number">4.17</span> <span class="operator">=</span> <span class="number">9</span>ms左右，听起来还挺不错的，但要知道一台<span class="number">500</span> <span class="operator">-</span>MIPS的机器每秒可以执行<span class="number">5</span>亿条指令，因为指令依靠的是电的性质，换句话说执行一次IO的时间可以执行<span class="number">40</span>万条指令，数据库动辄十万百万乃至千万级数据，每次<span class="number">9</span>毫秒的时间，显然是个灾难。</span><br><span class="line"></span><br><span class="line"><span class="comment">-- MySQL中的页</span></span><br><span class="line">mysql中和磁盘交互的最小单位称为页，页是mysql内部定义的一种数据结构，默认为<span class="number">16</span>kb，相当于<span class="number">4</span>个磁盘块，也就是说mysql每次从磁盘中读取一次数据是<span class="number">16</span>KB，要么不读取，要读取就是<span class="number">16</span>KB，此值可以修改的。</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 数据检索过程</span></span><br><span class="line">我们对数据存储方式不做任何优化，直接将数据库中表的记录存储在磁盘中，假如某个表只有一个字段，为<span class="type">int</span>类型，<span class="type">int</span>占用<span class="number">4</span>个byte，每个磁盘块可以存储<span class="number">1000</span>条记录，<span class="number">100</span>万的记录需要<span class="number">1000</span>个磁盘块，如果我们需要从这<span class="number">100</span>万记录中检索所需要的记录，需要读取<span class="number">1000</span>个磁盘块的数据（需要<span class="number">1000</span>次io），每次io需要<span class="number">9</span>ms，那么<span class="number">1000</span>次需要<span class="number">9</span>s，<span class="number">100</span>条数据随便一个查询就是<span class="number">9</span>秒，这种情况显然是不行的。</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 我们迫切的需求是什么？</span></span><br><span class="line"><span class="number">1.</span> 需要一种数据存储结构：当从磁盘中检索数据的时候能减少磁盘的io次数，最好能够降低到一个稳定的常量值</span><br><span class="line"><span class="number">2.</span> 需要一种检索算法：当从磁盘中读取磁盘块的数据之后，这些块中可能包含多条记录，这些记录被加载到内存中，那么需要一种算法能够快速从内存多条记录中快速检索出目标数据</span><br></pre></td></tr></table></figure>

<h3 id="常用的检索算法和数据结构"><a href="#常用的检索算法和数据结构" class="headerlink" title="常用的检索算法和数据结构"></a>常用的检索算法和数据结构</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 循环遍历查找</span></span><br><span class="line">n条数据，时间复杂度为O(n)，最快需要<span class="number">1</span>次，最坏的情况需要n次，查询效率不稳定。</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 二分法查找</span></span><br><span class="line">二分法查找时间复杂度是: O(logN) (N为数据量)，<span class="number">100</span>万数据查找最多只需要<span class="number">20</span>次。</span><br><span class="line">优点：定位数据非常快，前提是：目标数组是有序的。</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 有序数组</span></span><br><span class="line">如果我们将mysql中表的数据以有序数组的方式存储在磁盘中，那么我们定位数据步骤是：</span><br><span class="line"><span class="number">1.</span> 取出目标表的所有数据，存放在一个有序数组中</span><br><span class="line"><span class="number">2.</span> 如果目标表的数据量非常大，从磁盘中加载到内存中需要的内存也非常大</span><br><span class="line">步骤<span class="number">1</span>取出所有数据耗费的io次数太多，步骤<span class="number">2</span>耗费的内存空间太大，还有新增数据的时候，为了保证数组有序，插入数据会涉及到数组内部数据的移动，也是比较耗时的，显然这种方式不可取。</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 链表</span></span><br><span class="line">优点：可以快速定位到上一个或者下一个节点。可以快速删除数据，只需改变指针的指向。</span><br><span class="line">缺点：无法通过下标随机访问数据。查找数据需从第一个节点开始遍历，最差时间是O(N)。</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 二叉查找树</span></span><br><span class="line">查询数据的效率不稳定，若树左右比较平衡的时，最差情况为O(logN)，如果插入数据是有序的，退化为了链表，查询时间变成了O(N)。</span><br><span class="line">数据量大的情况下，会导致树的高度变高，如果每个节点对应磁盘的一个块来存储一条数据，需io次数大幅增加，显然用此结构来存储数据是不可取的。</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 平衡二叉树</span></span><br><span class="line">平衡二叉树相对于二叉树来说，树的左右比较平衡，不会出现二叉树那样退化成链表的情况，不管怎么插入数据，最终通过一些调整，都能够保证树左右高度相差不大于<span class="number">1</span>。这样可以让查询速度比较稳定，查询中遍历节点控制在O(logN)范围内。</span><br><span class="line">如果数据都存储在内存中，采用AVL树来存储，还是可以的，查询效率非常高。不过我们的数据是存在磁盘中，用过采用这种结构，每个节点对应一个磁盘块，数据量大的时候，也会和二叉树一样，会导致树的高度变高，增加了io次数，显然用这种结构存储数据也是不可取的。</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- B-树</span></span><br><span class="line">一棵m阶的B<span class="operator">-</span>Tree有如下特性</span><br><span class="line"><span class="number">1.</span> 每个节点最多有m个孩子，m称为b树的阶</span><br><span class="line"><span class="number">2.</span> 除了根节点和叶子节点外，其它每个节点至少有<span class="built_in">Ceil</span>(m<span class="operator">/</span><span class="number">2</span>)个孩子</span><br><span class="line"><span class="number">3.</span> 若根节点不是叶子节点，则至少有<span class="number">2</span>个孩子</span><br><span class="line"><span class="number">4.</span> 所有叶子节点都在同一层，且不包含其它关键字信息</span><br><span class="line"><span class="number">5.</span> 每个非终端节点包含n个关键字（健值）信息</span><br><span class="line"><span class="number">6.</span> 关键字的个数n满足：<span class="built_in">ceil</span>(m<span class="operator">/</span><span class="number">2</span>)<span class="number">-1</span> <span class="operator">&lt;=</span> n <span class="operator">&lt;=</span> m<span class="number">-1</span></span><br><span class="line"><span class="number">7.</span> ki(i<span class="operator">=</span><span class="number">1</span>,…n)为关键字，且关键字升序排序</span><br><span class="line"><span class="number">8.</span> Pi(i<span class="operator">=</span><span class="number">1</span>,…n)为指向子树根节点的指针。P(i<span class="number">-1</span>)指向的子树的所有节点关键字均小于ki，但都大于k(i<span class="number">-1</span>)</span><br></pre></td></tr></table></figure>
<p>B-Tree结构的数据可以让系统高效的找到数据所在的磁盘块。为了描述B-Tree，首先定义一条记录为一个二元组[key, data] ，key为记录的键值，对应表中的主键值，data为一行记录中除主键外的数据。对于不同的记录，key值互不相同。B-Tree中的每个节点根据实际情况可以包含大量的关键字信息和分支，下图为一个3阶的BTree：</p>
<p><img src="/2021/01/24/MySQL%E6%95%B4%E7%90%86/25.png" alt="25"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">模拟查找关键字<span class="number">29</span>的过程：</span><br><span class="line"><span class="number">1.</span> 根据根节点找到磁盘块<span class="number">1</span>，读入内存。【磁盘I<span class="operator">/</span>O操作第<span class="number">1</span>次】</span><br><span class="line"><span class="number">2.</span> 比较关键字<span class="number">29</span>在区间（<span class="number">17</span>,<span class="number">35</span>），找到磁盘块<span class="number">1</span>的指针P2</span><br><span class="line"><span class="number">3.</span> 根据P2指针找到磁盘块<span class="number">3</span>，读入内存。【磁盘I<span class="operator">/</span>O操作第<span class="number">2</span>次】</span><br><span class="line"><span class="number">4.</span> 比较关键字<span class="number">29</span>在区间（<span class="number">26</span>,<span class="number">30</span>），找到磁盘块<span class="number">3</span>的指针P2</span><br><span class="line"><span class="number">5.</span> 根据P2指针找到磁盘块<span class="number">8</span>，读入内存。【磁盘I<span class="operator">/</span>O操作第<span class="number">3</span>次】</span><br><span class="line"><span class="number">6.</span> 在磁盘块<span class="number">8</span>中的关键字列表中找到关键字<span class="number">29</span></span><br><span class="line"></span><br><span class="line">分析上面过程，发现需要<span class="number">3</span>次磁盘I<span class="operator">/</span>O操作，和<span class="number">3</span>次内存查找操作，由于内存中的关键字是一个有序表结构，可以利用二分法快速定位到目标数据，而<span class="number">3</span>次磁盘I<span class="operator">/</span>O操作是影响整个B<span class="operator">-</span>Tree查找效率的决定因素。</span><br><span class="line"></span><br><span class="line">B<span class="operator">-</span>树相对于avl树，通过在节点中增加节点内部数据的个数来减少磁盘的io操作。</span><br><span class="line"></span><br><span class="line">mysql是采用页方式来读写数据，每页是<span class="number">16</span>KB，用B<span class="operator">-</span>树来存储mysql的记录，每个节点对应mysql中的一页（<span class="number">16</span>KB），假如每行记录加上树节点中的<span class="number">1</span>个指针占<span class="number">160</span>Byte，那么每个节点可以存储<span class="number">1000</span>（<span class="number">16</span>KB<span class="operator">/</span><span class="number">160</span>byte）条数据，树的高度为<span class="number">3</span>的节点大概可以存(第一层<span class="number">1000</span><span class="operator">+</span>第二层<span class="number">1000</span><span class="operator">^</span><span class="number">2</span><span class="operator">+</span>第三层 <span class="number">1000</span><span class="operator">^</span><span class="number">3</span>)<span class="operator">=</span><span class="number">10</span>亿条记录，我们从<span class="number">10</span>亿记录中查找数据只需要<span class="number">3</span>次io操作可以定位到目标数据所在的页，而页内部的数据又是有序的，然后将其加载到内存中用二分法查找，是非常快的。</span><br><span class="line"></span><br><span class="line">可以看出使用B<span class="operator">-</span>树定位某个值还是很快的(<span class="number">10</span>亿数据中<span class="number">3</span>次io操作<span class="operator">+</span>内存中二分法)，但是也是有缺点的：B<span class="operator">-</span>不利于范围查找，比如上图中我们需要查找[<span class="number">15</span>,<span class="number">36</span>]区间的数据，需要访问<span class="number">7</span>个磁盘块（<span class="number">1</span><span class="operator">/</span><span class="number">2</span><span class="operator">/</span><span class="number">7</span><span class="operator">/</span><span class="number">3</span><span class="operator">/</span><span class="number">8</span><span class="operator">/</span><span class="number">4</span><span class="operator">/</span><span class="number">9</span>），io次数又上去了，范围查找也是我们经常用到的，所以b<span class="operator">-</span>树也不太适合在磁盘中存储需要检索的数据。</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- B+树</span></span><br><span class="line">B<span class="operator">+</span>树的特征</span><br><span class="line"><span class="number">1.</span> 每个结点至多有m个子女</span><br><span class="line"><span class="number">2.</span> 除根结点外,每个结点至少有[m<span class="operator">/</span><span class="number">2</span>]个子女，根结点至少有两个子女</span><br><span class="line"><span class="number">3.</span> 有k个子女的结点必有k个关键字</span><br><span class="line"><span class="number">4.</span> 父节点中持有访问子节点的指针</span><br><span class="line"><span class="number">5.</span> 父节点的关键字在子节点中都存在（如上面的<span class="number">1</span><span class="operator">/</span><span class="number">20</span><span class="operator">/</span><span class="number">35</span>在每层都存在），要么是最小值，要么是最大值，如果节点中    关键字是升序的方式，父节点的关键字是子节点的最小值</span><br><span class="line"><span class="number">6.</span> 最底层的节点是叶子节点</span><br><span class="line"><span class="number">7.</span> 除叶子节点之外，其他节点不保存数据，只保存关键字和指针</span><br><span class="line"><span class="number">8.</span> 叶子节点包含了所有数据的关键字以及data，叶子节点之间用链表连接起来，可以非常方便的支持范围查找</span><br></pre></td></tr></table></figure>
<p><img src="/2021/01/24/MySQL%E6%95%B4%E7%90%86/26.png" alt="26"></p>
<p><strong>B+树与B-树的不同</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> b<span class="operator">+</span>树中一个节点如果有k个关键字，最多可以包含k个子节点（k个关键字对应k个指针）；而b<span class="operator">-</span>树对应k<span class="operator">+</span><span class="number">1</span>个子节点</span><br><span class="line"><span class="number">2.</span> b<span class="operator">+</span>树除叶子节点之外其他节点值存储关键字和指向子节点的指针，而b<span class="operator">-</span>树还存储了数据，这样同样大小情况下，      b<span class="operator">+</span>树可以存储更多的关键字</span><br><span class="line"><span class="number">3.</span> b<span class="operator">+</span>树叶子节点中存储了所有关键字及data，并且多个节点用链表连接，从上图中看子节点中数据从左向右是有序      的，这样快速可以支撑范围查找（先定位范围的最大值和最小值，然后子节点中依靠链表遍历范围数据）</span><br></pre></td></tr></table></figure>
<p><strong>B-Tree和B+Tree该如何选择</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> B<span class="operator">-</span>Tree因为非叶子结点也保存具体数据，所以在查找某个关键字的时候找到即可返回。而B<span class="operator">+</span>Tree所有的数据都在叶    子结点，每次查找都得到叶子结点。所以在同样高度的B<span class="operator">-</span>Tree和B<span class="operator">+</span>Tree中，B<span class="operator">-</span>Tree查找某个关键字的效率更高。</span><br><span class="line"><span class="number">2.</span> 由于B<span class="operator">+</span>Tree所有的数据都在叶子结点，且结点之间有指针连接，在找大于或小于某个关键字的数据时，B<span class="operator">+</span>Tree只需    要找到该关键字然后沿着链表遍历就可以了，而B<span class="operator">-</span>Tree需要遍历该关键字结点的根结点去搜索。</span><br><span class="line"><span class="number">3.</span> 由于B<span class="operator">-</span>Tree的每个结点都存储主键<span class="operator">+</span>实际数据，而B<span class="operator">+</span>Tree非叶子结点只存储关键字信息，而每个页的大小有限是有限    的，所以同一页能存储的B<span class="operator">-</span>Tree的数据会比B<span class="operator">+</span>Tree存储的更少。这样同样总量的数据，B<span class="operator">-</span>Tree的深度会更大，增大    查询时的磁盘I<span class="operator">/</span>O次数，进而影响查询效率。</span><br></pre></td></tr></table></figure>
<h3 id="MySQL的存储引擎和索引"><a href="#MySQL的存储引擎和索引" class="headerlink" title="MySQL的存储引擎和索引"></a>MySQL的存储引擎和索引</h3><p>主要说一下InnoDB和MyISAM这两种引擎中的索引，这两种引擎中的索引都是使用b+树的结构来存储的。</p>
<h4 id="InnoDB中的索引"><a href="#InnoDB中的索引" class="headerlink" title="InnoDB中的索引"></a>InnoDB中的索引</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Innodb中有<span class="number">2</span>种索引：主键索引（聚集索引）、辅助索引（非聚集索引）。</span><br><span class="line"><span class="comment">-- 主键索引：每个表只有一个主键索引，b+树结构，叶子节点同时保存了主键的值也数据记录，其他节点只存主键值。</span></span><br><span class="line"><span class="comment">-- 辅助索引：每个表可以有多个，b+树结构，叶子节点保存了索引字段的值以及主键的值，还包含了一个书签，用来告诉InnoDB引擎从哪里可以找到与索引相对应的行数据。由于InnoDB引擎是索引组织表，这个书签就是相应的行数据的聚集索引键。</span></span><br></pre></td></tr></table></figure>

<h4 id="MyISAM中的索引"><a href="#MyISAM中的索引" class="headerlink" title="MyISAM中的索引"></a>MyISAM中的索引</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">B<span class="operator">+</span>树结构，MyISM使用的是非聚簇索引，非聚簇索引的两棵B<span class="operator">+</span>树看上去没什么不同，节点的结构完全一致只是存储的内容不同而已，主键索引B<span class="operator">+</span>树的节点存储了主键，辅助键索引B<span class="operator">+</span>树存储了辅助键。表数据存储在独立的地方，这两颗B<span class="operator">+</span>树的叶子节点都使用一个地址指向真正的表数据，对于表数据来说，这两个键没有任何差别。由于索引树是独立的，通过辅助键检索无需访问主键的索引树。</span><br></pre></td></tr></table></figure>
<p>为了更形象说明这两种索引的区别，我们假想一个表存储了4行数据。其中Id作为主索引，Name作为辅助索引，图中清晰的显示了聚簇索引和非聚簇索引的差异。</p>
<p><img src="/2021/01/24/MySQL%E6%95%B4%E7%90%86/27.png" alt="27"></p>
<h4 id="InnoDB数据检索过程"><a href="#InnoDB数据检索过程" class="headerlink" title="InnoDB数据检索过程"></a>InnoDB数据检索过程</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">如果需要查询id<span class="operator">=</span><span class="number">14</span>的数据，只需要在左边的主键索引中检索就可以了。</span><br><span class="line">如果需要搜索name<span class="operator">=</span><span class="string">&#x27;Ellison&#x27;</span>的数据，需要<span class="number">2</span>步：</span><br><span class="line"><span class="number">1.</span> 先在辅助索引中检索到name<span class="operator">=</span><span class="string">&#x27;Ellison&#x27;</span>的数据，获取id为<span class="number">14</span></span><br><span class="line"><span class="number">2.</span> 再到主键索引中检索id为<span class="number">14</span>的记录</span><br><span class="line">辅助索引这个查询过程在mysql中叫做回表。</span><br></pre></td></tr></table></figure>
<h4 id="MyISAM数据检索过程"><a href="#MyISAM数据检索过程" class="headerlink" title="MyISAM数据检索过程"></a>MyISAM数据检索过程</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 在索引中找到对应的关键字，获取关键字对应的记录的地址</span><br><span class="line"><span class="number">2.</span> 通过记录的地址查找到对应的数据记录</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 总结</span></span><br><span class="line"><span class="operator">-</span> 我们用的最多的是innodb存储引擎，innodb中最好是采用主键查询，这样只需要一次索引，如果使用辅助索引检索，涉及到回表操作，比主键查询要耗时一些。</span><br><span class="line"><span class="operator">-</span> innodb中辅助索引为什么不像myisam那样存储记录的地址？</span><br><span class="line">表中的数据发生变更的时候，会影响其他记录地址的变化，如果辅助索引中记录数据的地址，此时会受影响，而主键的值一般是很少更新的，当页中的记录发生地址变更的时候，对辅助索引是没有影响的。</span><br></pre></td></tr></table></figure>
<h3 id="页结构"><a href="#页结构" class="headerlink" title="页结构"></a>页结构</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 我们来看一下MySQL中页的结构，页是真正存储记录的地方，对应B+树中的一个节点，也是MySQL中读写数据的最小单位，页的结构设计也是相当有水平的，能够加快数据的查询。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- MySQL中页是innodb中存储数据的基本单位，也是MySQL中管理数据的最小单位，和磁盘交互的时候都是以页来进行的，默认是16kb，MySQL中采用b+树存储数据，页相当于b+树中的一个节点。</span></span><br></pre></td></tr></table></figure>
<p>页的结构如下图：</p>
<p><img src="/2021/01/24/MySQL%E6%95%B4%E7%90%86/28.png" alt="28"></p>
<p>每个Page都有通用的头和尾，但是中部的内容根据Page的类型不同而发生变化。Page的头部里有我们关心的一些数据，下图把Page的头部详细信息显示出来：</p>
<p><img src="/2021/01/24/MySQL%E6%95%B4%E7%90%86/29.png" alt="29"></p>
<p>我们重点关注和数据组织结构相关的字段：Page的头部保存了两个指针，分别指向前一个Page和后一个Page，根据这两个指针我们很容易想象出Page链接起来就是一个双向链表的结构，如下图：</p>
<p><img src="/2021/01/24/MySQL%E6%95%B4%E7%90%86/30.png" alt="30"></p>
<p>再看看Page的主体内容，我们主要关注行数据和索引的存储，他们都位于Page的User Records部分，User Records占据Page的大部分空间，User Records由一条一条的Record组成。在一个Page内部，单链表的头尾由固定内容的两条记录来表示，字符串形式的”Infimum”代表开头，”Supremum”代表结尾，这两个用来代表开头结尾的Record存储在System Records的，Infinum、Supremum和UserRecords组成了一个单向链表结构。最初数据是按照插入的先后顺序排列的，但是随着新数据的插入和旧数据的删除，数据物理顺序会变得混乱，但他们依然通过链表的方式保持着逻辑上的先后顺序，如下图：</p>
<p><img src="/2021/01/24/MySQL%E6%95%B4%E7%90%86/31.png" alt="31"></p>
<p>把User Record的组织形式和若干Page组合起来，就看到了稍微完整的形式。</p>
<p><img src="/2021/01/24/MySQL%E6%95%B4%E7%90%86/32.png" alt="32"></p>
<p><img src="/2021/01/24/MySQL%E6%95%B4%E7%90%86/33.png" alt="33"></p>
<p>innodb为了快速查找记录，在页中定义了一个称之为page directory的目录槽（slots）,每个槽位占用两个字节（用于保存指向记录的地址），page directory中的多个slot组成了一个有序数组（可用于二分法快速定位记录，向下看），行记录被Page Directory逻辑的分成了多个块，块与块之间是有序的，能够加速记录的查找，如下图：</p>
<p><img src="/2021/01/24/MySQL%E6%95%B4%E7%90%86/34.png" alt="34"></p>
<p>看上图，每个行记录的都有一个n_owned的区域，n_owned标识所属的slot这个块有多少条数据，伪记录Infimum的n_owned值总是1，记录Supremum的n_owned的取值范围为[1,8]，其他用户记录n_owned的取值范围[4,8]，并且只有每个块中最大的那条记录的n_owned才会有值，其他的用户记录的n_owned为0。</p>
<h4 id="数据检索过程"><a href="#数据检索过程" class="headerlink" title="数据检索过程"></a>数据检索过程</h4><p>在page中查询数据的时候，先通过b+树中查询方法定位到数据所在的页，然后将页内整体加载到内存中，通过二分法在page directory中检索数据，缩小范围，比如需要检索7，通过二分法查找到7位于slot2和slot3所指向的记录中间，然后从slot3指向的记录5开始向后向后一个个找，可以找到记录7，如果没有7，走到slot2的记录8结束。</p>
<p>n_owned范围控制在[4,8]内，能保证每个slot管辖的范围内数据量控制在[4,8]个，能够加速目标数据的查找，当有数据插入的时候，page directory为了控制每个slot对应块中记录的个数（[4,8]），此时page directory中会对slot的数量进行调整。</p>
<h4 id="对page的总结"><a href="#对page的总结" class="headerlink" title="对page的总结"></a>对page的总结</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> b<span class="operator">+</span>树中叶子页之间用双向链表连接的，能够实现范围查找</span><br><span class="line"><span class="number">2.</span> 页内部的记录之间是采用单向链表连接的，方便访问下一条记录</span><br><span class="line"><span class="number">3.</span> 为了加快页内部记录的查询，对页内记录上加了个有序的稀疏索引，叫页目录（page directory）整体上来说mysql中的索引用到了b<span class="operator">+</span>树，链表，二分查找，做到了快速定位目标数据，快速范围查找。</span><br></pre></td></tr></table></figure>


<h2 id="第23篇：MySQL索引管理"><a href="#第23篇：MySQL索引管理" class="headerlink" title="第23篇：MySQL索引管理"></a>第23篇：MySQL索引管理</h2><h3 id="索引分类"><a href="#索引分类" class="headerlink" title="索引分类"></a>索引分类</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 索引分为聚集索引和非聚集索引</span></span><br><span class="line"><span class="comment">-- 聚集索引</span></span><br><span class="line">聚集索引在mysql中又叫主键索引。每个表有且一定会有一个聚集索引，整个表的数据存储在聚集索引中，mysql索引是采用B<span class="operator">+</span>树结构保存在文件中，叶子节点存储主键的值以及对应记录的数据，非叶子节点不存储记录的数据，只存储主键的值。当表中未指定主键时，mysql内部会自动给每条记录添加一个隐藏的rowid字段（默认<span class="number">4</span>个字节）作为主键，用rowid构建聚集索引。</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 非聚集索引（辅助索引）</span></span><br><span class="line">是b<span class="operator">+</span>树结构，不过有一点和聚集索引不同，非聚集索引叶子节点存储字段（索引字段）的值以及对应记录主键的值，其他节点只存储字段的值（索引字段）。</span><br><span class="line">每个表可以有多个非聚集索引。</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 非聚集索引分类</span></span><br><span class="line"><span class="operator">-</span> 单列索引: 即一个索引只包含一个列。</span><br><span class="line"><span class="operator">-</span> 多列索引（又称复合索引，联合索引）:即一个索引包含多个列。</span><br><span class="line"><span class="operator">-</span> 唯一索引: 索引列的值必须唯一，允许有一个空值。</span><br></pre></td></tr></table></figure>
<h3 id="索引管理"><a href="#索引管理" class="headerlink" title="索引管理"></a>索引管理</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建索引</span></span><br><span class="line"><span class="keyword">create</span> [<span class="keyword">unique</span>] index 索引名称 <span class="keyword">on</span> 表名(列名[(length)]);</span><br><span class="line"><span class="keyword">alter</span> 表名 <span class="keyword">add</span> [<span class="keyword">unique</span>] index 索引名称 <span class="keyword">on</span> (列名[(length)]);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 字段是char、varchar类型，length可以小于字段实际长度，如果是blog、text等长文本类型，必须指定length。</span></span><br><span class="line"><span class="comment">-- [unique]：中括号代表可以省略，如果加上了unique，表示创建唯一索引。</span></span><br><span class="line"><span class="comment">-- 如果table后面只写一个字段，就是单列索引，如果写多个字段，就是复合索引，多个字段之间用逗号隔开。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除索引</span></span><br><span class="line"><span class="keyword">drop</span> index 索引名称 <span class="keyword">on</span> 表名;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看索引</span></span><br><span class="line"><span class="keyword">show</span> index <span class="keyword">from</span> 表名;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 索引修改</span></span><br><span class="line">可以先删除索引，再重建索引。</span><br></pre></td></tr></table></figure>
<h3 id="示例：准备200万数据"><a href="#示例：准备200万数据" class="headerlink" title="示例：准备200万数据"></a>示例：准备200万数据</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*建库javacode2018*/</span> </span><br><span class="line"><span class="keyword">DROP</span> DATABASE IF <span class="keyword">EXISTS</span> javacode2018; </span><br><span class="line"><span class="keyword">CREATE</span> DATABASE javacode2018; </span><br><span class="line">USE javacode2018; </span><br><span class="line"><span class="comment">/*建表test1*/</span> </span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> test1; </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test1 ( </span><br><span class="line">	id <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;编号&#x27;</span>, </span><br><span class="line">	name <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;姓名&#x27;</span>, </span><br><span class="line">	sex TINYINT <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;性别,1：男，2：女&#x27;</span>, </span><br><span class="line">	email <span class="type">VARCHAR</span>(<span class="number">50</span>) </span><br><span class="line">);</span><br><span class="line"><span class="comment">/*准备数据*/</span> </span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">PROCEDURE</span> IF <span class="keyword">EXISTS</span> proc1; </span><br><span class="line">DELIMITER $ </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> proc1() </span><br><span class="line"><span class="keyword">BEGIN</span> </span><br><span class="line">	<span class="keyword">DECLARE</span> i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>; </span><br><span class="line">	<span class="keyword">START</span> TRANSACTION; </span><br><span class="line">	WHILE i <span class="operator">&lt;=</span> <span class="number">2000000</span> </span><br><span class="line">		DO <span class="keyword">INSERT</span> <span class="keyword">INTO</span> test1 (id, name, sex, email) <span class="keyword">VALUES</span> (i,concat(<span class="string">&#x27;javacode&#x27;</span>,i),if(<span class="built_in">mod</span>(i,<span class="number">2</span>),<span class="number">1</span>,<span class="number">2</span>),concat(<span class="string">&#x27;javacode&#x27;</span>,i,<span class="string">&#x27;@163.com&#x27;</span>)); </span><br><span class="line">		<span class="keyword">SET</span> i <span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>; </span><br><span class="line">		if i<span class="operator">%</span><span class="number">10000</span><span class="operator">=</span><span class="number">0</span> <span class="keyword">THEN</span> </span><br><span class="line">			<span class="keyword">COMMIT</span>; </span><br><span class="line">			<span class="keyword">START</span> TRANSACTION; </span><br><span class="line">		<span class="keyword">END</span> IF;</span><br><span class="line">	<span class="keyword">END</span> WHILE; </span><br><span class="line">	<span class="keyword">COMMIT</span>; </span><br><span class="line"><span class="keyword">END</span> $ </span><br><span class="line">DELIMITER ; </span><br><span class="line"></span><br><span class="line"><span class="keyword">CALL</span> proc1(); </span><br></pre></td></tr></table></figure>
<h3 id="创建索引并指定长度"><a href="#创建索引并指定长度" class="headerlink" title="创建索引并指定长度"></a>创建索引并指定长度</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test1 a <span class="keyword">where</span> a.email <span class="operator">=</span> <span class="string">&#x27;javacode1000085@163.com&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------+-----------------+-----+-------------------------+</span></span><br><span class="line"><span class="operator">|</span> id      <span class="operator">|</span> name            <span class="operator">|</span> sex <span class="operator">|</span> email                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+-----------------+-----+-------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1000085</span> <span class="operator">|</span> javacode1000085 <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span> javacode1000085<span class="variable">@163</span>.com <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+-----------------+-----+-------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">2.56</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">所有的email记录，每条记录的前面15个字符是不一样的，结尾是一样的（都是@163.com），通过前面15个字符就可以定位一个email了，那么我们可以对email创建索引的时候指定一个长度为15，这样相对于整个email字段更短一些，查询效果是一样的，这样一个页中可以存储更多的索引记录，命令如下:</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> index idx3 <span class="keyword">on</span> test1 (email(<span class="number">15</span>));</span><br><span class="line">Query OK, <span class="number">2000000</span> <span class="keyword">rows</span> affected (<span class="number">28.69</span> sec)</span><br><span class="line">Records: <span class="number">2000000</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test1 a <span class="keyword">where</span> a.email <span class="operator">=</span> <span class="string">&#x27;javacode1000085@163.com&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------+-----------------+-----+-------------------------+</span></span><br><span class="line"><span class="operator">|</span> id      <span class="operator">|</span> name            <span class="operator">|</span> sex <span class="operator">|</span> email                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+-----------------+-----+-------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1000085</span> <span class="operator">|</span> javacode1000085 <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span> javacode1000085<span class="variable">@163</span>.com <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+-----------------+-----+-------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.03</span> sec)</span><br></pre></td></tr></table></figure>
<h3 id="查看表中的索引"><a href="#查看表中的索引" class="headerlink" title="查看表中的索引"></a>查看表中的索引</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> index <span class="keyword">from</span> test1;</span><br></pre></td></tr></table></figure>
<h3 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a>删除索引</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> index idx1 <span class="keyword">on</span> test1;</span><br></pre></td></tr></table></figure>


<h2 id="第24篇：如何正确的使用索引？"><a href="#第24篇：如何正确的使用索引？" class="headerlink" title="第24篇：如何正确的使用索引？"></a>第24篇：如何正确的使用索引？</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">说一下B<span class="operator">+</span>树的几个特点：</span><br><span class="line"><span class="number">1.</span> 叶子节点存储关键字（索引字段的值）信息及对应的data</span><br><span class="line"><span class="number">2.</span> 其他非叶子节点只存储关键字的信息及子节点的指针</span><br><span class="line"><span class="number">3.</span> 每个叶子节点相当于mysql中的一页，同层级的叶子节点以双向链表的形式相连</span><br><span class="line"><span class="number">4.</span> 每个节点（页）中存储了多条记录，记录之间用单链表的形式连接组成了一条有序链表，顺序是按照索引字段排序</span><br><span class="line"><span class="number">5.</span> 检索数据时：每次检索都是从根节点开始，一直搜索到叶子节点</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">InnoDB 的数据是按数据页为单位来读写的。也就是说，当需要读取一条记录的时候，并不是将这个记录本身从磁盘读取出来，而是以页为单位，将整个页加载到内存中，一个页中可能有很多记录，然后在内存中对页进行检索。在innodb中，每个页的大小默认是16kb。</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 聚集索引</span></span><br><span class="line">每个表一定会有一个聚集索引，整个表的数据存储以b<span class="operator">+</span>树的方式存在文件中，b<span class="operator">+</span>树叶子节点中的key为主键值，data为完整记录的信息；非叶子节点存储主键的值。</span><br><span class="line"><span class="comment">-- 非聚集索引</span></span><br><span class="line">每个表可以有多个非聚集索引，b<span class="operator">+</span>树结构，叶子节点的key为索引字段字段的值，data为主键的值；非叶子节点只存储索引字段的值。通过非聚集索引检索记录的时候，需要<span class="number">2</span>次操作，先在非聚集索引中检索出主键，然后再到聚集索引中检索出主键对应的记录。</span><br></pre></td></tr></table></figure>

<h3 id="查询走索引是什么意思？"><a href="#查询走索引是什么意思？" class="headerlink" title="查询走索引是什么意思？"></a>查询走索引是什么意思？</h3><p>当对某个字段的值进行某种检索时，如果检索过程中，能够快速定位到目标数据所在的页，有效的降低页的io操作，不需要扫描所有的数据页时，认为这种情况能够有效的利用索引，也称这个检索可以走索引。如果这个过程中不能够确定数据在哪些页中，认为这种情况下索引对这个查询无效，此查询不走索引。</p>
<h3 id="B-树中数据检索过程"><a href="#B-树中数据检索过程" class="headerlink" title="B+树中数据检索过程"></a>B+树中数据检索过程</h3><h4 id="唯一记录检索"><a href="#唯一记录检索" class="headerlink" title="唯一记录检索"></a>唯一记录检索</h4><p><img src="/2021/01/24/MySQL%E6%95%B4%E7%90%86/35.png" alt="35"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">如上图，所有的数据都是唯一的，查询105的记录，过程如下：</span><br><span class="line">1. 将P1页加载到内存</span><br><span class="line">2. 在内存中采用二分法查找，可以确定105位于[100,150)中间，所以我们需要去加载100关联P4页 </span><br><span class="line">3. 将P4加载到内存中，采用二分法找到105的记录后退出</span><br></pre></td></tr></table></figure>

<h4 id="查询某个值的所有记录"><a href="#查询某个值的所有记录" class="headerlink" title="查询某个值的所有记录"></a>查询某个值的所有记录</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">如上图，查询105的所有记录，过程如下：</span><br><span class="line">1. 将P1页加载到内存</span><br><span class="line">2. 在内存中采用二分法查找，可以确定105位于[100,150)中间，100关联P4页 </span><br><span class="line">3. 将P4加载到内存中，采用二分法找到最后一个小于105的记录，即100，然后通过链表从100开始向后访问，找到所有的105记录，直到遇到第一个大于100的值为止</span><br></pre></td></tr></table></figure>
<h4 id="范围查找"><a href="#范围查找" class="headerlink" title="范围查找"></a>范围查找</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">如上图，查询[55,150]所有记录，由于页和页之间是双向链表升序结构，页内部的数据是单项升序链表结构，所以只用找到范围的起始值所在的位置，然后通过依靠链表访问两个位置之间所有的数据即可，过程如下：</span><br><span class="line">1. 将P1页加载到内存</span><br><span class="line">2. 内存中采用二分法找到55位于50关联的P3页中，150位于P5页中</span><br><span class="line">3. 将P3加载到内存中，采用二分法找到第一个55的记录，然后通过链表结构继续向后访问P3中的60、67，当P3访问完毕之后，通过P3的nextpage指针访问下一页P4中所有记录，继续遍历P4中的所有记录，直到访问到P5中的150为止。</span><br></pre></td></tr></table></figure>

<h4 id="模糊匹配"><a href="#模糊匹配" class="headerlink" title="模糊匹配"></a>模糊匹配</h4><p><img src="/2021/01/24/MySQL%E6%95%B4%E7%90%86/36.png" alt="36"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询以 f 开头的所有记录</span></span><br><span class="line">过程如下：</span><br><span class="line"><span class="number">1.</span> 将P1数据加载到内存中</span><br><span class="line"><span class="number">2.</span> 在P1页的记录中采用二分法找到最后一个小于等于f的值，这个值是f，以及第一个大于f的，这个值是z，f指向叶节点P3，z指向叶节点P6，此时可以断定以f开头的记录可能存在于[P3,P6)这个范围的页内，即P3、P4、P5这三个页中</span><br><span class="line"><span class="number">3.</span> 加载P3这个页，在内部以二分法找到第一条f开头的记录，然后以链表方式继续向后访问P4、P5中的记录，即可以找到所有已f开头的数据</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询包含 f 的记录</span></span><br><span class="line">包含的查询在<span class="keyword">sql</span>中的写法是 <span class="operator">%</span>f<span class="operator">%</span> ，通过索引我们还可以快速定位所在的页么？</span><br><span class="line">                                                                                         </span><br><span class="line">可以看一下上面的数据，f在每个页中都存在，我们通过P1页中的记录是无法判断包含f的记录在那些页的，只能通过io的方式加载所有叶子节点，并且遍历所有记录进行过滤，才可以找到包含f的记录。所以如果使用了 <span class="operator">%</span>值<span class="operator">%</span> 这种方式，索引对查询是无效的。</span><br></pre></td></tr></table></figure>
<h4 id="最左匹配原则"><a href="#最左匹配原则" class="headerlink" title="最左匹配原则"></a>最左匹配原则</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">当b+树的数据项是复合的数据结构，比如(name,age,sex)，b+树是按照从左到右的顺序来建立搜索树的，比如当(张三,20,F)这样的数据来检索的时候，b+树会优先比较name来确定下一步的所搜方向，如果name相同再依次比较age和sex，最后得到检索的数据。</span><br><span class="line"></span><br><span class="line">但当(20,F)这样没有name的数据来的时候，b+树就不知道下一步该查哪个节点，因为建立搜索树的时候name就是第一个比较因子，必须要先根据name来搜索才能知道下一步去哪里查询。比如当(张三,F)这样的数据来检索时，b+树可以用name来指定搜索方向，但下一个字段age的缺失，所以只能把名字等于张三的数据都找到，然后再匹配性别是F的数据， 这个是非常重要的性质，即索引的最左匹配特性。</span><br></pre></td></tr></table></figure>
<p>下图中是3个字段(a, b, c)的联合索引，索引中数据的顺序是以 <strong>a asc,  b asc,  c asc</strong> 这种排序方式存储在节点中的，索引先以a字段升序，a相同的时候，以b字段升序，b相同的时候，以c字段升序。</p>
<p><img src="/2021/01/24/MySQL%E6%95%B4%E7%90%86/37.png" alt="37"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询a=1的记录</span></span><br><span class="line">由于页中的记录是以 a <span class="keyword">asc</span>, b <span class="keyword">asc</span>, c <span class="keyword">asc</span> 这种排序方式存储的，所以a字段是有序的，可以通过二分法快速检索到，过程如下：</span><br><span class="line"><span class="number">1.</span> 将P1加载到内存中</span><br><span class="line">2. 在内存中对P1中的记录采用二分法找，可以确定a=1的记录位于&#123;1,1,1&#125;和&#123;1,5,1&#125;关联的范围内，这两个值的子节点分别是P2、P4</span><br><span class="line"><span class="number">3.</span> 加载叶子节点P2，在P2中采用二分法快速找到第一条a<span class="operator">=</span><span class="number">1</span>的记录，然后通过链表向下一条及下一页开始检索，直到在P4中找到第一个不满足a<span class="operator">=</span><span class="number">1</span>的记录为止</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询a=1 and b=5的记录</span></span><br><span class="line">和上面一样，可以确定a=1 and b=5的记录位于&#123;1,1,1&#125;和&#123;1,5,1&#125;关联的范围内，查找过程和a=1查找步骤类似。</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询b=1的记录</span></span><br><span class="line">这种情况通过P1页中的记录，是无法判断b<span class="operator">=</span><span class="number">1</span>的记录在那些页中的，只能对所有记录进行遍历，然后进行过滤，此时索引是无效的。</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 按照c的值查询</span></span><br><span class="line">这种情况和查询b<span class="operator">=</span><span class="number">1</span>也一样，也只能扫描所有叶子节点，此时索引也无效了。</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 按照b和c一起查</span></span><br><span class="line">这种也是无法利用索引的，也只能对所有数据进行扫描，一条条判断了，此时索引无效。</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 按照[a,c]两个字段查询</span></span><br><span class="line">这种只能利用到索引中的a字段，通过a确定索引范围，然后加载a关联的所有记录，再对c的值进行过滤。</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询a=1 and b&gt;=0 and c=1的记录</span></span><br><span class="line">这种情况只能先确定a<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> b<span class="operator">&gt;=</span><span class="number">0</span>所在页的范围，然后对这个范围的所有页进行遍历，c字段在这个查询的过程中，是无法确定c的数据在哪些页的，此时我们称c是不走索引的，只有a、b能够有效的确定索引页的范围。</span><br><span class="line"></span><br><span class="line">类似这种的还有<span class="operator">&gt;</span>、<span class="operator">&lt;</span>、<span class="keyword">between</span>、<span class="keyword">like</span>，多字段索引的情况下，mysql会一直向右匹配直到遇到范围查询(<span class="operator">&gt;</span>、<span class="operator">&lt;</span>、<span class="keyword">between</span>、<span class="keyword">like</span>)就停止匹配。</span><br></pre></td></tr></table></figure>
<h3 id="索引区分度"><a href="#索引区分度" class="headerlink" title="索引区分度"></a>索引区分度</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[1,2,3,4,5,6,7,8,8,9]</span><br><span class="line">[1,1,1,1,1,8,8,8,8,8]</span><br><span class="line">上面2个数组是有序的，如果我需要检索值为8的所有记录，那个更快一些？</span><br><span class="line"></span><br><span class="line">使用二分法查找包含8的所有记录过程如下：先使用二分法找到最后一个小于8的记录，然后沿着这条记录向后获取下一个记录，和8对比，知道遇到第一个大于8的数字结束，或者到达数组末尾结束。</span><br><span class="line"></span><br><span class="line">采用上面这种方法找到8的记录，第一个数组中更快的一些。因为第二个数组中含有8的比例更多的，需要访问以及匹配的次数更多一些。</span><br><span class="line"></span><br><span class="line">这里就涉及到数据的区分度问题：</span><br><span class="line">索引区分度 &#x3D; count(distint 记录) &#x2F; count(记录)。</span><br><span class="line"></span><br><span class="line">当索引区分度高的时候，检索数据更快一些，索引区分度太低，说明重复的数据比较多，检索的时候需要访问更多的记录才能够找到所有目标数据。</span><br><span class="line">当索引区分度非常小的时候，基本上接近于全索引数据的扫描了，此时查询速度是比较慢的。</span><br><span class="line"></span><br><span class="line">第一个数组索引区分度为0.9，第二个区分度为0.2，所以第一个检索更快的一些。所以创建索引的时候，尽量选择区分度高的列作为索引列。</span><br></pre></td></tr></table></figure>
<h3 id="正确使用索引"><a href="#正确使用索引" class="headerlink" title="正确使用索引"></a>正确使用索引</h3><h4 id="主键检索"><a href="#主键检索" class="headerlink" title="主键检索"></a>主键检索</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test1 <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------+-----+-------------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name      <span class="operator">|</span> sex <span class="operator">|</span> email             <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------+-----+-------------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> javacode1 <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span> javacode1<span class="variable">@163</span>.com <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------+-----+-------------------+</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- test1表中没有明确的指定主键，我们将id设置为主键</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> test1 modify id <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">primary</span> <span class="keyword">key</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test1 <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------+-----+-------------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name      <span class="operator">|</span> sex <span class="operator">|</span> email             <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------+-----+-------------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> javacode1 <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span> javacode1<span class="variable">@163</span>.com <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------+-----+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.02</span> sec)</span><br><span class="line"><span class="comment">-- 这个速度很快，这个走的是上面介绍的 唯一记录检索 。</span></span><br></pre></td></tr></table></figure>
<h4 id="between-and范围检索"><a href="#between-and范围检索" class="headerlink" title="between and范围检索"></a>between and范围检索</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> test1 <span class="keyword">where</span> id <span class="keyword">between</span> <span class="number">1</span> <span class="keyword">and</span> <span class="number">100</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">100</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.03</span> sec)</span><br><span class="line"><span class="comment">-- 使用between and的时候，区间跨度不要太大。 </span></span><br></pre></td></tr></table></figure>
<h4 id="in的检索"><a href="#in的检索" class="headerlink" title="in的检索"></a>in的检索</h4><blockquote>
<p>平时做项目的时候，建议少用表连接，比如电商中需要查询订单的信息和订单中商品的名称，可以先查询查询订单表，然后订单表中取出商品的id列表，采用in的方式到商品表检索商品信息，由于商品id是商品表的主键，所以检索速度还是比较快的。</p>
<p>通过id在200万数据中检索100条数据，看看效果：</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test1 <span class="keyword">where</span> id <span class="keyword">in</span> (<span class="number">100000</span>, <span class="number">100001</span>, <span class="number">100002</span>, <span class="number">100003</span>, <span class="number">100004</span>, <span class="number">100005</span>, <span class="number">100006</span>, <span class="number">100007</span>, <span class="number">100008</span>, <span class="number">100009</span>, <span class="number">100010</span>, <span class="number">100011</span>, <span class="number">100012</span>, <span class="number">100013</span>, <span class="number">100014</span>, <span class="number">100015</span>, <span class="number">100016</span>, <span class="number">100017</span>, <span class="number">100018</span>, <span class="number">100019</span>, <span class="number">100020</span>, <span class="number">100021</span>, <span class="number">100022</span>, <span class="number">100023</span>, <span class="number">100024</span>, <span class="number">100025</span>, <span class="number">100026</span>, <span class="number">100027</span>, <span class="number">100028</span>, <span class="number">100029</span>, <span class="number">100030</span>, <span class="number">100031</span>, <span class="number">100032</span>, <span class="number">100033</span>, <span class="number">100034</span>, <span class="number">100035</span>, <span class="number">100036</span>, <span class="number">100037</span>, <span class="number">100038</span>, <span class="number">100039</span>, <span class="number">100040</span>, <span class="number">100041</span>, <span class="number">100042</span>, <span class="number">100043</span>, <span class="number">100044</span>, <span class="number">100045</span>, <span class="number">100046</span>, <span class="number">100047</span>, <span class="number">100048</span>, <span class="number">100049</span>, <span class="number">100050</span>, <span class="number">100051</span>, <span class="number">100052</span>, <span class="number">100053</span>, <span class="number">100054</span>, <span class="number">100055</span>, <span class="number">100056</span>, <span class="number">100057</span>, <span class="number">100058</span>, <span class="number">100059</span>, <span class="number">100060</span>, <span class="number">100061</span>, <span class="number">100062</span>, <span class="number">100063</span>, <span class="number">100064</span>, <span class="number">100065</span>, <span class="number">100066</span>, <span class="number">100067</span>, <span class="number">100068</span>, <span class="number">100069</span>, <span class="number">100070</span>, <span class="number">100071</span>, <span class="number">100072</span>, <span class="number">100073</span>, <span class="number">100074</span>, <span class="number">100075</span>, <span class="number">100076</span>, <span class="number">100077</span>, <span class="number">100078</span>, <span class="number">100079</span>, <span class="number">100080</span>, <span class="number">100081</span>, <span class="number">100082</span>, <span class="number">100083</span>, <span class="number">100084</span>, <span class="number">100085</span>, <span class="number">100086</span>, <span class="number">100087</span>, <span class="number">100088</span>, <span class="number">100089</span>, <span class="number">100090</span>, <span class="number">100091</span>, <span class="number">100092</span>, <span class="number">100093</span>, <span class="number">100094</span>, <span class="number">100095</span>, <span class="number">100096</span>, <span class="number">100097</span>, <span class="number">100098</span>, <span class="number">100099</span>);</span><br><span class="line"></span><br><span class="line"><span class="operator">|</span> <span class="number">100098</span> <span class="operator">|</span> javacode100098 <span class="operator">|</span>   <span class="number">2</span> <span class="operator">|</span> javacode100098<span class="variable">@163</span>.com <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">100099</span> <span class="operator">|</span> javacode100099 <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span> javacode100099<span class="variable">@163</span>.com <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+----------------+-----+------------------------+</span></span><br><span class="line"><span class="number">100</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.12</span> sec)</span><br><span class="line"><span class="comment">-- 这个相当于分解为多个 唯一记录检索 ，然后将记录合并。</span></span><br></pre></td></tr></table></figure>
<h4 id="多个索引时查询如何走？"><a href="#多个索引时查询如何走？" class="headerlink" title="多个索引时查询如何走？"></a>多个索引时查询如何走？</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 在name、sex两个字段上分别建个索引</span></span><br><span class="line"><span class="keyword">create</span> index idx1 <span class="keyword">on</span> test1(name);</span><br><span class="line"><span class="keyword">create</span> index idx2 <span class="keyword">on</span> test1(sex);</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test1 <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;javacode1500000&#x27;</span> <span class="keyword">and</span> sex<span class="operator">=</span><span class="number">2</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------+-----------------+-----+-------------------------+</span></span><br><span class="line"><span class="operator">|</span> id      <span class="operator">|</span> name            <span class="operator">|</span> sex <span class="operator">|</span> email                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+-----------------+-----+-------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1500000</span> <span class="operator">|</span> javacode1500000 <span class="operator">|</span>   <span class="number">2</span> <span class="operator">|</span> javacode1500000<span class="variable">@163</span>.com <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+-----------------+-----+-------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test1 <span class="keyword">where</span> sex <span class="operator">=</span> <span class="number">2</span> <span class="keyword">and</span> name<span class="operator">=</span><span class="string">&#x27;javacode1500000&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------+-----------------+-----+-------------------------+</span></span><br><span class="line"><span class="operator">|</span> id      <span class="operator">|</span> name            <span class="operator">|</span> sex <span class="operator">|</span> email                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+-----------------+-----+-------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1500000</span> <span class="operator">|</span> javacode1500000 <span class="operator">|</span>   <span class="number">2</span> <span class="operator">|</span> javacode1500000<span class="variable">@163</span>.com <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+-----------------+-----+-------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test1 <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;javacode1500000&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------+-----------------+-----+-------------------------+</span></span><br><span class="line"><span class="operator">|</span> id      <span class="operator">|</span> name            <span class="operator">|</span> sex <span class="operator">|</span> email                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+-----------------+-----+-------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1500000</span> <span class="operator">|</span> javacode1500000 <span class="operator">|</span>   <span class="number">2</span> <span class="operator">|</span> javacode1500000<span class="variable">@163</span>.com <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+-----------------+-----+-------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">count</span>(id) <span class="keyword">from</span> test1 <span class="keyword">where</span> sex<span class="operator">=</span><span class="number">2</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">count</span>(id) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">1000000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.23</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 当多个条件中有索引的时候，并且关系是and的时候，会走索引区分度高的，显然name字段重复度很低，走name查询会更快一些。</span></span><br></pre></td></tr></table></figure>
<p><img src="/2021/01/24/MySQL%E6%95%B4%E7%90%86/38.png" alt="38"></p>
<h4 id="模糊查询"><a href="#模糊查询" class="headerlink" title="模糊查询"></a>模糊查询</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> test1 a <span class="keyword">where</span> a.name <span class="keyword">like</span> <span class="string">&#x27;javacode1000%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">1111</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.07</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> test1 a <span class="keyword">where</span> a.name <span class="keyword">like</span> <span class="string">&#x27;%javacode1000%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">1111</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">1.33</span> sec)</span><br><span class="line"><span class="comment">-- 第一个查询可以利用到name字段上面的索引，下面的查询是无法确定需要查找的值所在的范围的，只能全表扫描，无法利用索引，所以速度比较慢，这个过程上面有说过。</span></span><br></pre></td></tr></table></figure>
<h4 id="回表"><a href="#回表" class="headerlink" title="回表"></a>回表</h4><blockquote>
<p>当需要查询的数据在索引树中不存在的时候，需要再次到聚集索引中去获取，这个过程叫做回表，如查询：</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test1 <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;javacode1500000&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------+-----------------+-----+-------------------------+</span></span><br><span class="line"><span class="operator">|</span> id      <span class="operator">|</span> name            <span class="operator">|</span> sex <span class="operator">|</span> email                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+-----------------+-----+-------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1500000</span> <span class="operator">|</span> javacode1500000 <span class="operator">|</span>   <span class="number">2</span> <span class="operator">|</span> javacode1500000<span class="variable">@163</span>.com <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+-----------------+-----+-------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.02</span> sec)</span><br><span class="line"><span class="comment">-- 上面查询是 * ，由于name列所在的索引中只有 name、id 两个列，不包含 sex、email ，所以过程如下：</span></span><br><span class="line"><span class="number">1.</span> 走name索引检索 javacode3500000 对应的记录，取出id为 <span class="number">3500000</span> </span><br><span class="line"><span class="number">2.</span> 在主键索引中检索出 id<span class="operator">=</span><span class="number">3500000</span> 的记录，获取所有字段的值</span><br></pre></td></tr></table></figure>
<h4 id="索引覆盖"><a href="#索引覆盖" class="headerlink" title="索引覆盖"></a>索引覆盖</h4><blockquote>
<p>查询中采用的索引树中包含了查询所需要的所有字段的值，不用再去聚集索引检索数据，这种叫索引覆盖。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id,name <span class="keyword">from</span> test1 <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;javacode1500000&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- name对应idx1索引，id为主键，所以idx1索引树叶子节点中包含了name、id的值，这个查询只用走idx1这一个索引就可以了，如果select后面使用 * ，还需要一次回表。所以尽量避免使用*，可以考虑是否可以用索引覆盖来实现。</span></span><br></pre></td></tr></table></figure>
<h4 id="索引下推"><a href="#索引下推" class="headerlink" title="索引下推"></a>索引下推</h4><blockquote>
<p>简称ICP，Index Condition Pushdown，是MySQL 5.6中新特性，是一种在存储引擎层使用索引过滤数据的一种优化方式，ICP可以减少存储引擎访问基表的次数以及MySQL服务器访问存储引擎的次数。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(id) <span class="keyword">from</span> test1 <span class="keyword">where</span> name <span class="keyword">like</span> <span class="string">&#x27;javacode35%&#x27;</span> <span class="keyword">and</span> sex <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">过程：</span><br><span class="line"><span class="number">1.</span> 走name索引检索出以javacode35开头的第一条记录，得到记录的id</span><br><span class="line"><span class="number">2.</span> 利用id去主键索引中查询出这条记录R1</span><br><span class="line"><span class="number">3.</span> 判断R1中的sex是否为<span class="number">1</span>，然后重复上面的操作，直到找到所有记录为止。</span><br><span class="line">上面的过程中需要走name索引以及需要回表操作。</span><br><span class="line"></span><br><span class="line">如果采用ICP的方式，我们可以这么做，创建一个(name,sex)的组合索引，查询过程如下：</span><br><span class="line"><span class="number">1.</span> 走(name,sex)索引检索出以javacode35的第一条记录，可以得到(name,sex,id)，记做R1</span><br><span class="line"><span class="number">2.</span> 判断R1.sex是否为<span class="number">1</span>，然后重复上面的操作，直到找到所有记录为止，这个过程中不需要回表操作了，通过索引的数据就可以完成整个条件的过滤，速度比上面的更快一些。</span><br></pre></td></tr></table></figure>
<h4 id="数字使字符串类索引失效"><a href="#数字使字符串类索引失效" class="headerlink" title="数字使字符串类索引失效"></a>数字使字符串类索引失效</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test1 <span class="keyword">where</span> name <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------+------+-----+----------------------+</span></span><br><span class="line"><span class="operator">|</span> id      <span class="operator">|</span> name <span class="operator">|</span> sex <span class="operator">|</span> email                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+------+-----+----------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2000001</span> <span class="operator">|</span> <span class="number">1</span>    <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span> javacode2018<span class="variable">@163</span>.com <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+------+-----+----------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.81</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test1 <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------+------+-----+----------------------+</span></span><br><span class="line"><span class="operator">|</span> id      <span class="operator">|</span> name <span class="operator">|</span> sex <span class="operator">|</span> email                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+------+-----+----------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2000001</span> <span class="operator">|</span> <span class="number">1</span>    <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span> javacode2018<span class="variable">@163</span>.com <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+------+-----+----------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.03</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*name是字符串类型，字符串和数字比较的时候，会将字符串强制转换为数字，然后进行比较，所以第一个查询变成了全表扫描，只能取出每条数据，将name转换为数字和1进行比较。*/</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果字段是数字类型的，查询的值是字符串还是数字都会走索引。</p>
</blockquote>
<h4 id="函数使索引无效"><a href="#函数使索引无效" class="headerlink" title="函数使索引无效"></a>函数使索引无效</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test1 <span class="keyword">where</span> concat(name,<span class="string">&#x27;1&#x27;</span>) <span class="operator">=</span> <span class="string">&#x27;javacode11&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------+-----+-------------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name      <span class="operator">|</span> sex <span class="operator">|</span> email             <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------+-----+-------------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> javacode1 <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span> javacode1<span class="variable">@163</span>.com <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------+-----+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">1.07</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 使用了函数之后，name所在的索引树是无法快速定位需要查找的数据所在的页，只能将所有页的记录加载到内存中，然后对每条数据使用函数进行计算之后再进行条件判断，此时索引无效了，变成了全表数据扫描。*/</span></span><br></pre></td></tr></table></figure>
<h4 id="运算符使索引无效"><a href="#运算符使索引无效" class="headerlink" title="运算符使索引无效"></a>运算符使索引无效</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test1 a <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">2</span> <span class="operator">-</span> <span class="number">1</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------+-----+-------------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name      <span class="operator">|</span> sex <span class="operator">|</span> email             <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------+-----+-------------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> javacode1 <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span> javacode1<span class="variable">@163</span>.com <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------+-----+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test1 a <span class="keyword">where</span> id<span class="operator">+</span><span class="number">1</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------+-----+-------------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name      <span class="operator">|</span> sex <span class="operator">|</span> email             <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------+-----+-------------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> javacode1 <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span> javacode1<span class="variable">@163</span>.com <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------+-----+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.79</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">/* id上有主键索引，上面查询，第一个走索引，第二个不走索引，第二个使用运算符，id所在的索引树是无法快速定位需要查找的数据所在的页的，只能将所有页的记录加载到内存中，然后对每条数据的id进行计算之后再判断是否等于1，此时索引无效了，变成了全表数据扫描。*/</span></span><br></pre></td></tr></table></figure>
<h4 id="使用索引优化排序"><a href="#使用索引优化排序" class="headerlink" title="使用索引优化排序"></a>使用索引优化排序</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">有个订单表t_order(id, user_id, addtime, price)，经常会查询某个用户的订单，并且按照addtime升序排序，应该怎么创建索引呢？</span><br><span class="line">在user_id上创建索引，我们分析一下这种情况，数据检索的过程：</span><br><span class="line"><span class="number">1.</span> 走user_id索引，找到记录的的id</span><br><span class="line"><span class="number">2.</span> 通过id在主键索引中回表检索出整条数据</span><br><span class="line"><span class="number">3.</span> 重复上面的操作，获取所有目标记录</span><br><span class="line"><span class="number">4.</span> 在内存中对目标记录按照addtime进行排序</span><br><span class="line">我们要知道当数据量非常大的时候，排序还是比较慢的，可能会用到磁盘中的文件，有没有一种方式，查询出来的数据刚好是排好序的。</span><br><span class="line">我们再回顾一下mysql中b<span class="operator">+</span>树数据的结构，记录是按照索引的值排序组成的链表，如果将user_id和addtime放在一起组成联合索引(user_id,addtime)，这样通过user_id检索出来的数据自然就是按照addtime排好序的，这样直接少了一步排序操作，效率更好，如果需addtime降序，只需要将结果翻转一下就可以了。</span><br></pre></td></tr></table></figure>
<h3 id="总结使用索引的建议"><a href="#总结使用索引的建议" class="headerlink" title="总结使用索引的建议"></a>总结使用索引的建议</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 在区分度高的字段上面建立索引可以有效的使用索引，区分度太低，无法有效的利用索引，可能需要扫描所有数据      页，此时和不使用索引差不多</span><br><span class="line"><span class="number">2.</span> 联合索引注意最左匹配原则：必须按照从左到右的顺序匹配，mysql会一直向右匹配直到遇到范围查询</span><br><span class="line">   (<span class="operator">&gt;</span>、<span class="operator">&lt;</span>、<span class="keyword">between</span>、<span class="keyword">like</span>) 就停止匹配，比如a <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span> b <span class="operator">=</span> <span class="number">2</span> <span class="keyword">and</span> c <span class="operator">&gt;</span> <span class="number">3</span> <span class="keyword">and</span> d <span class="operator">=</span> <span class="number">4</span> 如果建立(a,b,c,d)顺序    的索引，d是用不到索引的，如果建立(a,b,d,c)的索引则都可以用到，a,b,d的顺序可以任意调整</span><br><span class="line"><span class="number">3.</span> 查询记录的时候，少使用<span class="operator">*</span>，尽量去利用索引覆盖，可以减少回表操作，提升效率</span><br><span class="line"><span class="number">4.</span> 有些查询可以采用联合索引，进而使用到索引下推（IPC），也可以减少回表操作，提升效率</span><br><span class="line"><span class="number">5.</span> 禁止对索引字段使用函数、运算符操作，会使索引失效</span><br><span class="line"><span class="number">6.</span> 字符串字段和数字比较的时候会使索引无效</span><br><span class="line"><span class="number">7.</span> 模糊查询<span class="string">&#x27;%值%&#x27;</span>会使索引无效，变为全表扫描，但是<span class="string">&#x27;值%&#x27;</span>这种可以有效利用索引</span><br><span class="line"><span class="number">8.</span> 排序中尽量使用到索引字段，这样可以减少排序，提升查询效率</span><br></pre></td></tr></table></figure>


<h2 id="第25篇：SQL中where在数据库中提取与应用"><a href="#第25篇：SQL中where在数据库中提取与应用" class="headerlink" title="第25篇：SQL中where在数据库中提取与应用"></a>第25篇：SQL中where在数据库中提取与应用</h2><h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>给定一条SQL，如何提取其中的where条件？where条件中的每个子条件，在SQL执行的过程中有分别起着什么样的作用？MySQL 5.6中一个重要的优化Index Condition Pushdown，究竟push down了什么？</p>
<h3 id="关系型数据库中的数据组织"><a href="#关系型数据库中的数据组织" class="headerlink" title="关系型数据库中的数据组织"></a>关系型数据库中的数据组织</h3><p>关系型数据库中，数据组织涉及到两个最基本的结构：表与索引。表中存储的是完整记录，一般有两种组织形式：堆表(所有的记录无序存储)，或者是聚簇索引表(所有的记录，按照记录主键进行排序存储)。索引中存储的是完整记录的一个子集，用于加速记录的查询速度，索引的组织形式，一般均为B+树结构。</p>
<p>注意：下面的实例，使用的表的结构为堆表形式，这也是Oracle/DB2/PostgreSQL等数据库采用的表组织形式，而不是InnoDB引擎所采用的聚簇索引表。其实，表结构采用何种形式并不重要，最重要的是理解下面章节的核心，在任何表结构中均适用。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t1 (</span><br><span class="line">  a <span class="type">int</span> <span class="keyword">primary</span> <span class="keyword">key</span>, </span><br><span class="line">  b <span class="type">int</span>, </span><br><span class="line">  c <span class="type">int</span>, </span><br><span class="line">  d <span class="type">int</span>, </span><br><span class="line">  e <span class="type">varchar</span>(<span class="number">20</span>)); </span><br><span class="line">  </span><br><span class="line"><span class="keyword">create</span> index idx_t1_bcd <span class="keyword">on</span> t1(b, c, d); </span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1 <span class="keyword">values</span> (<span class="number">4</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">1</span>,’d’); </span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1 <span class="keyword">values</span> (<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,’a’); </span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1 <span class="keyword">values</span> (<span class="number">8</span>,<span class="number">8</span>,<span class="number">8</span>,<span class="number">8</span>,’h’);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1 <span class="keyword">values</span> (<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,’b’); </span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1 <span class="keyword">values</span> (<span class="number">5</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">5</span>,’e’);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1 <span class="keyword">values</span> (<span class="number">3</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">2</span>,’c’);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1 <span class="keyword">values</span> (<span class="number">7</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,’g’); </span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1 <span class="keyword">values</span> (<span class="number">6</span>,<span class="number">6</span>,<span class="number">4</span>,<span class="number">4</span>,’f’);</span><br></pre></td></tr></table></figure>
<p>t1表的存储结构如下图所示 (只画出了idx_t1_bcd索引与t1表结构，没有包括t1表的主键索引)：</p>
<p><img src="/2021/01/24/MySQL%E6%95%B4%E7%90%86/39.png" alt="39"></p>
<p>简单分析一下上图，idx_t1_bcd索引上有[b,c,d]三个字段(注意：若是InnoDB类的聚簇索引表，idx_t1_bcd上还会包括主键a字段)，不包括[a,e]字段。idx_t1_bcd索引，首先按照b字段排序，b字段相同，则按照c字段排序，以此类推。记录在索引中按照[b,c,d]排序，但是在堆表上是乱序的，不按照任何字段排序。</p>
<h3 id="SQL的where条件提取"><a href="#SQL的where条件提取" class="headerlink" title="SQL的where条件提取"></a>SQL的where条件提取</h3><p>考虑以下SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1 <span class="keyword">where</span> b <span class="operator">&gt;=</span> <span class="number">2</span> <span class="keyword">and</span> b <span class="operator">&lt;</span> <span class="number">8</span> <span class="keyword">and</span> c <span class="operator">&gt;</span> <span class="number">1</span> <span class="keyword">and</span> d <span class="operator">!=</span> <span class="number">4</span> <span class="keyword">and</span> e <span class="operator">!=</span> <span class="string">&#x27;a&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>可以发现 where 条件使用到了 [b,c,d,e] 四个字段，而idx_t1_bcd索引，恰好使用了[b,c,d]这三个字段，那么走idx_t1_bcd索引进行条件过滤，应该是一个不错的选择。接下来，让我们抛弃数据库的思想，直接思考这条SQL的几个关键性问题：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 此SQL覆盖索引 idx_t1_bcd 上的哪个范围？</span></span><br><span class="line">起始范围：记录[<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>]是第一个需要检查的索引项。索引起始查找范围由b <span class="operator">&gt;=</span> <span class="number">2</span>，c <span class="operator">&gt;</span> <span class="number">1</span>决定。</span><br><span class="line">终止范围：记录[<span class="number">8</span>,<span class="number">8</span>,<span class="number">8</span>]是第一个不需要检查的记录，之前的记录均需要判断。索引的终止查找范围由b <span class="operator">&lt;</span> <span class="number">8</span>决定；</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 确定了查询的起始、终止范围之后，SQL中还有哪些条件可以使用索引idx_t1_bcd过滤？</span></span><br><span class="line">根据<span class="keyword">SQL</span>，固定了索引的查询范围[(<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>),(<span class="number">8</span>,<span class="number">8</span>,<span class="number">8</span>))之后，此索引范围中并不是每条记录都是满足<span class="keyword">where</span>查询条件。例如：(<span class="number">3</span>,<span class="number">1</span>,<span class="number">1</span>)不满足c <span class="operator">&gt;</span> <span class="number">1</span>的约束；(<span class="number">6</span>,<span class="number">4</span>,<span class="number">4</span>)不满足d <span class="operator">!=</span> <span class="number">4</span>的约束。而c，d列，均可在索引idx_t1_bcd中过滤掉不满足条件的索引记录。</span><br><span class="line">因此，<span class="keyword">SQL</span>中还可以使用c <span class="operator">&gt;</span> <span class="number">1</span> <span class="keyword">and</span> d <span class="operator">!=</span> <span class="number">4</span>条件进行索引记录的过滤。</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 在确定了索引中最终能够过滤掉的条件之后，还有哪些条件是索引无法过滤的？</span></span><br><span class="line">e <span class="operator">!=</span> <span class="string">&#x27;a&#x27;</span>这个查询条件，无法在索引idx_t1_bcd上进行过滤，因为索引并未包含e列。e列只在堆表上存在，为了过滤此查询条件，必须将已经满足索引查询条件的记录回表，取出表中的e列，然后使用e列的查询条件e <span class="operator">!=</span> <span class="string">&#x27;a&#x27;</span>进行最终的过滤。</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 在理解以上的问题的基础上，做一个抽象，总结出一套放置于所有SQL语句皆准的where查询条件的提取规则：</span></span><br><span class="line"><span class="comment">-- 所有SQL的where条件，均可归纳为3大类</span></span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> Index Key</span><br><span class="line">用于确定<span class="keyword">SQL</span>查询在索引中的连续范围(起始范围<span class="operator">+</span>结束范围)的查询条件，被称之为Index Key。</span><br><span class="line">Index Key也被拆分为Index <span class="keyword">First</span> Key和Index <span class="keyword">Last</span> Key，分别用于定位索引查找的起始、索引查询的终止条件。</span><br><span class="line"></span><br><span class="line"><span class="operator">-</span> Index <span class="keyword">First</span> Key</span><br><span class="line">用于确定索引查询的起始范围。提取规则：从索引的第一个键值开始，检查其在<span class="keyword">where</span>条件中是否存在，若存在并且条件是<span class="operator">=</span>、<span class="operator">&gt;=</span>，则将对应的条件加入Index <span class="keyword">First</span> Key之中，继续读取索引的下一个键值，使用同样的提取规则；若存在并且条件是<span class="operator">&gt;</span>，则将对应的条件加入Index <span class="keyword">First</span> Key中，同时终止Index <span class="keyword">First</span> Key的提取；若不存在，同样终止Index <span class="keyword">First</span> Key的提取。针对上面的<span class="keyword">SQL</span>，应用这个提取规则，提取出来的Index <span class="keyword">First</span> Key为(b <span class="operator">&gt;=</span> <span class="number">2</span>, c <span class="operator">&gt;</span> <span class="number">1</span>)。由于c的条件为 <span class="operator">&gt;</span>，提取结束，不包括d。</span><br><span class="line"></span><br><span class="line"><span class="operator">-</span> Index <span class="keyword">Last</span> Key</span><br><span class="line">Index <span class="keyword">Last</span> Key用于确定索引查询的终止范围。提取规则：从索引的第一个键值开始，检查其在<span class="keyword">where</span>条件中是否存在，若存在并且条件是<span class="operator">=</span>、<span class="operator">&lt;=</span>，则将对应条件加入到Index <span class="keyword">Last</span> Key中，继续提取索引的下一个键值，使用同样的提取规则；若存在并且条件是 <span class="operator">&lt;</span> ，则将条件加入到Index <span class="keyword">Last</span> Key中，同时终止提取；若不存在，同样终止Index <span class="keyword">Last</span> Key的提取。针对上面的<span class="keyword">SQL</span>，应用这个提取规则，提取出来的Index <span class="keyword">Last</span> Key为(b <span class="operator">&lt;</span> <span class="number">8</span>)，由于是 <span class="operator">&lt;</span> 符号，因此提取b之后结束。</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> Index <span class="keyword">Filter</span></span><br><span class="line">在完成Index Key的提取之后，我们根据<span class="keyword">where</span>条件固定了索引的查询范围，但是此范围中的项，并不都是满足查询条件的项。在上面的<span class="keyword">SQL</span>用例中，(<span class="number">3</span>,<span class="number">1</span>,<span class="number">1</span>)，(<span class="number">6</span>,<span class="number">4</span>,<span class="number">4</span>)均属于范围中，但是又均不满足<span class="keyword">SQL</span>的查询条件。</span><br><span class="line"></span><br><span class="line">Index <span class="keyword">Filter</span>的提取规则：同样从索引列的第一列开始，检查其在<span class="keyword">where</span>条件中是否存在：若存在并且<span class="keyword">where</span>条件仅为 <span class="operator">=</span>，则跳过第一列继续检查索引下一列，下一索引列采取与索引第一列同样的提取规则；若<span class="keyword">where</span>条件为 <span class="operator">&gt;=</span>、<span class="operator">&gt;</span>、<span class="operator">&lt;</span>、<span class="operator">&lt;=</span> 其中的几种，则跳过索引第一列，将其余<span class="keyword">where</span>条件中索引相关列全部加入到Index <span class="keyword">Filter</span>之中；若索引第一列的<span class="keyword">where</span>条件包含 <span class="operator">=</span>、<span class="operator">&gt;=</span>、<span class="operator">&gt;</span>、<span class="operator">&lt;</span>、<span class="operator">&lt;=</span> 之外的条件，则将此条件以及其余<span class="keyword">where</span>条件中索引相关列全部加入到Index <span class="keyword">Filter</span>之中；若第一列不包含查询条件，则将所有索引相关条件均加入到Index <span class="keyword">Filter</span>之中。</span><br><span class="line"></span><br><span class="line">针对上面的用例<span class="keyword">SQL</span>，索引第一列只包含 <span class="operator">&gt;=</span>、<span class="operator">&lt;</span> 两个条件，因此第一列可跳过，将余下的c、d两列加入到Index <span class="keyword">Filter</span>中。因此获得的Index <span class="keyword">Filter</span>为 c <span class="operator">&gt;</span> <span class="number">1</span> <span class="keyword">and</span> d <span class="operator">!=</span> <span class="number">4</span> 。</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> <span class="keyword">Table</span> <span class="keyword">Filter</span></span><br><span class="line"><span class="keyword">Table</span> <span class="keyword">Filter</span>是最简单也是提取最为方便的。提取规则：所有不属于索引列的查询条件，均归为<span class="keyword">Table</span> <span class="keyword">Filter</span>之中。同样，针对上面的用例<span class="keyword">SQL</span>，<span class="keyword">Table</span> <span class="keyword">Filter</span>就为 e <span class="operator">!=</span> <span class="string">&#x27;a&#x27;</span>。</span><br></pre></td></tr></table></figure>

<h3 id="Index-Key-Index-Filter-Table-Filter小结"><a href="#Index-Key-Index-Filter-Table-Filter小结" class="headerlink" title="Index Key  Index Filter  Table Filter小结"></a>Index Key  Index Filter  Table Filter小结</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span>语句中的<span class="keyword">where</span>条件，使用以上的提取规则，最终都会被提取到Index Key (<span class="keyword">First</span> Key <span class="operator">&amp;</span> <span class="keyword">Last</span> Key)，Index <span class="keyword">Filter</span>与<span class="keyword">Table</span> <span class="keyword">Filter</span>之中。</span><br><span class="line"></span><br><span class="line">Index <span class="keyword">First</span> Key，只是用来定位索引的起始范围，因此只在索引第一次<span class="keyword">Search</span> Path(沿着索引B<span class="operator">+</span>树的根节点一直遍历，到索引正确的叶节点位置)时使用，一次判断即可；</span><br><span class="line"></span><br><span class="line">Index <span class="keyword">Last</span> Key，用来定位索引的终止范围，因此对于起始范围之后读到的每一条索引记录，均需要判断是否已经超过了Index <span class="keyword">Last</span> Key的范围，若超过，则当前查询结束；</span><br><span class="line"></span><br><span class="line">Index <span class="keyword">Filter</span>，用于过滤索引查询范围中不满足查询条件的记录，因此对于索引范围中的每一条记录，均需要与Index <span class="keyword">Filter</span>进行对比，若不满足Index <span class="keyword">Filter</span>则直接丢弃，继续读取索引下一条记录；</span><br><span class="line"></span><br><span class="line"><span class="keyword">Table</span> <span class="keyword">Filter</span>，则是最后一道<span class="keyword">where</span>条件的防线，用于过滤通过前面索引的层层考验的记录，此时的记录已经满足了Index <span class="keyword">First</span> Key与Index <span class="keyword">Last</span> Key构成的范围，并且满足Index <span class="keyword">Filter</span>的条件，回表读取了完整的记录，判断完整记录是否满足<span class="keyword">Table</span> <span class="keyword">Filter</span>中的查询条件，同样的，若不满足，跳过当前记录，继续读取索引的下一条记录，若满足，则返回记录，此记录满足了<span class="keyword">where</span>的所有条件，可以返回给用户。</span><br><span class="line"></span><br><span class="line"><span class="comment">-- MySQL 5.6中引入的ICP，究竟是将什么Push Down到索引层面进行过滤呢？</span></span><br><span class="line">答案是Index <span class="keyword">Filter</span>。在MySQL <span class="number">5.6</span>之前，并不区分Index <span class="keyword">Filter</span>与<span class="keyword">Table</span> <span class="keyword">Filter</span>，统统将Index <span class="keyword">First</span> Key与Index <span class="keyword">Last</span> Key范围内的索引记录，回表读取完整记录，然后返回给MySQL Server层进行过滤。在MySQL <span class="number">5.6</span>之后，Index <span class="keyword">Filter</span>与<span class="keyword">Table</span> <span class="keyword">Filter</span>分离，Index <span class="keyword">Filter</span>下降到InnoDB的索引层面进行过滤，减少了回表与返回MySQL Server层的记录交互开销，提高了<span class="keyword">SQL</span>的执行效率。</span><br></pre></td></tr></table></figure>


<h2 id="第27篇：MySQL如何确保数据不丢失？"><a href="#第27篇：MySQL如何确保数据不丢失？" class="headerlink" title="第27篇：MySQL如何确保数据不丢失？"></a>第27篇：MySQL如何确保数据不丢失？</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">预备知识</span><br><span class="line"><span class="number">1.</span> mysql内部是使用b<span class="operator">+</span>树的结构将数据存储在磁盘中，b<span class="operator">+</span>树中节点对应mysql中的页，mysql和磁盘交互的最小单位为页，页默认情况下为<span class="number">16</span>kb，表中的数据记录存储在b<span class="operator">+</span>树的叶子节点中，当我们需要修改、删除、插入数据时，都需要按照页来对磁盘进行操作。</span><br><span class="line"><span class="number">2.</span> 磁盘顺序写比随机写效率要高很多，通常我们使用的是机械硬盘，机械硬盘写数据时涉及磁盘寻道、磁盘旋转寻址、数据写入的时间，耗时比较长，如果是顺序写，省去了寻道和磁盘旋转的时间，效率会高几个数量级。</span><br><span class="line"><span class="number">3.</span> 内存中数据读写操作比磁盘中数据读写操作速度高好多个数量级。</span><br></pre></td></tr></table></figure>
<h3 id="MySQL确保数据不丢失原理"><a href="#MySQL确保数据不丢失原理" class="headerlink" title="MySQL确保数据不丢失原理"></a>MySQL确保数据不丢失原理</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">start</span> transaction; </span><br><span class="line"><span class="keyword">update</span> t_user <span class="keyword">set</span> name <span class="operator">=</span> <span class="string">&#x27;路人甲Java&#x27;</span> <span class="keyword">where</span> user_id <span class="operator">=</span> <span class="number">666</span>; </span><br><span class="line"><span class="keyword">commit</span>;</span><br><span class="line"></span><br><span class="line">按照正常的思路，通常过程如下：</span><br><span class="line"><span class="number">1.</span> 找到user_id<span class="operator">=</span><span class="number">666</span>这条记录所在的页p1，将p1从磁盘加载到内存中</span><br><span class="line"><span class="number">2.</span> 在内存中对p1中user_id<span class="operator">=</span><span class="number">666</span>这条记录信息进行修改</span><br><span class="line"><span class="number">3.</span> mysql收到<span class="keyword">commit</span>指令</span><br><span class="line"><span class="number">4.</span> 将p1页写入磁盘</span><br><span class="line"><span class="number">5.</span> 给客户端返回更新成功</span><br><span class="line">上面过程可以确保数据被持久化到了磁盘中。</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">我们将需求改一下，如下：</span><br><span class="line"><span class="keyword">start</span> transaction; </span><br><span class="line"><span class="keyword">update</span> t_user <span class="keyword">set</span> name <span class="operator">=</span> <span class="string">&#x27;路人甲Java&#x27;</span> <span class="keyword">where</span> user_id <span class="operator">=</span> <span class="number">666</span>; </span><br><span class="line"><span class="keyword">update</span> t_user <span class="keyword">set</span> name <span class="operator">=</span> <span class="string">&#x27;javacode2018&#x27;</span> <span class="keyword">where</span> user_id <span class="operator">=</span> <span class="number">888</span>; </span><br><span class="line"><span class="keyword">commit</span>;</span><br><span class="line"></span><br><span class="line">来看一下处理过程：</span><br><span class="line"><span class="number">1.</span> 找到user_id<span class="operator">=</span><span class="number">666</span>这条记录所在的页p1，将p1从磁盘加载到内存中</span><br><span class="line"><span class="number">2.</span> 在内存中对p1中user_id<span class="operator">=</span><span class="number">666</span>这条记录信息进行修改</span><br><span class="line"><span class="number">3.</span> 找到user_id<span class="operator">=</span><span class="number">888</span>这条记录所在的页p2，将p2从磁盘加载到内存中</span><br><span class="line"><span class="number">4.</span> 在内存中对p2中user_id<span class="operator">=</span><span class="number">888</span>这条记录信息进行修改</span><br><span class="line"><span class="number">5.</span> mysql收到<span class="keyword">commit</span>指令</span><br><span class="line"><span class="number">6.</span> 将p1页写入磁盘</span><br><span class="line"><span class="number">7.</span> 将p2页写入磁盘</span><br><span class="line"><span class="number">8.</span> 给客户端返回更新成功</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--上面过程我们看有什么问题</span></span><br><span class="line"><span class="comment">--1. 假如6成功之后，mysql宕机了，此时p1修改已写入磁盘，但是p2的修改还未写入磁盘，最终导致user_id=666的记录被修改成功了，user_id=888的数据被修改失败了，数据是有问题的</span></span><br><span class="line"><span class="comment">--2. 上面p1和p2可能位于磁盘的不同位置，涉及到磁盘随机写的问题，导致整个过程耗时也比较长</span></span><br><span class="line">上面问题可以归纳为<span class="number">2</span>点：无法确保数据可靠性、随机写导致耗时比较长。</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 关于上面问题，我们看一下mysql是如何优化的，mysql内部引入了一个redo log，这是一个文件，对于上面2条更新操作，mysql实现如下：</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- mysql内部有个redo log buffer，是内存中一块区域，我们将其理解为数组结构，向redo log文件中写数据时，会先将内容写入redo log buffer中，后续会将这个buffer中的内容写入磁盘中的redo log文件，这个redo log buffer是整个mysql中所有连接共享的内存区域，可以被重复使用。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--1. mysql收到start transaction后，生成一个全局的事务编号trx_id，比如trx_id=10</span></span><br><span class="line"><span class="comment">--2. user_id=666这个记录我们就叫r1，user_id=888这个记录叫r2</span></span><br><span class="line"><span class="comment">--3. 找到r1记录所在的数据页p1，将其从磁盘中加载到内存中</span></span><br><span class="line"><span class="comment">--4. 在内存中找到r1在p1中的位置，然后对p1进行修改（这个过程可以描述为：将p1中的pos_start1到pos_start2位置的值改为v1），这个过程我们记为rb1(内部包含事务编号trx_id)，将rb1放入redo log buffer数组中，此时p1的信息在内存中被修改了，和磁盘中p1的数据不一样了</span></span><br><span class="line"><span class="comment">--5. 找到r2记录所在的数据页p2，将其从磁盘中加载到内存中</span></span><br><span class="line"><span class="comment">--6. 在内存中找到r2在p2中的位置，然后对p2进行修改（这个过程可以描述为：将p2中的pos_start1到pos_start2位置的值改为v2），这个过程我们记为rb2(内部包含事务编号trx_id)，将rb2放入redo log buffer数组中，此时p2的信息在内存中被修改了，和磁盘中p2的数据不一样了</span></span><br><span class="line"><span class="comment">--7. 此时redo log buffer数组中有2条记录[rb1,rb2]</span></span><br><span class="line"><span class="comment">--8. mysql收到commit指令</span></span><br><span class="line"><span class="comment">--9. 将redo log buffer数组中内容写入到redo log文件中，写入的内容：</span></span><br><span class="line">	<span class="number">1.</span><span class="keyword">start</span> trx<span class="operator">=</span><span class="number">10</span>; </span><br><span class="line">	<span class="number">2.</span>写入rb1 </span><br><span class="line">	<span class="number">3.</span>写入rb2 </span><br><span class="line">	<span class="number">4.</span><span class="keyword">end</span> trx<span class="operator">=</span><span class="number">10</span>;</span><br><span class="line"><span class="comment">--10. 返回给客户端更新成功</span></span><br><span class="line"></span><br><span class="line">上面过程执行完毕之后，数据是这样的：</span><br><span class="line"><span class="number">1.</span> 内存中p1、p2页被修改了，还未同步到磁盘中，此时内存中数据页和磁盘中数据页是不一致的，此时内存中数据页我们称为脏页</span><br><span class="line"><span class="number">2.</span> 对p1、p2页修改被持久到磁盘中的redo log文件中了，不会丢失认真看一下上面过程中第<span class="number">9</span>步骤，一个成功的事务记录在redo log中是有<span class="keyword">start</span>和<span class="keyword">end</span>的，redo log文件中如果一个trx_id对应<span class="keyword">start</span>和<span class="keyword">end</span>成对出现，说明这个事务执行成功了，如果只有<span class="keyword">start</span>没有<span class="keyword">end</span>说明是有问题的。</span><br></pre></td></tr></table></figure>
<h3 id="修改何时同步到磁盘中？"><a href="#修改何时同步到磁盘中？" class="headerlink" title="修改何时同步到磁盘中？"></a>修改何时同步到磁盘中？</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">redo log是mysql中所有连接共享的文件，对mysql执行<span class="keyword">insert</span>、<span class="keyword">delete</span>和上面<span class="keyword">update</span>的过程类似，都是先在内存中修改页数据，然后将修改过程持久化到redo log所在的磁盘文件中，然后返回成功。</span><br><span class="line"></span><br><span class="line">redo log文件是有大小的，需要重复利用的，当redo log满了，或者系统比较闲的时候，会对redo log文件中的内容进行处理，处理过程如下：</span><br><span class="line"><span class="number">1.</span> 读取redo log信息，读取一个完整的trx_id对应的信息，然后进行处理</span><br><span class="line"><span class="number">2.</span> 比如读取到了trx_id<span class="operator">=</span><span class="number">10</span>的完整内容，包含了<span class="keyword">start</span> <span class="keyword">end</span>，表示这个事务操作是成功的，然后继续向下	</span><br><span class="line"><span class="number">3.</span> 判断p1在内存中是否存在，如果存在，则直接将p1信息写到p1所在的磁盘中；如果p1在内存中不存在，则将p1从磁盘加载到内存，通过redo log中的信息在内存中对p1进行修改，然后将其写到磁盘中</span><br><span class="line"><span class="comment">--上面的update之后，p1在内存中是存在的，并且p1是已经被修改过的，可以直接刷新到磁盘中。</span></span><br><span class="line"><span class="comment">--如果上面的update之后，mysql宕机，然后重启了，p1在内存中是不存在的，此时系统会读取redo log文件中的内容进行恢复处理。</span></span><br><span class="line"><span class="number">4.</span> 将redo log文件中trx_id<span class="operator">=</span><span class="number">10</span>的占有的空间标记为已处理，这块空间会被释放出来可以重复利用了</span><br><span class="line"><span class="number">5.</span> 如果第<span class="number">2</span>步读取到的trx_id对应的内容没有<span class="keyword">end</span>，表示这个事务执行到一半失败了，此时这个记录是无效的，可以直接跳过不用处理</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">上面的过程做到了：数据最后一定会被持久化到磁盘中的页中，不会丢失，做到了可靠性。</span><br><span class="line"></span><br><span class="line">并且内部采用了先把页的修改操作先在内存中进行操作，然后再写入了redo log文件，此处redo log是按顺序写的，使用到了io的顺序写，效率会非常高。</span><br><span class="line"></span><br><span class="line">对于将数据页的变更持久化到磁盘中，此处又采用了异步的方式去读取redo log的内容，然后将页的变更刷到磁盘中，这块的设计也非常好，异步刷盘操作！</span><br><span class="line"></span><br><span class="line">但是有一种情况，当一个事务<span class="keyword">commit</span>的时候，刚好发现redo log不够了，此时会先停下来处理redo log中的内容，然后在进行后续的操作，遇到这种情况时，整个事务响应会稍微慢一些。</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql中还有一个binlog，在事务操作过程中也会写binlog。</span><br><span class="line"></span><br><span class="line">先说一下binlog的作用，binlog中详细记录了对数据库做了什么操作，算是对数据库操作的一个流水，这个流水也是相当重要的，主从同步就是使用binlog来实现的，从库读取主库中binlog的信息，然后在从库中执行，最后，从库就和主库信息保持同步一致了。</span><br><span class="line"></span><br><span class="line">我们来看一下系统如何确保 redo log 和 binlog 一致性的，都写入成功的。</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 还是以update为例：</span></span><br><span class="line"><span class="keyword">start</span> transaction;</span><br><span class="line"><span class="keyword">update</span> t_user <span class="keyword">set</span> name <span class="operator">=</span> <span class="string">&#x27;路人甲Java&#x27;</span> <span class="keyword">where</span> user_id <span class="operator">=</span> <span class="number">666</span>; </span><br><span class="line"><span class="keyword">update</span> t_user <span class="keyword">set</span> name <span class="operator">=</span> <span class="string">&#x27;javacode2018&#x27;</span> <span class="keyword">where</span> user_id <span class="operator">=</span> <span class="number">888</span>; </span><br><span class="line"><span class="keyword">commit</span>;</span><br><span class="line"></span><br><span class="line">一个事务中可能有很多操作，这些操作会写很多binlog日志，为了加快写的速度，mysql先把整个过程中产生的binlog日志先写到内存中的binlog cache缓存中，后面再将binlog cache中内容一次性持久化到binlog文件中。</span><br><span class="line"></span><br><span class="line">一个事务的 binlog 是不能被拆开的，因此不论这个事务多大，也要确保一次性写入。这就涉及到了 binlog cache 的保存问题。系统给 binlog cache 分配了一片内存，每个线程一个，参数 binlog_cache_size 用于控制单个线程内 binlog cache 所占内存的大小。如果超过了这个参数规定的大小，就要暂存到磁盘。</span><br><span class="line"></span><br><span class="line">过程如下：</span><br><span class="line"><span class="number">1.</span> mysql收到<span class="keyword">start</span> transaction后，生成一个全局的事务编号trx_id，比如trx_id<span class="operator">=</span><span class="number">10</span></span><br><span class="line"><span class="number">2.</span> user_id<span class="operator">=</span><span class="number">666</span>这个记录我们就叫r1，user_id<span class="operator">=</span><span class="number">888</span>这个记录叫r2</span><br><span class="line"><span class="number">3.</span> 找到r1记录所在的数据页p1，将其从磁盘中加载到内存中</span><br><span class="line"><span class="number">4.</span> 在内存中对p1进行修改</span><br><span class="line"><span class="number">5.</span> 将p1修改操作记录到redo log buffer中 </span><br><span class="line"><span class="number">6.</span> 将p1修改记录流水记录到binlog cache中</span><br><span class="line"><span class="number">7.</span> 找到r2记录所在的数据页p2，将其从磁盘中加载到内存中</span><br><span class="line"><span class="number">8.</span> 在内存中对p2进行修改</span><br><span class="line"><span class="number">9.</span> 将p2修改操作记录到redo log buffer中</span><br><span class="line"><span class="number">10.</span> 将p2修改记录流水记录到binlog cache中</span><br><span class="line"><span class="number">11.</span> mysql收到<span class="keyword">commit</span>指令</span><br><span class="line"><span class="number">12.</span> 将redo log buffer携带trx_id<span class="operator">=</span><span class="number">10</span>写入到redo log文件，持久化到磁盘，这步操作叫做redo log <span class="keyword">prepare</span>，</span><br><span class="line">	内容如下:</span><br><span class="line">	<span class="number">1.</span><span class="keyword">start</span> trx<span class="operator">=</span><span class="number">10</span>; </span><br><span class="line">	<span class="number">2.</span>写入rb1 </span><br><span class="line">	<span class="number">3.</span>写入rb2 </span><br><span class="line">	<span class="number">4.</span><span class="keyword">prepare</span> trx<span class="operator">=</span><span class="number">10</span>;</span><br><span class="line">	注意上面是<span class="keyword">prepare</span>了，不是之前说的<span class="keyword">end</span>了。</span><br><span class="line"><span class="number">13.</span> 将binlog cache携带trx_id<span class="operator">=</span><span class="number">10</span>写入到binlog文件，持久化到磁盘</span><br><span class="line"><span class="number">14.</span> 向redo log中写入一条数据： <span class="keyword">end</span> trx<span class="operator">=</span><span class="number">10</span>; 表示redo log中这个事务完成了，这步操作叫做redo log <span class="keyword">commit</span></span><br><span class="line"><span class="number">15.</span> 返回给客户端更新成功	</span><br><span class="line"> </span><br><span class="line"><span class="comment">--我们来分析一下上面过程可能出现的一些情况：</span></span><br><span class="line"><span class="comment">--1. 步骤10操作完成后，mysql宕机了</span></span><br><span class="line">宕机之前，所有修改都位于内存中，mysql重启之后，内存修改还未同步到磁盘，对磁盘数据没有影响，所以无影响。</span><br><span class="line"></span><br><span class="line"><span class="comment">--2. 步骤12执行完毕之后，mysql宕机了</span></span><br><span class="line">此时redo log <span class="keyword">prepare</span>过程是写入redo log文件了，但是binlog写入失败了，此时mysql重启之后会读取redo log进行恢复处理，查询到trx_id<span class="operator">=</span><span class="number">10</span>的记录是<span class="keyword">prepare</span>状态，会去binlog中查找trx_id<span class="operator">=</span><span class="number">10</span>的操作在binlog中是否存在，如果不存在，说明binlog写入失败了，此时可以将此操作回滚</span><br><span class="line"></span><br><span class="line"><span class="comment">--3. 步骤13执行完毕之后，mysql宕机</span></span><br><span class="line">此时redo log <span class="keyword">prepare</span>过程是写入redo log文件了，但是binlog写入失败了，此时mysql重启之后会读取redo log进行恢复处理，查询到trx_id<span class="operator">=</span><span class="number">10</span>的记录是<span class="keyword">prepare</span>状态，会去binlog中查找trx_id<span class="operator">=</span><span class="number">10</span>的操作在binlog是存在的，然后接着执行上面的步骤<span class="number">14</span>和<span class="number">15.</span></span><br></pre></td></tr></table></figure>
<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 日志先行，io顺序写，异步操作，做到了高效操作</span></span><br><span class="line">对数据页，先在内存中修改，然后使用io顺序写的方式持久化到redo log文件；然后异步去处理redo log，将数据页的修改持久化到磁盘中，效率非常高，整个过程，其实就是 MySQL 里经常说到的 WAL 技术，WAL 的全称是 Write<span class="operator">-</span>Ahead Logging，它的关键点就是先写日志，再写磁盘。</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 两阶段提交确保redo log和binlog一致性</span></span><br><span class="line">为了确保redo log和binlog一致性，此处使用了二阶段提交技术，redo log 和binlog的写分了<span class="number">3</span>步走：</span><br><span class="line"><span class="number">1.</span> 携带trx_id，redo log <span class="keyword">prepare</span>到磁盘</span><br><span class="line"><span class="number">2.</span> 携带trx_id，binlog写入磁盘</span><br><span class="line"><span class="number">3.</span> 携带trx_id，redo log <span class="keyword">commit</span>到磁盘</span><br><span class="line">上面<span class="number">3</span>步骤，可以确保同一个trx_id关联的redo log 和binlog的可靠性。</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/MySQL/" rel="tag">MySQL</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/01/23/MySQL%E7%BB%83%E4%B9%A0%E9%A2%98/" rel="prev" title="MySQL练习题">
      <i class="fa fa-chevron-left"></i> MySQL练习题
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/01/25/MySQL%E9%AB%98%E7%BA%A7/" rel="next" title="MySQL高级">
      MySQL高级 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#MySQL%E6%95%B4%E7%90%86"><span class="nav-number">1.</span> <span class="nav-text">MySQL整理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC1%E7%AF%87%EF%BC%9AMySQL%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="nav-number">1.1.</span> <span class="nav-text">第1篇：MySQL基础知识</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4"><span class="nav-number">1.1.1.</span> <span class="nav-text">基本命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95%E8%A7%84%E8%8C%83"><span class="nav-number">1.1.2.</span> <span class="nav-text">语法规范</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SQL%E7%9A%84%E8%AF%AD%E8%A8%80%E5%88%86%E7%B1%BB"><span class="nav-number">1.1.3.</span> <span class="nav-text">SQL的语言分类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%89%E8%8C%83%E5%BC%8F"><span class="nav-number">1.1.4.</span> <span class="nav-text">数据库三范式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC2%E7%AF%87%EF%BC%9AMySQL%E4%B8%AD%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="nav-number">1.2.</span> <span class="nav-text">第2篇：MySQL中数据类型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B4%E6%95%B0%E7%B1%BB%E5%9E%8B"><span class="nav-number">1.2.1.</span> <span class="nav-text">整数类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%AE%E7%82%B9%E7%B1%BB%E5%9E%8B"><span class="nav-number">1.2.2.</span> <span class="nav-text">浮点类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%A5%E6%9C%9F%E7%B1%BB%E5%9E%8B"><span class="nav-number">1.2.3.</span> <span class="nav-text">日期类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%B1%BB%E5%9E%8B"><span class="nav-number">1.2.4.</span> <span class="nav-text">字符串类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MySQL%E7%B1%BB%E5%9E%8B%E5%92%8CJava%E5%AF%B9%E5%BA%94%E5%85%B3%E7%B3%BB"><span class="nav-number">1.2.5.</span> <span class="nav-text">MySQL类型和Java对应关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E9%80%89%E6%8B%A9%E7%9A%84%E4%B8%80%E4%BA%9B%E5%BB%BA%E8%AE%AE"><span class="nav-number">1.2.6.</span> <span class="nav-text">数据类型选择的一些建议</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC3%E7%AF%87%EF%BC%9A%E7%AE%A1%E7%90%86%E5%91%98%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="nav-number">1.3.</span> <span class="nav-text">第3篇：管理员常用命令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#MySQL%E6%9D%83%E9%99%90%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="nav-number">1.3.1.</span> <span class="nav-text">MySQL权限工作原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E7%94%9F%E6%95%88%E6%97%B6%E9%97%B4"><span class="nav-number">1.3.2.</span> <span class="nav-text">权限生效时间</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8Bmysql%E4%B8%AD%E6%89%80%E6%9C%89%E7%94%A8%E6%88%B7"><span class="nav-number">1.3.3.</span> <span class="nav-text">查看mysql中所有用户</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7"><span class="nav-number">1.3.4.</span> <span class="nav-text">创建用户</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E5%AF%86%E7%A0%81%E3%80%903%E7%A7%8D%E6%96%B9%E5%BC%8F%E3%80%91"><span class="nav-number">1.3.5.</span> <span class="nav-text">修改密码【3种方式】</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%99%E7%94%A8%E6%88%B7%E6%8E%88%E6%9D%83"><span class="nav-number">1.3.6.</span> <span class="nav-text">给用户授权</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E7%94%A8%E6%88%B7%E6%9C%89%E5%93%AA%E4%BA%9B%E6%9D%83%E9%99%90"><span class="nav-number">1.3.7.</span> <span class="nav-text">查看用户有哪些权限</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%92%A4%E9%94%80%E7%94%A8%E6%88%B7%E7%9A%84%E6%9D%83%E9%99%90"><span class="nav-number">1.3.8.</span> <span class="nav-text">撤销用户的权限</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E7%94%A8%E6%88%B7%E3%80%902%E7%A7%8D%E6%96%B9%E5%BC%8F%E3%80%91"><span class="nav-number">1.3.9.</span> <span class="nav-text">删除用户【2种方式】</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">1.3.10.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC4%E7%AF%87%EF%BC%9ADDL%E5%B8%B8%E8%A7%81%E6%93%8D%E4%BD%9C%E6%B1%87%E6%80%BB"><span class="nav-number">1.4.</span> <span class="nav-text">第4篇：DDL常见操作汇总</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%93%E7%9A%84%E7%AE%A1%E7%90%86"><span class="nav-number">1.4.1.</span> <span class="nav-text">库的管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A1%A8%E7%AE%A1%E7%90%86"><span class="nav-number">1.4.2.</span> <span class="nav-text">表管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E8%A1%A8"><span class="nav-number">1.4.2.1.</span> <span class="nav-text">创建表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E8%A1%A8"><span class="nav-number">1.4.2.2.</span> <span class="nav-text">删除表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E8%A1%A8%E5%90%8D"><span class="nav-number">1.4.2.3.</span> <span class="nav-text">修改表名</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A1%A8%E8%AE%BE%E7%BD%AE%E5%A4%87%E6%B3%A8"><span class="nav-number">1.4.2.4.</span> <span class="nav-text">表设置备注</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%8D%E5%88%B6%E8%A1%A8"><span class="nav-number">1.4.2.5.</span> <span class="nav-text">复制表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A1%A8%E4%B8%AD%E5%88%97%E7%9A%84%E7%AE%A1%E7%90%86"><span class="nav-number">1.4.2.6.</span> <span class="nav-text">表中列的管理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BA%A6%E6%9D%9F%E7%AE%A1%E7%90%86%EF%BC%88%E8%A1%A5%E5%85%85%EF%BC%89"><span class="nav-number">1.4.3.</span> <span class="nav-text">约束管理（补充）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%BB%E9%94%AE%E7%BA%A6%E6%9D%9F"><span class="nav-number">1.4.3.1.</span> <span class="nav-text">主键约束</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%96%E9%94%AE%E7%BA%A6%E6%9D%9F"><span class="nav-number">1.4.3.2.</span> <span class="nav-text">外键约束</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%94%AF%E4%B8%80%E7%BA%A6%E6%9D%9F"><span class="nav-number">1.4.3.3.</span> <span class="nav-text">唯一约束</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A3%80%E6%9F%A5%E7%BA%A6%E6%9D%9F%E3%80%81%E9%9D%9E%E7%A9%BA%E7%BA%A6%E6%9D%9F%E5%92%8C%E9%BB%98%E8%AE%A4%E5%80%BC%E7%BA%A6%E6%9D%9F"><span class="nav-number">1.4.3.4.</span> <span class="nav-text">检查约束、非空约束和默认值约束</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC5%E7%AF%87%EF%BC%9ADML%E5%B8%B8%E8%A7%81%E6%93%8D%E4%BD%9C"><span class="nav-number">1.5.</span> <span class="nav-text">第5篇：DML常见操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8F%92%E5%85%A5%E5%8D%95%E8%A1%8C2%E7%A7%8D%E6%96%B9%E5%BC%8F"><span class="nav-number">1.5.1.</span> <span class="nav-text">插入单行2种方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%B9%E9%87%8F%E6%8F%92%E5%85%A52%E7%A7%8D%E6%96%B9%E5%BC%8F"><span class="nav-number">1.5.2.</span> <span class="nav-text">批量插入2种方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E6%9B%B4%E6%96%B0"><span class="nav-number">1.5.3.</span> <span class="nav-text">数据更新</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C"><span class="nav-number">1.5.4.</span> <span class="nav-text">删除数据操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#drop%EF%BC%8Ctruncate%EF%BC%8Cdelete%E5%8C%BA%E5%88%AB"><span class="nav-number">1.5.5.</span> <span class="nav-text">drop，truncate，delete区别</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC6%E7%AF%87%EF%BC%9Aselect%E6%9F%A5%E8%AF%A2%E5%9F%BA%E7%A1%80"><span class="nav-number">1.6.</span> <span class="nav-text">第6篇：select查询基础</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC7%E7%AF%87%EF%BC%9Aselect%E6%9D%A1%E4%BB%B6%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.7.</span> <span class="nav-text">第7篇：select条件查询</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC8%E7%AF%87%EF%BC%9A%E6%8E%92%E5%BA%8F%E5%92%8C%E5%88%86%E9%A1%B5"><span class="nav-number">1.8.</span> <span class="nav-text">第8篇：排序和分页</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC9%E7%AF%87%EF%BC%9A%E5%88%86%E7%BB%84%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.9.</span> <span class="nav-text">第9篇：分组查询</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E6%A1%88%E4%BE%8B"><span class="nav-number">1.9.1.</span> <span class="nav-text">查询案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#where-%E5%92%8C-having%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">1.9.2.</span> <span class="nav-text">where 和 having的区别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E7%BB%84%E5%90%8E%E6%8E%92%E5%BA%8F"><span class="nav-number">1.9.3.</span> <span class="nav-text">分组后排序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#where-amp-group-by-amp-having-amp-order-by-amp-limit-%E4%B8%80%E8%B5%B7%E5%8D%8F%E4%BD%9C"><span class="nav-number">1.9.4.</span> <span class="nav-text">where &amp; group by &amp; having &amp; order by &amp; limit 一起协作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MySQL%E5%88%86%E7%BB%84%E4%B8%AD%E7%9A%84%E5%9D%91"><span class="nav-number">1.9.5.</span> <span class="nav-text">MySQL分组中的坑</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC10%E7%AF%87%EF%BC%9A%E5%B8%B8%E7%94%A8%E5%87%BD%E6%95%B0"><span class="nav-number">1.10.</span> <span class="nav-text">第10篇：常用函数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#MySQL-%E6%95%B0%E5%80%BC%E5%9E%8B%E5%87%BD%E6%95%B0"><span class="nav-number">1.10.1.</span> <span class="nav-text">MySQL 数值型函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MySQL-%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%87%BD%E6%95%B0"><span class="nav-number">1.10.2.</span> <span class="nav-text">MySQL 字符串函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MySQL-%E6%97%A5%E6%9C%9F%E5%92%8C%E6%97%B6%E9%97%B4%E5%87%BD%E6%95%B0"><span class="nav-number">1.10.3.</span> <span class="nav-text">MySQL 日期和时间函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MySQL-%E8%81%9A%E5%90%88%E5%87%BD%E6%95%B0-%E7%95%A5"><span class="nav-number">1.10.4.</span> <span class="nav-text">MySQL 聚合函数 略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MySQL-%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E5%87%BD%E6%95%B0"><span class="nav-number">1.10.5.</span> <span class="nav-text">MySQL 流程控制函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E5%87%BD%E6%95%B0"><span class="nav-number">1.10.6.</span> <span class="nav-text">其他函数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC11%E7%AF%87%EF%BC%9A%E6%B7%B1%E5%85%A5%E4%BA%86%E8%A7%A3%E8%BF%9E%E6%8E%A5%E6%9F%A5%E8%AF%A2%E5%8F%8A%E5%8E%9F%E7%90%86"><span class="nav-number">1.11.</span> <span class="nav-text">第11篇：深入了解连接查询及原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%9B%E5%8D%A1%E5%B0%94%E7%A7%AF"><span class="nav-number">1.11.1.</span> <span class="nav-text">笛卡尔积</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E8%BF%9E%E6%8E%A5"><span class="nav-number">1.11.2.</span> <span class="nav-text">内连接</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B7%A6%E8%BF%9E%E6%8E%A5"><span class="nav-number">1.11.2.1.</span> <span class="nav-text">左连接</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%B3%E8%BF%9E%E6%8E%A5"><span class="nav-number">1.11.2.2.</span> <span class="nav-text">右连接</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%A8%E8%BF%9E%E6%8E%A5"><span class="nav-number">1.11.3.</span> <span class="nav-text">全连接</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC12%E7%AF%87%EF%BC%9A%E5%AD%90%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.12.</span> <span class="nav-text">第12篇：子查询</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#select%E5%90%8E%E9%9D%A2%E7%9A%84%E5%AD%90%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.12.1.</span> <span class="nav-text">select后面的子查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#from%E5%90%8E%E9%9D%A2%E7%9A%84%E5%AD%90%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.12.2.</span> <span class="nav-text">from后面的子查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#where%E5%92%8Chaving%E5%90%8E%E9%9D%A2%E7%9A%84%E5%AD%90%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.12.3.</span> <span class="nav-text">where和having后面的子查询</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%87%E9%87%8F%E5%AD%90%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.12.3.1.</span> <span class="nav-text">标量子查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%97%E5%AD%90%E6%9F%A5%E8%AF%A2-%E5%AD%90%E6%9F%A5%E8%AF%A2%E7%BB%93%E6%9E%9C%E9%9B%86%E4%B8%80%E5%88%97%E5%A4%9A%E8%A1%8C"><span class="nav-number">1.12.3.2.</span> <span class="nav-text">列子查询(子查询结果集一列多行)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A1%8C%E5%AD%90%E6%9F%A5%E8%AF%A2-%E5%AD%90%E6%9F%A5%E8%AF%A2%E7%BB%93%E6%9E%9C%E9%9B%86%E4%B8%80%E8%A1%8C%E5%A4%9A%E5%88%97%EF%BC%89"><span class="nav-number">1.12.3.3.</span> <span class="nav-text">行子查询(子查询结果集一行多列）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exists%E5%90%8E%E9%9D%A2%EF%BC%88%E7%9B%B8%E5%85%B3%E5%AD%90%E6%9F%A5%E8%AF%A2%EF%BC%89"><span class="nav-number">1.12.4.</span> <span class="nav-text">exists后面（相关子查询）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NULL%E7%9A%84%E5%A4%A7%E5%9D%91"><span class="nav-number">1.12.5.</span> <span class="nav-text">NULL的大坑</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC13%E7%AF%87%EF%BC%9A%E7%BB%86%E8%AF%B4NULL%E5%AF%BC%E8%87%B4%E7%9A%84%E5%9D%91"><span class="nav-number">1.13.</span> <span class="nav-text">第13篇：细说NULL导致的坑</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AF%94%E8%BE%83%E8%BF%90%E7%AE%97%E7%AC%A6%E4%B8%AD%E4%BD%BF%E7%94%A8NULL"><span class="nav-number">1.13.1.</span> <span class="nav-text">比较运算符中使用NULL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IN%E5%92%8CNULL%E6%AF%94%E8%BE%83"><span class="nav-number">1.13.2.</span> <span class="nav-text">IN和NULL比较</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NOT-IN-%E5%92%8CNULL%E6%AF%94%E8%BE%83"><span class="nav-number">1.13.3.</span> <span class="nav-text">NOT IN 和NULL比较</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#EXISTS%E3%80%81NOT-EXISTS%E5%92%8CNULL%E6%AF%94%E8%BE%83"><span class="nav-number">1.13.4.</span> <span class="nav-text">EXISTS、NOT EXISTS和NULL比较</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A4%E6%96%ADNULL%E7%94%A8IS-NULL%E3%80%81IS-NOT-NULL"><span class="nav-number">1.13.5.</span> <span class="nav-text">判断NULL用IS NULL、IS NOT NULL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%81%9A%E5%90%88%E5%87%BD%E6%95%B0%E4%B8%AD%E7%9A%84NULL"><span class="nav-number">1.13.6.</span> <span class="nav-text">聚合函数中的NULL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NULL%E4%B8%8D%E8%83%BD%E4%BD%9C%E4%B8%BB%E9%94%AE%E7%9A%84%E5%80%BC"><span class="nav-number">1.13.7.</span> <span class="nav-text">NULL不能作主键的值</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC14%E7%AF%87%EF%BC%9A%E4%BA%8B%E5%8A%A1%E8%AF%A6%E8%A7%A3"><span class="nav-number">1.14.</span> <span class="nav-text">第14篇：事务详解</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC15%E7%AF%87%EF%BC%9A%E8%A7%86%E5%9B%BE"><span class="nav-number">1.15.</span> <span class="nav-text">第15篇：视图</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E8%A7%86%E5%9B%BE"><span class="nav-number">1.15.1.</span> <span class="nav-text">创建视图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E8%A7%86%E5%9B%BE"><span class="nav-number">1.15.2.</span> <span class="nav-text">修改视图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E8%A7%86%E5%9B%BE"><span class="nav-number">1.15.3.</span> <span class="nav-text">删除视图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E8%A7%86%E5%9B%BE%E7%BB%93%E6%9E%84"><span class="nav-number">1.15.4.</span> <span class="nav-text">查询视图结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0%E8%A7%86%E5%9B%BE%E3%80%90%E5%9F%BA%E6%9C%AC%E4%B8%8D%E7%94%A8%E3%80%91"><span class="nav-number">1.15.5.</span> <span class="nav-text">更新视图【基本不用】</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC16%E7%AF%87%EF%BC%9A%E5%8F%98%E9%87%8F"><span class="nav-number">1.16.</span> <span class="nav-text">第16篇：变量</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E5%8F%98%E9%87%8F"><span class="nav-number">1.16.1.</span> <span class="nav-text">系统变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F"><span class="nav-number">1.16.2.</span> <span class="nav-text">全局变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%9A%E8%AF%9D%E5%8F%98%E9%87%8F"><span class="nav-number">1.16.3.</span> <span class="nav-text">会话变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F"><span class="nav-number">1.16.4.</span> <span class="nav-text">自定义变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E5%8F%98%E9%87%8F"><span class="nav-number">1.16.5.</span> <span class="nav-text">用户变量</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%BC%E5%90%88%E7%A4%BA%E4%BE%8B"><span class="nav-number">1.16.5.1.</span> <span class="nav-text">综合示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F"><span class="nav-number">1.16.6.</span> <span class="nav-text">局部变量</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%BC%E5%90%88%E7%A4%BA%E4%BE%8B-1"><span class="nav-number">1.16.6.1.</span> <span class="nav-text">综合示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E5%8F%98%E9%87%8F%E5%92%8C%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F%E5%AF%B9%E6%AF%94"><span class="nav-number">1.16.7.</span> <span class="nav-text">用户变量和局部变量对比</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC17%E7%AF%87%EF%BC%9A%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B-amp-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%87%BD%E6%95%B0%E8%AF%A6%E8%A7%A3"><span class="nav-number">1.17.</span> <span class="nav-text">第17篇：存储过程&amp;自定义函数详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="nav-number">1.17.1.</span> <span class="nav-text">存储过程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E6%A1%88%E4%BE%8B"><span class="nav-number">1.17.1.1.</span> <span class="nav-text">存储过程案例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%BD%E6%95%B0"><span class="nav-number">1.17.2.</span> <span class="nav-text">函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B"><span class="nav-number">1.17.2.1.</span> <span class="nav-text">示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E5%92%8C%E5%87%BD%E6%95%B0%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">1.17.3.</span> <span class="nav-text">存储过程和函数的区别</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC18%E7%AF%87%EF%BC%9A%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E8%AF%AD%E5%8F%A5"><span class="nav-number">1.18.</span> <span class="nav-text">第18篇：流程控制语句</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#if%E5%87%BD%E6%95%B0"><span class="nav-number">1.18.1.</span> <span class="nav-text">if函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CASE%E7%BB%93%E6%9E%84"><span class="nav-number">1.18.2.</span> <span class="nav-text">CASE结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#if%E7%BB%93%E6%9E%84"><span class="nav-number">1.18.3.</span> <span class="nav-text">if结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BE%AA%E7%8E%AF"><span class="nav-number">1.18.4.</span> <span class="nav-text">循环</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#while%E5%BE%AA%E7%8E%AF"><span class="nav-number">1.18.5.</span> <span class="nav-text">while循环</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#repeat%E5%BE%AA%E7%8E%AF"><span class="nav-number">1.18.6.</span> <span class="nav-text">repeat循环</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#loop%E5%BE%AA%E7%8E%AF"><span class="nav-number">1.18.7.</span> <span class="nav-text">loop循环</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC19%E7%AF%87%EF%BC%9A%E6%B8%B8%E6%A0%87%E8%AF%A6%E8%A7%A3-%E7%95%A5"><span class="nav-number">1.19.</span> <span class="nav-text">第19篇：游标详解   略</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC20%E7%AF%87%EF%BC%9A%E5%BC%82%E5%B8%B8%E6%8D%95%E8%8E%B7%E5%8F%8A%E5%A4%84%E7%90%86%E8%AF%A6%E8%A7%A3"><span class="nav-number">1.20.</span> <span class="nav-text">第20篇：异常捕获及处理详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E5%88%86%E7%B1%BB"><span class="nav-number">1.20.1.</span> <span class="nav-text">异常分类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MySQL%E5%86%85%E9%83%A8%E5%BC%82%E5%B8%B8"><span class="nav-number">1.20.2.</span> <span class="nav-text">MySQL内部异常</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%96%E9%83%A8%E5%BC%82%E5%B8%B8"><span class="nav-number">1.20.3.</span> <span class="nav-text">外部异常</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC21%E7%AF%87%EF%BC%9A%E4%BB%80%E4%B9%88%E6%98%AF%E7%B4%A2%E5%BC%95%EF%BC%9F"><span class="nav-number">1.21.</span> <span class="nav-text">第21篇：什么是索引？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC22%E7%AF%87%EF%BC%9AMySQL%E7%B4%A2%E5%BC%95%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3"><span class="nav-number">1.22.</span> <span class="nav-text">第22篇：MySQL索引原理详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A2%84%E5%A4%87%E7%9F%A5%E8%AF%86"><span class="nav-number">1.22.1.</span> <span class="nav-text">预备知识</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E7%9A%84%E6%A3%80%E7%B4%A2%E7%AE%97%E6%B3%95%E5%92%8C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">1.22.2.</span> <span class="nav-text">常用的检索算法和数据结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MySQL%E7%9A%84%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E5%92%8C%E7%B4%A2%E5%BC%95"><span class="nav-number">1.22.3.</span> <span class="nav-text">MySQL的存储引擎和索引</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#InnoDB%E4%B8%AD%E7%9A%84%E7%B4%A2%E5%BC%95"><span class="nav-number">1.22.3.1.</span> <span class="nav-text">InnoDB中的索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MyISAM%E4%B8%AD%E7%9A%84%E7%B4%A2%E5%BC%95"><span class="nav-number">1.22.3.2.</span> <span class="nav-text">MyISAM中的索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#InnoDB%E6%95%B0%E6%8D%AE%E6%A3%80%E7%B4%A2%E8%BF%87%E7%A8%8B"><span class="nav-number">1.22.3.3.</span> <span class="nav-text">InnoDB数据检索过程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MyISAM%E6%95%B0%E6%8D%AE%E6%A3%80%E7%B4%A2%E8%BF%87%E7%A8%8B"><span class="nav-number">1.22.3.4.</span> <span class="nav-text">MyISAM数据检索过程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%B5%E7%BB%93%E6%9E%84"><span class="nav-number">1.22.4.</span> <span class="nav-text">页结构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E6%A3%80%E7%B4%A2%E8%BF%87%E7%A8%8B"><span class="nav-number">1.22.4.1.</span> <span class="nav-text">数据检索过程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AF%B9page%E7%9A%84%E6%80%BB%E7%BB%93"><span class="nav-number">1.22.4.2.</span> <span class="nav-text">对page的总结</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC23%E7%AF%87%EF%BC%9AMySQL%E7%B4%A2%E5%BC%95%E7%AE%A1%E7%90%86"><span class="nav-number">1.23.</span> <span class="nav-text">第23篇：MySQL索引管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E5%88%86%E7%B1%BB"><span class="nav-number">1.23.1.</span> <span class="nav-text">索引分类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E7%AE%A1%E7%90%86"><span class="nav-number">1.23.2.</span> <span class="nav-text">索引管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B%EF%BC%9A%E5%87%86%E5%A4%87200%E4%B8%87%E6%95%B0%E6%8D%AE"><span class="nav-number">1.23.3.</span> <span class="nav-text">示例：准备200万数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E5%B9%B6%E6%8C%87%E5%AE%9A%E9%95%BF%E5%BA%A6"><span class="nav-number">1.23.4.</span> <span class="nav-text">创建索引并指定长度</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E8%A1%A8%E4%B8%AD%E7%9A%84%E7%B4%A2%E5%BC%95"><span class="nav-number">1.23.5.</span> <span class="nav-text">查看表中的索引</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E7%B4%A2%E5%BC%95"><span class="nav-number">1.23.6.</span> <span class="nav-text">删除索引</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC24%E7%AF%87%EF%BC%9A%E5%A6%82%E4%BD%95%E6%AD%A3%E7%A1%AE%E7%9A%84%E4%BD%BF%E7%94%A8%E7%B4%A2%E5%BC%95%EF%BC%9F"><span class="nav-number">1.24.</span> <span class="nav-text">第24篇：如何正确的使用索引？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E8%B5%B0%E7%B4%A2%E5%BC%95%E6%98%AF%E4%BB%80%E4%B9%88%E6%84%8F%E6%80%9D%EF%BC%9F"><span class="nav-number">1.24.1.</span> <span class="nav-text">查询走索引是什么意思？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#B-%E6%A0%91%E4%B8%AD%E6%95%B0%E6%8D%AE%E6%A3%80%E7%B4%A2%E8%BF%87%E7%A8%8B"><span class="nav-number">1.24.2.</span> <span class="nav-text">B+树中数据检索过程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%94%AF%E4%B8%80%E8%AE%B0%E5%BD%95%E6%A3%80%E7%B4%A2"><span class="nav-number">1.24.2.1.</span> <span class="nav-text">唯一记录检索</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E6%9F%90%E4%B8%AA%E5%80%BC%E7%9A%84%E6%89%80%E6%9C%89%E8%AE%B0%E5%BD%95"><span class="nav-number">1.24.2.2.</span> <span class="nav-text">查询某个值的所有记录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8C%83%E5%9B%B4%E6%9F%A5%E6%89%BE"><span class="nav-number">1.24.2.3.</span> <span class="nav-text">范围查找</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A8%A1%E7%B3%8A%E5%8C%B9%E9%85%8D"><span class="nav-number">1.24.2.4.</span> <span class="nav-text">模糊匹配</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%80%E5%B7%A6%E5%8C%B9%E9%85%8D%E5%8E%9F%E5%88%99"><span class="nav-number">1.24.2.5.</span> <span class="nav-text">最左匹配原则</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E5%8C%BA%E5%88%86%E5%BA%A6"><span class="nav-number">1.24.3.</span> <span class="nav-text">索引区分度</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%A3%E7%A1%AE%E4%BD%BF%E7%94%A8%E7%B4%A2%E5%BC%95"><span class="nav-number">1.24.4.</span> <span class="nav-text">正确使用索引</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%BB%E9%94%AE%E6%A3%80%E7%B4%A2"><span class="nav-number">1.24.4.1.</span> <span class="nav-text">主键检索</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#between-and%E8%8C%83%E5%9B%B4%E6%A3%80%E7%B4%A2"><span class="nav-number">1.24.4.2.</span> <span class="nav-text">between and范围检索</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#in%E7%9A%84%E6%A3%80%E7%B4%A2"><span class="nav-number">1.24.4.3.</span> <span class="nav-text">in的检索</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%9A%E4%B8%AA%E7%B4%A2%E5%BC%95%E6%97%B6%E6%9F%A5%E8%AF%A2%E5%A6%82%E4%BD%95%E8%B5%B0%EF%BC%9F"><span class="nav-number">1.24.4.4.</span> <span class="nav-text">多个索引时查询如何走？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A8%A1%E7%B3%8A%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.24.4.5.</span> <span class="nav-text">模糊查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9B%9E%E8%A1%A8"><span class="nav-number">1.24.4.6.</span> <span class="nav-text">回表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E8%A6%86%E7%9B%96"><span class="nav-number">1.24.4.7.</span> <span class="nav-text">索引覆盖</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E4%B8%8B%E6%8E%A8"><span class="nav-number">1.24.4.8.</span> <span class="nav-text">索引下推</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E5%AD%97%E4%BD%BF%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%B1%BB%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88"><span class="nav-number">1.24.4.9.</span> <span class="nav-text">数字使字符串类索引失效</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%87%BD%E6%95%B0%E4%BD%BF%E7%B4%A2%E5%BC%95%E6%97%A0%E6%95%88"><span class="nav-number">1.24.4.10.</span> <span class="nav-text">函数使索引无效</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%90%E7%AE%97%E7%AC%A6%E4%BD%BF%E7%B4%A2%E5%BC%95%E6%97%A0%E6%95%88"><span class="nav-number">1.24.4.11.</span> <span class="nav-text">运算符使索引无效</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E6%8E%92%E5%BA%8F"><span class="nav-number">1.24.4.12.</span> <span class="nav-text">使用索引优化排序</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93%E4%BD%BF%E7%94%A8%E7%B4%A2%E5%BC%95%E7%9A%84%E5%BB%BA%E8%AE%AE"><span class="nav-number">1.24.5.</span> <span class="nav-text">总结使用索引的建议</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC25%E7%AF%87%EF%BC%9ASQL%E4%B8%ADwhere%E5%9C%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E6%8F%90%E5%8F%96%E4%B8%8E%E5%BA%94%E7%94%A8"><span class="nav-number">1.25.</span> <span class="nav-text">第25篇：SQL中where在数据库中提取与应用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0"><span class="nav-number">1.25.1.</span> <span class="nav-text">问题描述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%84%E7%BB%87"><span class="nav-number">1.25.2.</span> <span class="nav-text">关系型数据库中的数据组织</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SQL%E7%9A%84where%E6%9D%A1%E4%BB%B6%E6%8F%90%E5%8F%96"><span class="nav-number">1.25.3.</span> <span class="nav-text">SQL的where条件提取</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Index-Key-Index-Filter-Table-Filter%E5%B0%8F%E7%BB%93"><span class="nav-number">1.25.4.</span> <span class="nav-text">Index Key  Index Filter  Table Filter小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC27%E7%AF%87%EF%BC%9AMySQL%E5%A6%82%E4%BD%95%E7%A1%AE%E4%BF%9D%E6%95%B0%E6%8D%AE%E4%B8%8D%E4%B8%A2%E5%A4%B1%EF%BC%9F"><span class="nav-number">1.26.</span> <span class="nav-text">第27篇：MySQL如何确保数据不丢失？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#MySQL%E7%A1%AE%E4%BF%9D%E6%95%B0%E6%8D%AE%E4%B8%8D%E4%B8%A2%E5%A4%B1%E5%8E%9F%E7%90%86"><span class="nav-number">1.26.1.</span> <span class="nav-text">MySQL确保数据不丢失原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E4%BD%95%E6%97%B6%E5%90%8C%E6%AD%A5%E5%88%B0%E7%A3%81%E7%9B%98%E4%B8%AD%EF%BC%9F"><span class="nav-number">1.26.2.</span> <span class="nav-text">修改何时同步到磁盘中？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93-1"><span class="nav-number">1.26.3.</span> <span class="nav-text">总结</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="xudukang"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">xudukang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">26</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/xdk-nj" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xdk-nj" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">xudukang</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">263k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">3:59</span>
</div>

<!--
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div> -->

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
